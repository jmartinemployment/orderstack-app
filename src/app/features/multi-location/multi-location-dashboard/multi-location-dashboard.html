<div class="multi-location">
  <header class="dashboard-header">
    <div class="header-title">
      <i class="bi bi-buildings"></i>
      <h1>Multi-Location Management</h1>
    </div>
    <div class="header-kpis">
      <div class="kpi-card">
        <span class="kpi-value">{{ restaurants().length }}</span>
        <span class="kpi-label">Locations</span>
      </div>
      <div class="kpi-card">
        <span class="kpi-value">{{ groups().length }}</span>
        <span class="kpi-label">Groups</span>
      </div>
      @if (crossLocationReport()) {
        <div class="kpi-card accent">
          <span class="kpi-value">{{ crossLocationReport()!.totals.totalRevenue | currency:'USD':'symbol':'1.0-0' }}</span>
          <span class="kpi-label">Total Revenue ({{ reportDays() }}d)</span>
        </div>
        <div class="kpi-card">
          <span class="kpi-value">{{ crossLocationReport()!.totals.totalOrders }}</span>
          <span class="kpi-label">Total Orders</span>
        </div>
      }
    </div>
  </header>

  @if (error()) {
    <div class="error-banner" (click)="dismissError()">
      <i class="bi bi-exclamation-triangle"></i>
      {{ error() }}
      <i class="bi bi-x"></i>
    </div>
  }

  @if (restaurants().length < 2) {
    <div class="single-location-notice">
      <i class="bi bi-info-circle"></i>
      <div>
        <p><strong>Single location detected.</strong></p>
        <p>Multi-location management requires 2+ restaurants in your account. Add additional locations from the admin dashboard to enable cross-location features.</p>
      </div>
    </div>
  }

  <nav class="tab-bar">
    <button class="tab-btn" [class.active]="activeTab() === 'overview'" (click)="setTab('overview')">
      <i class="bi bi-bar-chart"></i> Overview
    </button>
    <button class="tab-btn" [class.active]="activeTab() === 'groups'" (click)="setTab('groups')">
      <i class="bi bi-collection"></i> Groups
    </button>
    <button class="tab-btn" [class.active]="activeTab() === 'menu-sync'" (click)="setTab('menu-sync')">
      <i class="bi bi-arrow-repeat"></i> Menu Sync
    </button>
    <button class="tab-btn" [class.active]="activeTab() === 'settings'" (click)="setTab('settings')">
      <i class="bi bi-gear"></i> Settings
    </button>
  </nav>

  @if (isLoading()) {
    <div class="loading-msg">Loading data...</div>
  }

  <!-- ═══ OVERVIEW TAB ═══ -->
  @if (activeTab() === 'overview') {
    <div class="tab-content">
      <div class="section-header">
        <h3>Cross-Location Performance</h3>
        <div class="period-pills">
          <button class="pill" [class.active]="reportDays() === 7" (click)="changeReportDays(7)">7d</button>
          <button class="pill" [class.active]="reportDays() === 14" (click)="changeReportDays(14)">14d</button>
          <button class="pill" [class.active]="reportDays() === 30" (click)="changeReportDays(30)">30d</button>
          <button class="pill" [class.active]="reportDays() === 90" (click)="changeReportDays(90)">90d</button>
        </div>
      </div>

      @if (crossLocationReport()) {
        <!-- Totals strip -->
        <div class="totals-strip">
          <div class="total-card">
            <span class="total-label">Avg Order Value</span>
            <span class="total-value">{{ crossLocationReport()!.totals.avgOrderValue | currency }}</span>
          </div>
          <div class="total-card">
            <span class="total-label">Avg Labor Cost %</span>
            <span class="total-value" [class]="getKpiClass(crossLocationReport()!.totals.avgLaborCostPercent, 'cost')">
              {{ crossLocationReport()!.totals.avgLaborCostPercent | number:'1.1-1' }}%
            </span>
          </div>
          <div class="total-card">
            <span class="total-label">Avg Food Cost %</span>
            <span class="total-value" [class]="getKpiClass(crossLocationReport()!.totals.avgFoodCostPercent, 'cost')">
              {{ crossLocationReport()!.totals.avgFoodCostPercent | number:'1.1-1' }}%
            </span>
          </div>
        </div>

        <!-- Top/Bottom performers -->
        @if (topPerformer() && bottomPerformer()) {
          <div class="performer-cards">
            <div class="performer-card top">
              <span class="performer-label"><i class="bi bi-trophy"></i> Top Performer</span>
              <span class="performer-name">{{ topPerformer()!.restaurantName }}</span>
              <span class="performer-value">{{ topPerformer()!.revenue | currency:'USD':'symbol':'1.0-0' }}</span>
            </div>
            <div class="performer-card bottom">
              <span class="performer-label"><i class="bi bi-arrow-down-circle"></i> Needs Attention</span>
              <span class="performer-name">{{ bottomPerformer()!.restaurantName }}</span>
              <span class="performer-value">{{ bottomPerformer()!.revenue | currency:'USD':'symbol':'1.0-0' }}</span>
            </div>
          </div>
        }

        <!-- Location comparison table -->
        <div class="comparison-table-wrap">
          <table class="comparison-table">
            <thead>
              <tr>
                <th (click)="toggleSort('restaurantName')" class="sortable">
                  Location <i class="bi" [class]="getSortIcon('restaurantName')"></i>
                </th>
                <th (click)="toggleSort('revenue')" class="sortable">
                  Revenue <i class="bi" [class]="getSortIcon('revenue')"></i>
                </th>
                <th (click)="toggleSort('orderCount')" class="sortable">
                  Orders <i class="bi" [class]="getSortIcon('orderCount')"></i>
                </th>
                <th (click)="toggleSort('averageOrderValue')" class="sortable">
                  Avg Order <i class="bi" [class]="getSortIcon('averageOrderValue')"></i>
                </th>
                <th (click)="toggleSort('laborCostPercent')" class="sortable">
                  Labor % <i class="bi" [class]="getSortIcon('laborCostPercent')"></i>
                </th>
                <th (click)="toggleSort('foodCostPercent')" class="sortable">
                  Food Cost % <i class="bi" [class]="getSortIcon('foodCostPercent')"></i>
                </th>
                <th (click)="toggleSort('customerCount')" class="sortable">
                  Customers <i class="bi" [class]="getSortIcon('customerCount')"></i>
                </th>
              </tr>
            </thead>
            <tbody>
              @for (loc of sortedLocations(); track loc.restaurantId) {
                <tr [class.current]="loc.restaurantId === currentRestaurantId()">
                  <td class="loc-name">
                    {{ loc.restaurantName }}
                    @if (loc.restaurantId === currentRestaurantId()) {
                      <span class="current-badge">Current</span>
                    }
                  </td>
                  <td>{{ loc.revenue | currency:'USD':'symbol':'1.0-0' }}</td>
                  <td>{{ loc.orderCount }}</td>
                  <td>{{ loc.averageOrderValue | currency }}</td>
                  <td><span class="cost-badge" [class]="getKpiClass(loc.laborCostPercent, 'cost')">{{ loc.laborCostPercent | number:'1.1-1' }}%</span></td>
                  <td><span class="cost-badge" [class]="getKpiClass(loc.foodCostPercent, 'cost')">{{ loc.foodCostPercent | number:'1.1-1' }}%</span></td>
                  <td>{{ loc.customerCount }}</td>
                </tr>
              }
            </tbody>
          </table>
        </div>
      } @else if (!isLoading()) {
        <div class="empty-state">
          <i class="bi bi-bar-chart"></i>
          <p>No cross-location data available</p>
          <p class="empty-hint">Data will populate as locations generate sales</p>
        </div>
      }
    </div>
  }

  <!-- ═══ GROUPS TAB ═══ -->
  @if (activeTab() === 'groups') {
    <div class="tab-content">
      <div class="section-header">
        <h3>Location Groups</h3>
        <button class="btn-add" (click)="openGroupForm()">
          <i class="bi bi-plus-lg"></i> New Group
        </button>
      </div>

      <div class="group-list">
        @for (group of groups(); track group.id) {
          <div class="group-card" [class.expanded]="expandedGroupId() === group.id">
            <div class="group-card-header" (click)="toggleGroupExpand(group.id)">
              <div class="group-info">
                <span class="group-name">{{ group.name }}</span>
                @if (group.description) {
                  <span class="group-desc">{{ group.description }}</span>
                }
              </div>
              <div class="group-meta">
                <span class="member-count">{{ group.memberCount }} locations</span>
                <div class="group-actions">
                  <button class="btn-icon" (click)="openGroupForm(group); $event.stopPropagation()">
                    <i class="bi bi-pencil"></i>
                  </button>
                  <button class="btn-icon btn-icon-danger" (click)="deleteGroup(group); $event.stopPropagation()">
                    <i class="bi bi-trash3"></i>
                  </button>
                </div>
                <i class="bi chevron" [class.bi-chevron-down]="expandedGroupId() !== group.id" [class.bi-chevron-up]="expandedGroupId() === group.id"></i>
              </div>
            </div>

            @if (expandedGroupId() === group.id) {
              <div class="group-members">
                @for (member of getGroupMembers(group.id); track member.id) {
                  <div class="member-row">
                    <span class="member-name">{{ member.restaurantName }}</span>
                    <span class="member-slug">{{ member.restaurantSlug }}</span>
                    <button class="btn-icon btn-icon-danger" (click)="removeGroupMember(group.id, member.id)">
                      <i class="bi bi-x-lg"></i>
                    </button>
                  </div>
                } @empty {
                  <div class="empty-hint">No members in this group</div>
                }
              </div>
            }
          </div>
        } @empty {
          <div class="empty-state">
            <i class="bi bi-collection"></i>
            <p>No location groups yet</p>
            <p class="empty-hint">Create groups to organize locations by region, concept, or ownership</p>
          </div>
        }
      </div>
    </div>
  }

  <!-- ═══ MENU SYNC TAB ═══ -->
  @if (activeTab() === 'menu-sync') {
    <div class="tab-content">
      <div class="section-header">
        <h3>Menu Sync</h3>
      </div>

      <div class="sync-form">
        <div class="sync-step">
          <span class="step-number">1</span>
          <div class="step-content">
            <label>Source Location (copy FROM)</label>
            <select class="form-select" [value]="syncSourceId()" (change)="syncSourceId.set($any($event.target).value)">
              <option value="">Select source...</option>
              @for (r of restaurants(); track r.id) {
                <option [value]="r.id">{{ r.name }}</option>
              }
            </select>
          </div>
        </div>

        <div class="sync-step">
          <span class="step-number">2</span>
          <div class="step-content">
            <label>Target Locations (copy TO)</label>
            <div class="target-checkboxes">
              @for (r of getSyncTargetRestaurants(); track r.id) {
                <label class="checkbox-label" (click)="toggleSyncTarget(r.id)">
                  <span class="checkbox" [class.checked]="isSyncTarget(r.id)">
                    @if (isSyncTarget(r.id)) { <i class="bi bi-check"></i> }
                  </span>
                  {{ r.name }}
                </label>
              }
            </div>
          </div>
        </div>

        <div class="sync-actions">
          <button class="btn-preview" [disabled]="!canPreviewSync || isSyncing()" (click)="previewSync()">
            @if (isSyncing() && !syncPreview()) { Analyzing... } @else { <i class="bi bi-eye"></i> Preview Changes }
          </button>
        </div>
      </div>

      <!-- Sync preview -->
      @if (syncPreview()) {
        <div class="sync-preview">
          <h4>Sync Preview</h4>
          <div class="preview-summary">
            <span class="preview-stat add">{{ syncPreview()!.itemsToAdd.length }} to add</span>
            <span class="preview-stat update">{{ syncPreview()!.itemsToUpdate.length }} to update</span>
            <span class="preview-stat skip">{{ syncPreview()!.itemsToSkip.length }} to skip</span>
            @if (syncPreview()!.conflicts.length > 0) {
              <span class="preview-stat conflict">{{ syncPreview()!.conflicts.length }} conflicts</span>
            }
          </div>

          @if (syncPreview()!.itemsToAdd.length > 0) {
            <div class="preview-section">
              <h5>Items to Add</h5>
              @for (item of syncPreview()!.itemsToAdd; track $index) {
                <div class="preview-item add">
                  <span>{{ item.name }}</span>
                  <span class="preview-cat">{{ item.category }}</span>
                  <span>{{ item.price | currency }}</span>
                </div>
              }
            </div>
          }

          @if (syncPreview()!.itemsToUpdate.length > 0) {
            <div class="preview-section">
              <h5>Items to Update</h5>
              @for (item of syncPreview()!.itemsToUpdate; track $index) {
                <div class="preview-item update">
                  <span>{{ item.name }}</span>
                  <span class="preview-cat">{{ item.category }}</span>
                  <span>{{ item.oldPrice | currency }} → {{ item.newPrice | currency }}</span>
                </div>
              }
            </div>
          }

          @if (syncPreview()!.conflicts.length > 0) {
            <div class="preview-section">
              <h5>Conflicts</h5>
              @for (c of syncPreview()!.conflicts; track $index) {
                <div class="preview-item conflict">
                  <span>{{ c.name }}</span>
                  <span class="conflict-issue">{{ c.issue }}</span>
                </div>
              }
            </div>
          }

          <div class="preview-actions">
            <button class="btn-cancel" (click)="cancelSync()">Cancel</button>
            <button class="btn-sync" [disabled]="isSyncing()" (click)="executeSync()">
              @if (isSyncing()) { Syncing... } @else { <i class="bi bi-arrow-repeat"></i> Confirm Sync }
            </button>
          </div>
        </div>
      }

      <!-- Sync history -->
      @if (syncHistory().length > 0) {
        <div class="sync-history">
          <h4>Sync History</h4>
          @for (sync of syncHistory(); track sync.id) {
            <div class="history-card">
              <div class="history-header">
                <span class="history-date">{{ sync.syncedAt | date:'medium' }}</span>
                <span class="history-by">by {{ sync.syncedBy }}</span>
              </div>
              <div class="history-stats">
                <span class="stat add">+{{ sync.itemsAdded }} added</span>
                <span class="stat update">{{ sync.itemsUpdated }} updated</span>
                <span class="stat skip">{{ sync.itemsSkipped }} skipped</span>
                @if (sync.conflicts > 0) {
                  <span class="stat conflict">{{ sync.conflicts }} conflicts</span>
                }
              </div>
              <div class="history-targets">
                → {{ sync.targetRestaurantIds.length }} locations
              </div>
            </div>
          }
        </div>
      }
    </div>
  }

  <!-- ═══ SETTINGS TAB ═══ -->
  @if (activeTab() === 'settings') {
    <div class="tab-content">
      <div class="section-header">
        <h3>Settings Propagation</h3>
      </div>

      <p class="settings-desc">Push settings from one location to others. Items marked with local overrides will not be changed.</p>

      <div class="propagate-form">
        <div class="form-group">
          <label>Setting Type</label>
          <select class="form-select" [value]="propagateType()" (change)="propagateType.set($any($event.target).value)">
            <option value="">Select type...</option>
            <option value="ai">AI Settings</option>
            <option value="pricing">Pricing Rules</option>
            <option value="loyalty">Loyalty Config</option>
            <option value="delivery">Delivery Settings</option>
            <option value="payment">Payment Settings</option>
          </select>
        </div>

        <div class="form-group">
          <label>Source Location</label>
          <select class="form-select" [value]="propagateSourceId()" (change)="propagateSourceId.set($any($event.target).value)">
            <option value="">Select source...</option>
            @for (r of restaurants(); track r.id) {
              <option [value]="r.id">{{ r.name }}</option>
            }
          </select>
        </div>

        <div class="form-group">
          <label>Target Locations</label>
          <div class="target-checkboxes">
            @for (r of getPropagateTargetRestaurants(); track r.id) {
              <label class="checkbox-label" (click)="togglePropagateTarget(r.id)">
                <span class="checkbox" [class.checked]="isPropagateTarget(r.id)">
                  @if (isPropagateTarget(r.id)) { <i class="bi bi-check"></i> }
                </span>
                {{ r.name }}
              </label>
            }
          </div>
        </div>

        <label class="checkbox-label override-toggle" (click)="propagateOverride.set(!propagateOverride())">
          <span class="checkbox" [class.checked]="propagateOverride()">
            @if (propagateOverride()) { <i class="bi bi-check"></i> }
          </span>
          Override existing local settings
        </label>

        <button class="btn-propagate" [disabled]="!canPropagate || isPropagating()" (click)="propagateSettings()">
          @if (isPropagating()) {
            Propagating...
          } @else {
            <i class="bi bi-send"></i> Propagate Settings
          }
        </button>
      </div>
    </div>
  }

  <!-- ═══ GROUP FORM MODAL ═══ -->
  @if (showGroupForm()) {
    <div class="modal-overlay" (click)="closeGroupForm()">
      <div class="modal-content" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h3>{{ editingGroup() ? 'Edit' : 'Create' }} Location Group</h3>
          <button class="btn-close-modal" (click)="closeGroupForm()"><i class="bi bi-x-lg"></i></button>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label>Group Name *</label>
            <input type="text" class="form-input" [value]="groupName()" (input)="groupName.set($any($event.target).value)" placeholder="e.g., South Florida, Fast Casual Concept">
          </div>
          <div class="form-group">
            <label>Description</label>
            <textarea class="form-input" rows="2" [value]="groupDescription()" (input)="groupDescription.set($any($event.target).value)"></textarea>
          </div>
          <div class="form-group">
            <label>Member Locations</label>
            <div class="target-checkboxes">
              @for (r of restaurants(); track r.id) {
                <label class="checkbox-label" (click)="toggleMemberId(r.id)">
                  <span class="checkbox" [class.checked]="isMemberSelected(r.id)">
                    @if (isMemberSelected(r.id)) { <i class="bi bi-check"></i> }
                  </span>
                  {{ r.name }}
                </label>
              }
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn-cancel" (click)="closeGroupForm()">Cancel</button>
          <button class="btn-save" [disabled]="!groupName() || isSavingGroup()" (click)="saveGroup()">
            @if (isSavingGroup()) { Saving... } @else { Save }
          </button>
        </div>
      </div>
    </div>
  }
</div>
