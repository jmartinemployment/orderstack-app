<!-- Header -->
<header class="checkout-header">
  <div class="checkout-header-inner">
    <button class="back-link" (click)="goBackToStore()">
      <i class="bi bi-arrow-left"></i>
      {{ storeConfig()?.storeName ?? 'Store' }}
    </button>
    <span class="checkout-title">Checkout</span>
    <span class="spacer"></span>
  </div>
</header>

@if (orderSuccess()) {
  <!-- Confirmation -->
  <div class="confirmation-screen">
    <div class="confirmation-card">
      <div class="confirmation-icon">
        <i class="bi bi-check-circle-fill"></i>
      </div>
      <h2>Order Confirmed!</h2>
      <p>Thank you for your order. You'll receive a confirmation email shortly.</p>
      <button class="primary-btn" (click)="goBackToStore()">
        Continue Shopping
      </button>
    </div>
  </div>
} @else {
  <main class="checkout-main">
    <div class="checkout-grid">
      <!-- Left: Steps -->
      <div class="checkout-steps">
        <!-- Step Indicators -->
        <div class="step-indicators">
          <button class="step-indicator" [class.active]="step() === 'cart'" [class.completed]="step() !== 'cart'" (click)="goToStep('cart')">
            <span class="step-number">1</span>
            Cart
          </button>
          <div class="step-line"></div>
          <button class="step-indicator" [class.active]="step() === 'shipping'" [class.completed]="step() === 'payment'" [disabled]="!canProceedToShipping()" (click)="goToStep('shipping')">
            <span class="step-number">2</span>
            Shipping
          </button>
          <div class="step-line"></div>
          <button class="step-indicator" [class.active]="step() === 'payment'" [disabled]="!canProceedToPayment()" (click)="goToStep('payment')">
            <span class="step-number">3</span>
            Payment
          </button>
        </div>

        <!-- Cart Step -->
        @if (step() === 'cart') {
          <div class="step-content">
            <h2>Your Cart</h2>
            @if (cart().length === 0) {
              <div class="empty-cart">
                <i class="bi bi-bag"></i>
                <p>Your cart is empty</p>
                <button class="secondary-btn" (click)="goBackToStore()">Browse Products</button>
              </div>
            } @else {
              <div class="cart-items">
                @for (item of cart(); track $index; let i = $index) {
                  <div class="cart-row">
                    @if (item.imageUrl) {
                      <img [src]="item.imageUrl" [alt]="item.name" class="cart-row-image" />
                    } @else {
                      <div class="cart-row-image placeholder"><i class="bi bi-image"></i></div>
                    }
                    <div class="cart-row-info">
                      <div class="cart-row-name">{{ item.name }}</div>
                      @if (item.variationName) {
                        <div class="cart-row-variant">{{ item.variationName }}</div>
                      }
                      <div class="cart-row-sku">SKU: {{ item.sku }}</div>
                    </div>
                    <div class="cart-row-qty">
                      <div class="qty-stepper">
                        <button (click)="updateCartQuantity(i, item.quantity - 1)">-</button>
                        <span>{{ item.quantity }}</span>
                        <button (click)="updateCartQuantity(i, item.quantity + 1)">+</button>
                      </div>
                    </div>
                    <div class="cart-row-total">{{ item.unitPrice * item.quantity | currency }}</div>
                    <button class="cart-row-remove" (click)="removeItem(i)">
                      <i class="bi bi-x"></i>
                    </button>
                  </div>
                }
              </div>
              <div class="step-actions">
                <button class="secondary-btn" (click)="goBackToStore()">Continue Shopping</button>
                <button class="primary-btn" (click)="goToStep('shipping')">Continue to Shipping</button>
              </div>
            }
          </div>
        }

        <!-- Shipping Step -->
        @if (step() === 'shipping') {
          <div class="step-content">
            <h2>Shipping Information</h2>

            <!-- Contact -->
            <div class="form-section">
              <h3>Contact</h3>
              <div class="form-row">
                <div class="form-group">
                  <label>Full Name</label>
                  <input type="text" [ngModel]="customerName()" (ngModelChange)="customerName.set($event)" placeholder="John Doe" />
                </div>
                <div class="form-group">
                  <label>Email</label>
                  <input type="email" [ngModel]="customerEmail()" (ngModelChange)="customerEmail.set($event)" placeholder="john@example.com" />
                </div>
              </div>
            </div>

            <!-- Fulfillment Type -->
            <div class="form-section">
              <h3>Fulfillment</h3>
              <div class="fulfillment-options">
                @if (storeConfig()?.enableShipping) {
                  <button class="fulfillment-btn" [class.selected]="fulfillmentType() === 'ship'" (click)="setFulfillmentType('ship')">
                    <i class="bi bi-truck"></i> Ship to Address
                  </button>
                }
                @if (storeConfig()?.enablePickup) {
                  <button class="fulfillment-btn" [class.selected]="fulfillmentType() === 'pickup'" (click)="setFulfillmentType('pickup')">
                    <i class="bi bi-shop"></i> In-Store Pickup
                  </button>
                }
                @if (storeConfig()?.enableCurbside) {
                  <button class="fulfillment-btn" [class.selected]="fulfillmentType() === 'curbside'" (click)="setFulfillmentType('curbside')">
                    <i class="bi bi-car-front"></i> Curbside Pickup
                  </button>
                }
                @if (storeConfig()?.enableLocalDelivery) {
                  <button class="fulfillment-btn" [class.selected]="fulfillmentType() === 'local_delivery'" (click)="setFulfillmentType('local_delivery')">
                    <i class="bi bi-bicycle"></i> Local Delivery
                  </button>
                }
              </div>
            </div>

            <!-- Shipping Address (only for 'ship' or 'local_delivery') -->
            @if (fulfillmentType() === 'ship' || fulfillmentType() === 'local_delivery') {
              <div class="form-section">
                <h3>{{ fulfillmentType() === 'ship' ? 'Shipping Address' : 'Delivery Address' }}</h3>
                <div class="form-group">
                  <label>Name</label>
                  <input type="text" [ngModel]="shippingAddress().fullName" (ngModelChange)="updateAddress('fullName', $event)" />
                </div>
                <div class="form-group">
                  <label>Address</label>
                  <input type="text" [ngModel]="shippingAddress().line1" (ngModelChange)="updateAddress('line1', $event)" placeholder="Street address" />
                </div>
                <div class="form-group">
                  <label>Apartment, suite, etc. (optional)</label>
                  <input type="text" [ngModel]="shippingAddress().line2 ?? ''" (ngModelChange)="updateAddress('line2', $event)" />
                </div>
                <div class="form-row form-row-3">
                  <div class="form-group">
                    <label>City</label>
                    <input type="text" [ngModel]="shippingAddress().city" (ngModelChange)="updateAddress('city', $event)" />
                  </div>
                  <div class="form-group">
                    <label>State</label>
                    <input type="text" [ngModel]="shippingAddress().state" (ngModelChange)="updateAddress('state', $event)" />
                  </div>
                  <div class="form-group">
                    <label>ZIP Code</label>
                    <input type="text" [ngModel]="shippingAddress().postalCode" (ngModelChange)="updateAddress('postalCode', $event)" />
                  </div>
                </div>
                <div class="form-group">
                  <label>Phone</label>
                  <input type="tel" [ngModel]="shippingAddress().phone" (ngModelChange)="updateAddress('phone', $event)" />
                </div>
              </div>
            }

            <!-- Pickup Instructions -->
            @if (fulfillmentType() === 'pickup' || fulfillmentType() === 'curbside') {
              @if (storeConfig()?.pickupInstructions) {
                <div class="pickup-info">
                  <i class="bi bi-info-circle"></i>
                  <p>{{ storeConfig()!.pickupInstructions }}</p>
                </div>
              }
            }

            <!-- Shipping Method (only for 'ship') -->
            @if (fulfillmentType() === 'ship' && shippingMethods().length > 0) {
              <div class="form-section">
                <h3>Shipping Method</h3>
                <div class="shipping-methods">
                  @for (method of shippingMethods(); track method.id) {
                    <button
                      class="shipping-method-btn"
                      [class.selected]="selectedShippingMethodId() === method.id"
                      (click)="selectShippingMethod(method.id)"
                    >
                      <div class="method-info">
                        <span class="method-name">{{ method.name }}</span>
                        @if (method.estimatedDays) {
                          <span class="method-days">{{ method.estimatedDays }} business days</span>
                        }
                      </div>
                      <span class="method-price">
                        @if (method.freeAbove && cartSubtotal() >= method.freeAbove) {
                          Free
                        } @else {
                          {{ method.rate | currency }}
                        }
                      </span>
                    </button>
                  }
                </div>
              </div>
            }

            <div class="step-actions">
              <button class="secondary-btn" (click)="goToStep('cart')">Back to Cart</button>
              <button class="primary-btn" [disabled]="!canProceedToPayment()" (click)="goToStep('payment')">Continue to Payment</button>
            </div>
          </div>
        }

        <!-- Payment Step -->
        @if (step() === 'payment') {
          <div class="step-content">
            <h2>Payment</h2>

            <div class="form-section">
              <h3>Payment Method</h3>
              <div class="payment-placeholder">
                <i class="bi bi-credit-card"></i>
                <p>Payment processing via Stripe (integration pending)</p>
                <p class="payment-note">Card details will be securely collected here.</p>
              </div>
            </div>

            @if (orderError()) {
              <div class="error-banner">
                <i class="bi bi-exclamation-triangle"></i>
                {{ orderError() }}
              </div>
            }

            <div class="step-actions">
              <button class="secondary-btn" (click)="goToStep('shipping')">Back</button>
              <button class="primary-btn" [disabled]="isProcessing()" (click)="submitOrder()">
                @if (isProcessing()) {
                  Processing...
                } @else {
                  Place Order â€” {{ orderTotal() | currency }}
                }
              </button>
            </div>
          </div>
        }
      </div>

      <!-- Right: Order Summary -->
      <aside class="order-summary">
        <h3>Order Summary</h3>
        <div class="summary-items">
          @for (item of cart(); track $index) {
            <div class="summary-item">
              <div class="summary-item-info">
                <span class="summary-item-name">{{ item.name }}</span>
                @if (item.variationName) {
                  <span class="summary-item-variant">{{ item.variationName }}</span>
                }
                <span class="summary-item-qty">Qty: {{ item.quantity }}</span>
              </div>
              <span class="summary-item-total">{{ item.unitPrice * item.quantity | currency }}</span>
            </div>
          }
        </div>
        <div class="summary-line">
          <span>Subtotal</span>
          <span>{{ cartSubtotal() | currency }}</span>
        </div>
        <div class="summary-line">
          <span>Shipping</span>
          <span>
            @if (shippingCost() === 0 && fulfillmentType() !== 'ship') {
              Free
            } @else if (shippingCost() === 0 && fulfillmentType() === 'ship') {
              {{ selectedShippingMethod() ? 'Free' : '--' }}
            } @else {
              {{ shippingCost() | currency }}
            }
          </span>
        </div>
        <div class="summary-line">
          <span>Tax</span>
          <span>{{ taxAmount() | currency }}</span>
        </div>
        <div class="summary-total">
          <span>Total</span>
          <span>{{ orderTotal() | currency }}</span>
        </div>
      </aside>
    </div>
  </main>
}
