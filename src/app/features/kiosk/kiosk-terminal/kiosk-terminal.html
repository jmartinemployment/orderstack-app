<div class="kiosk-terminal">
  <!-- ==================== LEFT: Item Grid Area ==================== -->
  <main class="kiosk-main">

    <!-- Top Tabs -->
    <os-top-navigation
      [tabs]="topTabs"
      [activeTab]="activeTopTab()"
      (tabChange)="selectTopTab($event)"
      (moreClick)="onMoreClick()" />

    <!-- Category pills (only visible on Menu tab) -->
    @if (activeTopTab() === 'menu') {
      <div class="category-pills">
        @for (cat of categories(); track cat.id) {
          <button
            type="button"
            class="category-pill"
            [class.active]="selectedCategoryId() === cat.id"
            (click)="selectCategory(cat.id)">
            {{ cat.name }}
          </button>
        }
      </div>
    }

    <!-- Keypad View -->
    @if (activeTopTab() === 'keypad') {
      <div class="keypad-view">
        <div class="keypad-display">
          <span class="keypad-dollar">$</span>
          <span class="keypad-amount">{{ keypadValue() || '0' }}</span>
        </div>
        <div class="keypad-grid">
          @for (key of ['1','2','3','4','5','6','7','8','9','00','0','.']; track key) {
            <button
              type="button"
              class="keypad-key"
              (click)="onKeypadPress(key)">
              {{ key }}
            </button>
          }
        </div>
        <div class="keypad-actions">
          <button type="button" class="keypad-clear" (click)="onKeypadPress('clear')">Clear</button>
          <button type="button" class="keypad-backspace" (click)="onKeypadPress('backspace')">
            <i class="bi bi-backspace"></i>
          </button>
        </div>
      </div>
    }

    <!-- Item Grid -->
    @if (activeTopTab() !== 'keypad') {
      <div class="item-grid-container">
        @if (isLoading()) {
          <div class="grid-loading">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Loading menu...</span>
            </div>
          </div>
        } @else {
          <div class="item-grid">
            @for (item of gridItems(); track item.id) {
              <button type="button" class="item-tile" (click)="checkout.addItem(item)">
                @if (getItemImage(item); as imgUrl) {
                  <div class="item-image">
                    <img [src]="imgUrl" [alt]="item.name" loading="lazy" (error)="onImageError($event)" />
                    <i class="bi bi-bag item-image-fallback"></i>
                  </div>
                } @else {
                  <div class="item-image item-image-placeholder">
                    <i class="bi bi-bag"></i>
                  </div>
                }
                <span class="item-name">{{ item.name }}</span>
                @if (item.soldByWeight) {
                  <span class="item-weight-badge">
                    <i class="bi bi-speedometer2"></i> by weight
                  </span>
                }
              </button>
            }

            <!-- Empty placeholder tiles to fill the row -->
            @for (i of [1,2,3,4,5]; track i) {
              @if (gridItems().length % 5 !== 0 && i <= 5 - (gridItems().length % 5)) {
                <div class="item-tile item-tile-empty"></div>
              }
            }
          </div>

          <!-- Action tiles row -->
          <div class="action-tiles">
            <button type="button" class="action-tile">
              <div class="action-icon">
                <i class="bi bi-percent"></i>
              </div>
              <span class="action-label">Discounts</span>
            </button>
            <button type="button" class="action-tile">
              <div class="action-icon">
                <i class="bi bi-star-fill"></i>
              </div>
              <span class="action-label">Rewards</span>
            </button>
            <button type="button" class="action-tile">
              <div class="action-icon">
                <i class="bi bi-gift-fill"></i>
              </div>
              <span class="action-label">Gift cards</span>
            </button>
            <div class="action-tile action-tile-empty"></div>
            <div class="action-tile action-tile-empty"></div>
          </div>
        }
      </div>
    }

  </main>

  <!-- ==================== RIGHT: Current Sale Panel ==================== -->
  <aside class="sale-panel">
    <div class="sale-header">
      <h2>Current sale{{ checkout.cartCount() > 0 ? ' (' + checkout.cartCount() + ')' : '' }}</h2>
      <button type="button" class="sale-more-btn" aria-label="Sale options">
        <i class="bi bi-three-dots"></i>
      </button>
    </div>

    <!-- Customer row (placeholder) -->
    <button type="button" class="customer-row">
      <div class="customer-avatar">
        <i class="bi bi-person-fill"></i>
      </div>
      <span class="customer-name">Add customer</span>
      <i class="bi bi-chevron-right customer-chevron"></i>
    </button>

    <!-- Line items -->
    <div class="sale-items">
      @if (checkout.cartItems().length === 0) {
        <div class="sale-empty">
          <p>No items yet</p>
        </div>
      } @else {
        @for (item of checkout.cartItems(); track item.id) {
          <div class="sale-line-item">
            <div class="line-item-info">
              <button type="button" class="line-item-name" (click)="checkout.removeItem(item.id)">
                @if (item.weightUnit) {
                  <span class="line-item-qty">{{ item.quantity }} {{ weightUnitLabels[item.weightUnit] }}</span>
                } @else if (item.quantity > 1) {
                  <span class="line-item-qty">{{ item.quantity }}x</span>
                }
                {{ item.menuItem.name }}
              </button>
              @if (item.weightUnit) {
                <span class="line-item-modifier">@ {{ item.unitPrice | currency:'USD':'symbol':'1.2-2' }}/{{ weightUnitLabels[item.weightUnit] }}</span>
              }
              @if (item.modifierSummary) {
                <span class="line-item-modifier">{{ item.modifierSummary }}</span>
              }
            </div>
            <span class="line-item-price">{{ item.totalPrice | currency:'USD':'symbol':'1.2-2' }}</span>
          </div>
        }
      }
    </div>

    <!-- Totals + actions -->
    <div class="sale-footer">
      @if (checkout.cartItems().length > 0) {
        <div class="sale-totals">
          <div class="total-row">
            <span>Tax</span>
            <span>{{ checkout.tax() | currency:'USD':'symbol':'1.2-2' }}</span>
          </div>
          <div class="total-divider"></div>
          <button type="button" class="add-discount-btn">Add discount</button>
        </div>
      }

      <button
        type="button"
        class="charge-btn"
        [disabled]="checkout.cartItems().length === 0"
        (click)="checkout.startCheckout('charge', 'kiosk')">
        @if (checkout.cartItems().length > 0) {
          Charge {{ checkout.total() | currency:'USD':'symbol':'1.2-2' }}
        } @else {
          Charge
        }
      </button>
    </div>
  </aside>
</div>

<!-- ==================== WEIGHT SCALE OVERLAY ==================== -->
@if (checkout.showWeightScale()) {
  <div class="checkout-overlay">
    <div class="checkout-modal">
      <os-weight-scale
        [itemName]="checkout.weightScaleItem()!.name"
        [unitPrice]="checkout.weightScaleUnitPrice()"
        [weightUnit]="checkout.weightScaleUnit()"
        (weightConfirmed)="checkout.onWeightConfirmed($event)"
        (cancelled)="checkout.closeWeightScale()" />
    </div>
  </div>
}

<!-- ==================== CHECKOUT OVERLAY ==================== -->
<os-checkout [mode]="'charge'" [orderSource]="'kiosk'" />
