<div class="kiosk-terminal">
  <!-- ==================== LEFT: Item Grid Area ==================== -->
  <main class="kiosk-main">

    <!-- Top Tabs -->
    <nav class="top-tabs">
      <button
        type="button"
        class="top-tab"
        [class.active]="activeTopTab() === 'keypad'"
        (click)="selectTopTab('keypad')">
        Keypad
      </button>
      <button
        type="button"
        class="top-tab"
        [class.active]="activeTopTab() === 'library'"
        (click)="selectTopTab('library')">
        Library
      </button>
      <button
        type="button"
        class="top-tab"
        [class.active]="activeTopTab() === 'favorites'"
        (click)="selectTopTab('favorites')">
        Favorites
      </button>
      <button
        type="button"
        class="top-tab"
        [class.active]="activeTopTab() === 'menu'"
        (click)="selectTopTab('menu')">
        Menu
      </button>
      <button type="button" class="top-tab-more" aria-label="More options">
        <i class="bi bi-three-dots"></i>
      </button>
    </nav>

    <!-- Category pills (only visible on Menu tab) -->
    @if (activeTopTab() === 'menu') {
      <div class="category-pills">
        @for (cat of categories(); track cat.id) {
          <button
            type="button"
            class="category-pill"
            [class.active]="selectedCategoryId() === cat.id"
            (click)="selectCategory(cat.id)">
            {{ cat.name }}
          </button>
        }
      </div>
    }

    <!-- Keypad View -->
    @if (activeTopTab() === 'keypad') {
      <div class="keypad-view">
        <div class="keypad-display">
          <span class="keypad-dollar">$</span>
          <span class="keypad-amount">{{ keypadValue() || '0' }}</span>
        </div>
        <div class="keypad-grid">
          @for (key of ['1','2','3','4','5','6','7','8','9','00','0','.']; track key) {
            <button
              type="button"
              class="keypad-key"
              (click)="onKeypadPress(key)">
              {{ key }}
            </button>
          }
        </div>
        <div class="keypad-actions">
          <button type="button" class="keypad-clear" (click)="onKeypadPress('clear')">Clear</button>
          <button type="button" class="keypad-backspace" (click)="onKeypadPress('backspace')">
            <i class="bi bi-backspace"></i>
          </button>
        </div>
      </div>
    }

    <!-- Item Grid -->
    @if (activeTopTab() !== 'keypad') {
      <div class="item-grid-container">
        @if (isLoading()) {
          <div class="grid-loading">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Loading menu...</span>
            </div>
          </div>
        } @else {
          <div class="item-grid">
            @for (item of gridItems(); track item.id) {
              <button type="button" class="item-tile" (click)="addItem(item)">
                @if (getItemImage(item); as imgUrl) {
                  <div class="item-image">
                    <img [src]="imgUrl" [alt]="item.name" loading="lazy" (error)="onImageError($event)" />
                    <i class="bi bi-bag item-image-fallback"></i>
                  </div>
                } @else {
                  <div class="item-image item-image-placeholder">
                    <i class="bi bi-bag"></i>
                  </div>
                }
                <span class="item-name">{{ item.name }}</span>
                @if (item.soldByWeight) {
                  <span class="item-weight-badge">
                    <i class="bi bi-speedometer2"></i> by weight
                  </span>
                }
              </button>
            }

            <!-- Empty placeholder tiles to fill the row -->
            @for (i of [1,2,3,4,5]; track i) {
              @if (gridItems().length % 5 !== 0 && i <= 5 - (gridItems().length % 5)) {
                <div class="item-tile item-tile-empty"></div>
              }
            }
          </div>

          <!-- Action tiles row -->
          <div class="action-tiles">
            <button type="button" class="action-tile">
              <div class="action-icon">
                <i class="bi bi-percent"></i>
              </div>
              <span class="action-label">Discounts</span>
            </button>
            <button type="button" class="action-tile">
              <div class="action-icon">
                <i class="bi bi-star-fill"></i>
              </div>
              <span class="action-label">Rewards</span>
            </button>
            <button type="button" class="action-tile">
              <div class="action-icon">
                <i class="bi bi-gift-fill"></i>
              </div>
              <span class="action-label">Gift cards</span>
            </button>
            <div class="action-tile action-tile-empty"></div>
            <div class="action-tile action-tile-empty"></div>
          </div>
        }
      </div>
    }

    <!-- Bottom Navigation -->
    <nav class="bottom-nav">
      <button
        type="button"
        class="bottom-nav-item"
        [class.active]="activeBottomTab() === 'checkout'"
        (click)="selectBottomTab('checkout')">
        <i class="bi bi-grid-3x3-gap-fill"></i>
        <span>Checkout</span>
      </button>
      <button
        type="button"
        class="bottom-nav-item"
        [class.active]="activeBottomTab() === 'transactions'"
        (click)="selectBottomTab('transactions')">
        <i class="bi bi-arrow-left-right"></i>
        <span>Transactions</span>
      </button>
      <button
        type="button"
        class="bottom-nav-item"
        [class.active]="activeBottomTab() === 'notifications'"
        (click)="selectBottomTab('notifications')">
        <i class="bi bi-bell"></i>
        <span>Notifications</span>
      </button>
      <button
        type="button"
        class="bottom-nav-item"
        [class.active]="activeBottomTab() === 'more'"
        (click)="selectBottomTab('more')">
        <i class="bi bi-list"></i>
        <span>More</span>
      </button>
    </nav>
  </main>

  <!-- ==================== RIGHT: Current Sale Panel ==================== -->
  <aside class="sale-panel">
    <div class="sale-header">
      <h2>Current sale{{ cartCount() > 0 ? ' (' + cartCount() + ')' : '' }}</h2>
      <button type="button" class="sale-more-btn" aria-label="Sale options">
        <i class="bi bi-three-dots"></i>
      </button>
    </div>

    <!-- Customer row (placeholder) -->
    <button type="button" class="customer-row">
      <div class="customer-avatar">
        <i class="bi bi-person-fill"></i>
      </div>
      <span class="customer-name">Add customer</span>
      <i class="bi bi-chevron-right customer-chevron"></i>
    </button>

    <!-- Line items -->
    <div class="sale-items">
      @if (cartItems().length === 0) {
        <div class="sale-empty">
          <p>No items yet</p>
        </div>
      } @else {
        @for (item of cartItems(); track item.id) {
          <div class="sale-line-item">
            <div class="line-item-info">
              <button type="button" class="line-item-name" (click)="removeItem(item.id)">
                @if (item.weightUnit) {
                  <span class="line-item-qty">{{ item.quantity }} {{ weightUnitLabels[item.weightUnit] }}</span>
                } @else if (item.quantity > 1) {
                  <span class="line-item-qty">{{ item.quantity }}x</span>
                }
                {{ item.menuItem.name }}
              </button>
              @if (item.weightUnit) {
                <span class="line-item-modifier">@ {{ item.unitPrice | currency:'USD':'symbol':'1.2-2' }}/{{ weightUnitLabels[item.weightUnit] }}</span>
              }
              @if (item.modifierSummary) {
                <span class="line-item-modifier">{{ item.modifierSummary }}</span>
              }
            </div>
            <span class="line-item-price">{{ item.totalPrice | currency:'USD':'symbol':'1.2-2' }}</span>
          </div>
        }
      }
    </div>

    <!-- Totals + actions -->
    <div class="sale-footer">
      @if (cartItems().length > 0) {
        <div class="sale-totals">
          <div class="total-row">
            <span>Tax</span>
            <span>{{ tax() | currency:'USD':'symbol':'1.2-2' }}</span>
          </div>
          <div class="total-divider"></div>
          <button type="button" class="add-discount-btn">Add discount</button>
        </div>
      }

      <button
        type="button"
        class="charge-btn"
        [disabled]="cartItems().length === 0"
        (click)="charge()">
        @if (cartItems().length > 0) {
          Charge {{ total() | currency:'USD':'symbol':'1.2-2' }}
        } @else {
          Charge
        }
      </button>
    </div>
  </aside>
</div>

<!-- ==================== WEIGHT SCALE OVERLAY ==================== -->
@if (showWeightScale()) {
  <div class="checkout-overlay">
    <div class="checkout-modal">
      <os-weight-scale
        [itemName]="weightScaleItem()!.name"
        [unitPrice]="weightScaleUnitPrice()"
        [weightUnit]="weightScaleUnit()"
        (weightConfirmed)="onWeightConfirmed($event)"
        (cancelled)="closeWeightScale()" />
    </div>
  </div>
}

<!-- ==================== CHECKOUT OVERLAY ==================== -->
@if (checkoutStep() !== 'idle') {
  <div class="checkout-overlay">
    <div class="checkout-modal">

      <!-- Step 1: Dining Option -->
      @if (checkoutStep() === 'dining-option') {
        <div class="checkout-step">
          <h2 class="checkout-title">How are you dining?</h2>
          <p class="checkout-subtitle">Select your dining preference</p>
          <div class="dining-options">
            <button
              type="button"
              class="dining-option-card"
              (click)="selectDiningOption('dine_in')">
              <div class="dining-option-icon">
                <i class="bi bi-cup-hot-fill"></i>
              </div>
              <span class="dining-option-label">Dine In</span>
              <span class="dining-option-desc">Eat here at the restaurant</span>
            </button>
            <button
              type="button"
              class="dining-option-card"
              (click)="selectDiningOption('takeout')">
              <div class="dining-option-icon">
                <i class="bi bi-bag-fill"></i>
              </div>
              <span class="dining-option-label">Takeout</span>
              <span class="dining-option-desc">Take your order to go</span>
            </button>
          </div>
          <button type="button" class="checkout-cancel-btn" (click)="cancelCheckout()">Cancel</button>
        </div>
      }

      <!-- Step 2: Table Selection (Dine In only) -->
      @if (checkoutStep() === 'table-select') {
        <div class="checkout-step">
          <h2 class="checkout-title">Select your table</h2>
          <p class="checkout-subtitle">Choose where you're seated</p>

          @if (tablesLoading()) {
            <div class="table-loading">
              <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading tables...</span>
              </div>
            </div>
          } @else {
            <div class="table-grid">
              @for (table of availableTables(); track table.id) {
                <button
                  type="button"
                  class="table-card"
                  (click)="selectTable(table)">
                  <span class="table-number">{{ table.tableNumber }}</span>
                  <span class="table-name">{{ table.tableName ?? 'Table ' + table.tableNumber }}</span>
                  <span class="table-capacity">
                    <i class="bi bi-people-fill"></i> {{ table.capacity }}
                  </span>
                </button>
              }
            </div>

            @if (availableTables().length === 0) {
              <p class="no-tables-msg">No tables available right now</p>
            }
          }

          <div class="checkout-step-actions">
            <button type="button" class="checkout-skip-btn" (click)="skipTableSelection()">
              Skip — server will seat me
            </button>
            <button type="button" class="checkout-cancel-btn" (click)="cancelCheckout()">Cancel</button>
          </div>
        </div>
      }

      <!-- Step 3: Customer Info (optional) -->
      @if (checkoutStep() === 'customer-info') {
        <div class="checkout-step">
          <h2 class="checkout-title">Get notified when it's ready</h2>
          <p class="checkout-subtitle">We'll text or email you when your order is ready for pickup. All fields are optional.</p>

          <div class="customer-info-form">
            <div class="form-field">
              <label class="form-label" for="kioskCustomerName">Name</label>
              <input
                type="text"
                class="form-control"
                id="kioskCustomerName"
                placeholder="Your name"
                [ngModel]="customerName()"
                (ngModelChange)="onCustomerNameChange($event)"
                autocomplete="name">
            </div>
            <div class="form-field">
              <label class="form-label" for="kioskCustomerPhone">Phone</label>
              <input
                type="tel"
                class="form-control"
                id="kioskCustomerPhone"
                placeholder="(555) 123-4567"
                [ngModel]="customerPhone()"
                (ngModelChange)="onCustomerPhoneChange($event)"
                autocomplete="tel">
            </div>
            <div class="form-field">
              <label class="form-label" for="kioskCustomerEmail">Email</label>
              <input
                type="email"
                class="form-control"
                id="kioskCustomerEmail"
                placeholder="you@example.com"
                [ngModel]="customerEmail()"
                (ngModelChange)="onCustomerEmailChange($event)"
                autocomplete="email">
            </div>
          </div>

          <div class="checkout-step-actions">
            <button type="button" class="checkout-continue-btn" (click)="submitCustomerInfo()">
              @if (hasCustomerContact()) {
                Continue
              } @else {
                Continue without info
              }
            </button>
            <button type="button" class="checkout-skip-btn" (click)="skipCustomerInfo()">
              Skip — just give me an order number
            </button>
            <button type="button" class="checkout-cancel-btn" (click)="cancelCheckout()">Cancel</button>
          </div>
        </div>
      }

      <!-- Creating Order spinner -->
      @if (isCreatingOrder()) {
        <div class="checkout-step checkout-step-centered">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Creating order...</span>
          </div>
          <p class="checkout-subtitle">Placing your order...</p>
        </div>
      }

      <!-- Step 4: Payment -->
      @if (checkoutStep() === 'payment' && createdOrderId()) {
        <div class="checkout-step">
          <h2 class="checkout-title">Payment</h2>
          <p class="checkout-amount">{{ total() | currency:'USD':'symbol':'1.2-2' }}</p>
          <os-payment-terminal
            [amount]="total()"
            [orderId]="createdOrderId()!"
            [showOnScreen]="showOnScreenPayment()"
            [showCardReader]="showCardReader()"
            (paymentComplete)="onPaymentComplete()"
            (paymentFailed)="onPaymentFailed($event)" />
          <button type="button" class="checkout-cancel-btn" (click)="cancelCheckout()">Cancel</button>
        </div>
      }

      <!-- Step 5: Loyalty Prompt (shown after payment if eligible) -->
      @if (checkoutStep() === 'loyalty-prompt') {
        <div class="checkout-step checkout-step-centered">
          <div class="loyalty-icon">
            <i class="bi bi-star-fill"></i>
          </div>
          <h2 class="checkout-title">Join our rewards program?</h2>
          <p class="checkout-subtitle">
            Earn points on every order and unlock exclusive rewards. It's free to join!
          </p>
          <div class="checkout-step-actions">
            <button type="button" class="checkout-continue-btn" (click)="joinLoyalty()">
              Join rewards
            </button>
            <button type="button" class="checkout-skip-btn" (click)="skipLoyalty()">
              No thanks
            </button>
          </div>
        </div>
      }

      <!-- Success -->
      @if (checkoutStep() === 'success') {
        <div class="checkout-step checkout-step-centered">
          <div class="success-icon">
            <i class="bi bi-check-circle-fill"></i>
          </div>
          <h2 class="checkout-title">Order placed!</h2>
          <p class="checkout-subtitle">
            @if (hasCustomerContact()) {
              Your order is being prepared. We'll notify you when it's ready!
            } @else if (diningOption() === 'dine_in' && selectedTable()) {
              Your order is being prepared. You're at Table {{ selectedTable()!.tableNumber }}.
            } @else if (diningOption() === 'dine_in') {
              Your order is being prepared. Please take a seat.
            } @else {
              Your order is being prepared. We'll call your name when it's ready.
            }
          </p>
          <button type="button" class="checkout-done-btn" (click)="finishAndNewOrder()">
            Start new order
          </button>
        </div>
      }

      <!-- Failed -->
      @if (checkoutStep() === 'failed') {
        <div class="checkout-step checkout-step-centered">
          <div class="failed-icon">
            <i class="bi bi-exclamation-triangle-fill"></i>
          </div>
          <h2 class="checkout-title">Something went wrong</h2>
          <p class="checkout-subtitle">{{ checkoutError() }}</p>
          <div class="checkout-step-actions">
            @if (createdOrderId()) {
              <button type="button" class="checkout-retry-btn" (click)="retryPayment()">
                Retry payment
              </button>
            }
            <button type="button" class="checkout-cancel-btn" (click)="cancelCheckout()">
              Go back
            </button>
          </div>
        </div>
      }

    </div>
  </div>
}
