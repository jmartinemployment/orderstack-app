<div class="cash-drawer">
  <!-- STATUS VIEW -->
  @if (view() === 'status') {
    @if (drawerService.session(); as session) {
      <div class="drawer-header">
        <h5><i class="bi bi-cash-stack"></i> Cash Drawer</h5>
        @if (drawerService.isOpen()) {
          <span class="drawer-status open">Open</span>
        } @else {
          <span class="drawer-status closed">Closed</span>
        }
      </div>

      <div class="drawer-kpis">
        <div class="drawer-kpi kpi-balance">
          <span class="kpi-val">{{ drawerService.runningBalance() | currency }}</span>
          <span class="kpi-lbl">Expected Balance</span>
        </div>
        <div class="drawer-kpi">
          <span class="kpi-val">{{ session.openingFloat | currency }}</span>
          <span class="kpi-lbl">Opening Float</span>
        </div>
        <div class="drawer-kpi">
          <span class="kpi-val">{{ drawerService.cashSalesTotal() | currency }}</span>
          <span class="kpi-lbl">Cash Sales</span>
        </div>
        <div class="drawer-kpi">
          <span class="kpi-val">{{ drawerService.cashOutTotal() | currency }}</span>
          <span class="kpi-lbl">Cash Out</span>
        </div>
        @if (drawerService.totalDropped() > 0) {
          <div class="drawer-kpi">
            <span class="kpi-val">{{ drawerService.totalDropped() | currency }}</span>
            <span class="kpi-lbl">Drops / Deposits</span>
          </div>
        }
        @if (drawerService.totalPaidOut() > 0) {
          <div class="drawer-kpi">
            <span class="kpi-val">{{ drawerService.totalPaidOut() | currency }}</span>
            <span class="kpi-lbl">Paid Out</span>
          </div>
        }
      </div>

      <!-- Reconciliation result (closed session) -->
      @if (session.closedAt) {
        <div class="close-result">
          <div class="result-row">
            <span>Expected Cash</span>
            <span class="fw-semibold">{{ session.expectedCash | currency }}</span>
          </div>
          <div class="result-row">
            <span>Actual Cash</span>
            <span class="fw-semibold">{{ session.actualCash | currency }}</span>
          </div>
          <div class="result-row result-overshort" [class]="overShortClass()">
            <span>Over/Short</span>
            <span class="fw-bold">
              @if ((session.overShort ?? 0) > 0) { +}{{ session.overShort | currency }}
            </span>
          </div>
          <div class="result-row">
            <span>Closed By</span>
            <span>{{ session.closedBy }}</span>
          </div>
          <div class="result-row">
            <span>Closed At</span>
            <span>{{ session.closedAt | date:'short' }}</span>
          </div>
          <button type="button" class="btn btn-sm btn-primary mt-3 w-100" (click)="startNewSession()">
            Start New Session
          </button>
        </div>
      }

      <!-- Quick action buttons (drawer open) -->
      @if (drawerService.isOpen()) {
        <div class="quick-actions">
          <button type="button" class="quick-btn" (click)="showQuickEvent('paid_out')">
            <i class="bi bi-receipt"></i>
            <span>Paid Out</span>
          </button>
          <button type="button" class="quick-btn" (click)="showQuickEvent('tip_payout')">
            <i class="bi bi-heart"></i>
            <span>Tip Payout</span>
          </button>
          <button type="button" class="quick-btn" (click)="showQuickEvent('drop_to_safe')">
            <i class="bi bi-safe"></i>
            <span>Drop to Safe</span>
          </button>
          <button type="button" class="quick-btn" (click)="showQuickEvent('petty_cash')">
            <i class="bi bi-coin"></i>
            <span>Petty Cash</span>
          </button>
          <button type="button" class="quick-btn" (click)="showAddEvent()">
            <i class="bi bi-plus-circle"></i>
            <span>Other</span>
          </button>
          <button type="button" class="quick-btn quick-btn-close" (click)="showCloseDrawer()">
            <i class="bi bi-lock"></i>
            <span>Close Drawer</span>
          </button>
        </div>
      }

      <!-- Transaction log -->
      <div class="event-log">
        <h6>Transaction Log</h6>
        @for (event of eventLog(); track event.id) {
          <div class="event-row" [class.inflow]="isInflow(event.type)" [class.outflow]="!isInflow(event.type)">
            <div class="event-left">
              <div class="event-type-row">
                <i class="bi" [class]="getEventIcon(event.type)"></i>
                <span class="event-type">{{ getEventLabel(event.type) }}</span>
              </div>
              <span class="event-reason">{{ event.reason }}</span>
            </div>
            <div class="event-right">
              <span class="event-amount">
                {{ isInflow(event.type) ? '+' : '-' }}{{ event.amount | currency }}
              </span>
              <span class="event-time">{{ event.timestamp | date:'shortTime' }}</span>
            </div>
          </div>
        } @empty {
          <p class="text-empty">No transactions yet</p>
        }
      </div>

    } @else {
      <!-- No session -->
      <div class="no-session">
        <i class="bi bi-cash-stack"></i>
        <p>No cash drawer session</p>
        <button type="button" class="btn btn-primary" (click)="showOpenDrawer()">
          Open Cash Drawer
        </button>
      </div>
    }
  }

  <!-- OPEN DRAWER VIEW -->
  @if (view() === 'open') {
    <div class="drawer-form">
      <h5><i class="bi bi-unlock me-2"></i>Open Cash Drawer</h5>
      <div class="mb-3">
        <label class="form-label">Starting Cash (Float)</label>
        <div class="amount-group">
          <span class="amount-prefix">$</span>
          <input
            type="number"
            class="form-control"
            min="0"
            [value]="openingFloat()"
            (input)="setOpeningFloat(+$any($event.target).value)">
        </div>
      </div>
      <div class="presets">
        @for (amt of [100, 150, 200, 300, 500]; track amt) {
          <button
            type="button"
            class="preset"
            [class.active]="openingFloat() === amt"
            (click)="setOpeningFloat(amt)">
            ${{ amt }}
          </button>
        }
      </div>
      <div class="form-actions">
        <button type="button" class="btn btn-outline-secondary" (click)="cancelView()">Cancel</button>
        <button type="button" class="btn btn-primary" [disabled]="openingFloat() <= 0" (click)="openDrawer()">Open Drawer</button>
      </div>
    </div>
  }

  <!-- CLOSE DRAWER VIEW (Denomination Count) -->
  @if (view() === 'close') {
    <div class="drawer-form drawer-form-wide">
      <h5><i class="bi bi-lock me-2"></i>Close Cash Drawer</h5>

      <div class="close-expected">
        <span>Expected Cash</span>
        <span class="fw-bold">{{ drawerService.runningBalance() | currency }}</span>
      </div>

      <!-- Denomination grid -->
      <div class="denom-grid">
        <div class="denom-header">
          <span>Denomination</span>
          <span>Count</span>
          <span>Subtotal</span>
        </div>
        @for (row of denominationRows; track row.key) {
          <div class="denom-row">
            <span class="denom-label">{{ row.label }}</span>
            <input
              type="number"
              class="denom-input"
              min="0"
              [value]="denomination()[row.key]"
              (input)="setDenominationCount(row.key, +$any($event.target).value)">
            <span class="denom-subtotal">{{ denomination()[row.key] * row.value | currency }}</span>
          </div>
        }
        <div class="denom-total">
          <span>Total Counted</span>
          <span></span>
          <span class="fw-bold">{{ denominationTotal() | currency }}</span>
        </div>
      </div>

      <!-- Variance display -->
      @if (denominationTotal() > 0) {
        <div
          class="close-diff"
          [class.over]="closeVariance() > 0.005"
          [class.short]="closeVariance() < -0.005"
          [class.even]="closeVariance() >= -0.005 && closeVariance() <= 0.005">
          @if (closeVariance() > 0.005) {
            Over by {{ closeVariance() | currency }}
          } @else if (closeVariance() < -0.005) {
            Short by {{ -closeVariance() | currency }}
          } @else {
            Balanced â€” no variance
          }
        </div>
      }

      <div class="form-actions">
        <button type="button" class="btn btn-outline-secondary" (click)="cancelView()">Cancel</button>
        <button type="button" class="btn btn-warning" [disabled]="denominationTotal() <= 0" (click)="closeDrawer()">
          Close & Reconcile
        </button>
      </div>
    </div>
  }

  <!-- ADD EVENT VIEW -->
  @if (view() === 'event') {
    <div class="drawer-form">
      <h5>Record Cash Event</h5>
      <div class="mb-3">
        <label class="form-label">Type</label>
        <div class="event-types">
          @for (t of ['cash_in', 'cash_out', 'paid_out', 'tip_payout', 'drop_to_safe', 'petty_cash', 'bank_deposit']; track t) {
            <button
              type="button"
              class="event-type-btn"
              [class.active]="eventType() === t"
              (click)="setEventType($any(t))">
              <i class="bi" [class]="getEventIcon($any(t))"></i>
              {{ getEventLabel($any(t)) }}
            </button>
          }
        </div>
      </div>
      <div class="mb-3">
        <label class="form-label">Amount</label>
        <div class="amount-group">
          <span class="amount-prefix">$</span>
          <input
            type="number"
            class="form-control"
            min="0"
            step="0.01"
            [value]="eventAmount()"
            (input)="setEventAmount(+$any($event.target).value)">
        </div>
      </div>
      <div class="mb-3">
        <label class="form-label">Reason</label>
        <input
          type="text"
          class="form-control"
          placeholder="e.g., Vendor delivery, tip payout for John"
          [value]="eventReason()"
          (input)="setEventReason($any($event.target).value)">
      </div>
      <div class="form-actions">
        <button type="button" class="btn btn-outline-secondary" (click)="cancelView()">Cancel</button>
        <button
          type="button"
          class="btn btn-primary"
          [disabled]="eventAmount() <= 0 || !eventReason().trim()"
          (click)="submitEvent()">
          Record
        </button>
      </div>
    </div>
  }
</div>
