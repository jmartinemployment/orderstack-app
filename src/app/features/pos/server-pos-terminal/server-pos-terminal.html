<div class="pos-terminal">
  <!-- ==================== LEFT: Item Grid Area ==================== -->
  <main class="pos-main">

    <!-- Top Tabs -->
    <nav class="top-tabs">
      <button
        type="button"
        class="top-tab"
        [class.active]="activeTopTab() === 'keypad'"
        (click)="selectTopTab('keypad')">
        Keypad
      </button>
      <button
        type="button"
        class="top-tab"
        [class.active]="activeTopTab() === 'library'"
        (click)="selectTopTab('library')">
        Library
      </button>
      <button
        type="button"
        class="top-tab"
        [class.active]="activeTopTab() === 'favorites'"
        (click)="selectTopTab('favorites')">
        Favorites
      </button>
      <button
        type="button"
        class="top-tab"
        [class.active]="activeTopTab() === 'menu'"
        (click)="selectTopTab('menu')">
        Menu
      </button>
      <button type="button" class="top-tab-more" aria-label="More options">
        <i class="bi bi-three-dots"></i>
      </button>
    </nav>

    <!-- Category pills (only visible on Menu tab) -->
    @if (activeTopTab() === 'menu') {
      <div class="category-pills">
        @for (cat of categories(); track cat.id) {
          <button
            type="button"
            class="category-pill"
            [class.active]="selectedCategoryId() === cat.id"
            (click)="selectCategory(cat.id)">
            {{ cat.name }}
          </button>
        }
      </div>
    }

    <!-- Keypad View -->
    @if (activeTopTab() === 'keypad') {
      <div class="keypad-view">
        <div class="keypad-display">
          <span class="keypad-dollar">$</span>
          <span class="keypad-amount">{{ keypadValue() || '0' }}</span>
        </div>
        <div class="keypad-grid">
          @for (key of ['1','2','3','4','5','6','7','8','9','00','0','.']; track key) {
            <button
              type="button"
              class="keypad-key"
              (click)="onKeypadPress(key)">
              {{ key }}
            </button>
          }
        </div>
        <div class="keypad-actions">
          <button type="button" class="keypad-clear" (click)="onKeypadPress('clear')">Clear</button>
          <button type="button" class="keypad-backspace" (click)="onKeypadPress('backspace')">
            <i class="bi bi-backspace"></i>
          </button>
        </div>
      </div>
    }

    <!-- Item Grid -->
    @if (activeTopTab() !== 'keypad') {
      <div class="item-grid-container">
        @if (isLoading()) {
          <div class="grid-loading">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Loading menu...</span>
            </div>
          </div>
        } @else {
          <div class="item-grid">
            @for (item of gridItems(); track item.id) {
              <button type="button" class="item-tile" (click)="addItem(item)">
                @if (getItemImage(item); as imgUrl) {
                  <div class="item-image">
                    <img [src]="imgUrl" [alt]="item.name" loading="lazy" (error)="onImageError($event)" />
                    <i class="bi bi-bag item-image-fallback"></i>
                  </div>
                } @else {
                  <div class="item-image item-image-placeholder">
                    <i class="bi bi-bag"></i>
                  </div>
                }
                <span class="item-name">{{ item.name }}</span>
              </button>
            }

            <!-- Empty placeholder tiles to fill the row -->
            @for (i of [1,2,3,4,5]; track i) {
              @if (gridItems().length % 5 !== 0 && i <= 5 - (gridItems().length % 5)) {
                <div class="item-tile item-tile-empty"></div>
              }
            }
          </div>

          <!-- Action tiles row -->
          <div class="action-tiles">
            <button type="button" class="action-tile">
              <div class="action-icon">
                <i class="bi bi-percent"></i>
              </div>
              <span class="action-label">Discounts</span>
            </button>
            <button type="button" class="action-tile">
              <div class="action-icon">
                <i class="bi bi-star-fill"></i>
              </div>
              <span class="action-label">Rewards</span>
            </button>
            <button type="button" class="action-tile">
              <div class="action-icon">
                <i class="bi bi-gift-fill"></i>
              </div>
              <span class="action-label">Gift cards</span>
            </button>
            <div class="action-tile action-tile-empty"></div>
            <div class="action-tile action-tile-empty"></div>
          </div>
        }
      </div>
    }

    <!-- Bottom Navigation -->
    <nav class="bottom-nav">
      <button
        type="button"
        class="bottom-nav-item"
        [class.active]="activeBottomTab() === 'checkout'"
        (click)="selectBottomTab('checkout')">
        <i class="bi bi-grid-3x3-gap-fill"></i>
        <span>Checkout</span>
      </button>
      <button
        type="button"
        class="bottom-nav-item"
        [class.active]="activeBottomTab() === 'open-orders'"
        (click)="selectBottomTab('open-orders')">
        <i class="bi bi-receipt"></i>
        <span>Open Orders</span>
      </button>
      <button
        type="button"
        class="bottom-nav-item"
        [class.active]="activeBottomTab() === 'notifications'"
        (click)="selectBottomTab('notifications')">
        <i class="bi bi-bell"></i>
        <span>Notifications</span>
      </button>
      <button
        type="button"
        class="bottom-nav-item"
        [class.active]="activeBottomTab() === 'more'"
        (click)="selectBottomTab('more')">
        <i class="bi bi-list"></i>
        <span>More</span>
      </button>
    </nav>
  </main>

  <!-- ==================== RIGHT: Current Sale Panel ==================== -->
  <aside class="sale-panel">
    <div class="sale-header">
      <h2>Current sale{{ cartCount() > 0 ? ' (' + cartCount() + ')' : '' }}</h2>
      <button type="button" class="sale-more-btn" aria-label="Sale options">
        <i class="bi bi-three-dots"></i>
      </button>
    </div>

    <!-- Customer row (placeholder) -->
    <button type="button" class="customer-row">
      <div class="customer-avatar">
        <i class="bi bi-person-fill"></i>
      </div>
      <span class="customer-name">Add customer</span>
      <i class="bi bi-chevron-right customer-chevron"></i>
    </button>

    <!-- Line items -->
    <div class="sale-items">
      @if (cartItems().length === 0) {
        <div class="sale-empty">
          <p>No items yet</p>
        </div>
      } @else {
        @for (item of cartItems(); track item.id) {
          <div class="sale-line-item">
            <div class="line-item-info">
              <button type="button" class="line-item-name" (click)="removeItem(item.id)">
                @if (item.quantity > 1) {
                  <span class="line-item-qty">{{ item.quantity }}x</span>
                }
                {{ item.menuItem.name }}
              </button>
              @if (item.modifierSummary) {
                <span class="line-item-modifier">{{ item.modifierSummary }}</span>
              }
            </div>
            <span class="line-item-price">{{ item.totalPrice | currency:'USD':'symbol':'1.2-2' }}</span>
          </div>
        }
      }
    </div>

    <!-- Totals + actions -->
    <div class="sale-footer">
      @if (cartItems().length > 0) {
        <div class="sale-totals">
          <div class="total-row">
            <span>Tax</span>
            <span>{{ tax() | currency:'USD':'symbol':'1.2-2' }}</span>
          </div>
          <div class="total-divider"></div>
          <button type="button" class="add-discount-btn">Add discount</button>
        </div>
      }

      <button
        type="button"
        class="send-btn"
        [disabled]="cartItems().length === 0"
        (click)="sendToKitchen()">
        @if (cartItems().length > 0) {
          <i class="bi bi-send-fill"></i> Send to Kitchen
        } @else {
          Send to Kitchen
        }
      </button>
    </div>
  </aside>
</div>

<!-- ==================== SEND TO KITCHEN OVERLAY ==================== -->
@if (sendStep() !== 'idle') {
  <div class="send-overlay">
    <div class="send-modal">

      <!-- Step 1: Dining Option -->
      @if (sendStep() === 'dining-option') {
        <div class="send-step">
          <h2 class="send-title">Order type</h2>
          <p class="send-subtitle">Where is this order going?</p>
          <div class="dining-options">
            <button
              type="button"
              class="dining-option-card"
              (click)="selectDiningOption('dine_in')">
              <div class="dining-option-icon">
                <i class="bi bi-cup-hot-fill"></i>
              </div>
              <span class="dining-option-label">Dine In</span>
            </button>
            <button
              type="button"
              class="dining-option-card"
              (click)="selectDiningOption('takeout')">
              <div class="dining-option-icon">
                <i class="bi bi-bag-fill"></i>
              </div>
              <span class="dining-option-label">Takeout</span>
            </button>
          </div>
          <button type="button" class="send-cancel-btn" (click)="cancelSend()">Cancel</button>
        </div>
      }

      <!-- Step 2: Table Selection (Dine In only) -->
      @if (sendStep() === 'table-select') {
        <div class="send-step">
          <h2 class="send-title">Select table</h2>
          <p class="send-subtitle">Choose the table for this order</p>

          @if (tablesLoading()) {
            <div class="table-loading">
              <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading tables...</span>
              </div>
            </div>
          } @else {
            <div class="table-grid">
              @for (table of availableTables(); track table.id) {
                <button
                  type="button"
                  class="table-card"
                  (click)="selectTable(table)">
                  <span class="table-number">{{ table.tableNumber }}</span>
                  <span class="table-name">{{ table.tableName ?? 'Table ' + table.tableNumber }}</span>
                  <span class="table-capacity">
                    <i class="bi bi-people-fill"></i> {{ table.capacity }}
                  </span>
                </button>
              }
            </div>

            @if (availableTables().length === 0) {
              <p class="no-tables-msg">No tables available right now</p>
            }
          }

          <div class="send-step-actions">
            <button type="button" class="send-skip-btn" (click)="skipTableSelection()">
              Skip â€” no table
            </button>
            <button type="button" class="send-cancel-btn" (click)="cancelSend()">Cancel</button>
          </div>
        </div>
      }

      <!-- Sending spinner -->
      @if (sendStep() === 'sending') {
        <div class="send-step send-step-centered">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Sending order...</span>
          </div>
          <p class="send-subtitle">Sending to kitchen...</p>
        </div>
      }

      <!-- Success -->
      @if (sendStep() === 'success') {
        <div class="send-step send-step-centered">
          <div class="success-icon">
            <i class="bi bi-check-circle-fill"></i>
          </div>
          <h2 class="send-title">Order sent!</h2>
          <p class="send-subtitle">The kitchen is preparing this order.</p>
          <button type="button" class="send-done-btn" (click)="finishAndNewOrder()">
            New order
          </button>
        </div>
      }

      <!-- Failed -->
      @if (sendStep() === 'failed') {
        <div class="send-step send-step-centered">
          <div class="failed-icon">
            <i class="bi bi-exclamation-triangle-fill"></i>
          </div>
          <h2 class="send-title">Something went wrong</h2>
          <p class="send-subtitle">{{ sendError() }}</p>
          <div class="send-step-actions">
            <button type="button" class="send-retry-btn" (click)="retrySend()">
              Try again
            </button>
            <button type="button" class="send-cancel-btn" (click)="cancelSend()">
              Go back
            </button>
          </div>
        </div>
      }

    </div>
  </div>
}
