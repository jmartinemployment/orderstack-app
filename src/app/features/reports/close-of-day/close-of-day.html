<div class="cod-report">
  <!-- Header -->
  <div class="cod-header">
    <div class="cod-title">
      <h4><i class="bi bi-clipboard2-data"></i> Close of Day Report</h4>
      <div class="cod-date-picker">
        <input
          type="date"
          class="form-control form-control-sm"
          [value]="getReportDateString()"
          (change)="setReportDate($any($event.target).value)">
      </div>
    </div>
    <div class="cod-actions">
      <button type="button" class="btn btn-sm btn-outline-light" (click)="exportCSV()">
        <i class="bi bi-download me-1"></i> Export CSV
      </button>
      <button type="button" class="btn btn-sm btn-outline-light" (click)="printReport()">
        <i class="bi bi-printer me-1"></i> Print
      </button>
    </div>
  </div>

  <!-- KPI Cards -->
  <div class="cod-kpis">
    <div class="kpi-card">
      <span class="kpi-value">{{ totalRevenue() | currency }}</span>
      <span class="kpi-label">Total Revenue</span>
    </div>
    <div class="kpi-card">
      <span class="kpi-value">{{ totalOrders() }}</span>
      <span class="kpi-label">Orders</span>
    </div>
    <div class="kpi-card">
      <span class="kpi-value">{{ averageCheck() | currency }}</span>
      <span class="kpi-label">Avg Check</span>
    </div>
    <div class="kpi-card">
      <span class="kpi-value">{{ totalGuests() }}</span>
      <span class="kpi-label">Covers</span>
    </div>
    <div class="kpi-card">
      <span class="kpi-value">{{ totalTips() | currency }}</span>
      <span class="kpi-label">Total Tips</span>
    </div>
    <div class="kpi-card">
      <span class="kpi-value">{{ totalTax() | currency }}</span>
      <span class="kpi-label">Tax Collected</span>
    </div>
  </div>

  <!-- Tab bar -->
  <div class="cod-tabs">
    <button type="button" class="cod-tab" [class.active]="activeTab() === 'summary'" (click)="setTab('summary')">Summary</button>
    <button type="button" class="cod-tab" [class.active]="activeTab() === 'payments'" (click)="setTab('payments')">Payments</button>
    <button type="button" class="cod-tab" [class.active]="activeTab() === 'tips'" (click)="setTab('tips')">Tips</button>
    <button type="button" class="cod-tab" [class.active]="activeTab() === 'voids'" (click)="setTab('voids')">Voids & Comps</button>
    <button type="button" class="cod-tab" [class.active]="activeTab() === 'items'" (click)="setTab('items')">Top Sellers</button>
    <button type="button" class="cod-tab" [class.active]="activeTab() === 'team'" (click)="setTab('team')">Team Sales</button>
    <button type="button" class="cod-tab" [class.active]="activeTab() === 'taxes'" (click)="setTab('taxes')">Taxes & Fees</button>
    <button type="button" class="cod-tab" [class.active]="activeTab() === 'cash'" (click)="setTab('cash')">Cash</button>
    <button type="button" class="cod-tab" [class.active]="activeTab() === 'delivery'" (click)="setTab('delivery')">
      Delivery
      @if (deliveryOrderCount() > 0) {
        <span class="badge bg-primary ms-1" style="font-size: 0.65rem;">{{ deliveryOrderCount() }}</span>
      }
    </button>
  </div>

  <!-- Loading -->
  @if (isLoading()) {
    <div class="cod-loading">
      <div class="spinner-border text-primary" role="status"></div>
      <p>Loading report data...</p>
    </div>
  } @else {

    <!-- SUMMARY TAB -->
    @if (activeTab() === 'summary') {
      <div class="cod-section">
        <!-- Order source breakdown -->
        <div class="section-card">
          <h6>Order Sources</h6>
          @for (src of orderSourceBreakdown(); track src.source) {
            <div class="breakdown-row">
              <span class="breakdown-label">{{ src.source }}</span>
              <span class="breakdown-value">{{ src.count }} order{{ src.count !== 1 ? 's' : '' }}</span>
            </div>
          } @empty {
            <p class="text-muted-custom">No orders today</p>
          }
        </div>

        <!-- Quick payment summary -->
        <div class="section-card">
          <h6>Payment Summary</h6>
          @for (pm of paymentBreakdown(); track pm.method) {
            <div class="breakdown-row">
              <span class="breakdown-label">{{ pm.method }}</span>
              <span class="breakdown-value">{{ pm.total | currency }} <small>({{ pm.count }})</small></span>
            </div>
          } @empty {
            <p class="text-muted-custom">No payments recorded</p>
          }
        </div>

        <!-- Quick void/comp/discount summary -->
        <div class="section-card">
          <h6>Adjustments</h6>
          <div class="breakdown-row">
            <span class="breakdown-label">Voided Items</span>
            <span class="breakdown-value void-text">{{ voidSummary().count }} ({{ voidSummary().totalValue | currency }})</span>
          </div>
          <div class="breakdown-row">
            <span class="breakdown-label">Comped Items</span>
            <span class="breakdown-value comp-text">{{ compSummary().count }} ({{ compSummary().totalValue | currency }})</span>
          </div>
          <div class="breakdown-row">
            <span class="breakdown-label">Discounts</span>
            <span class="breakdown-value disc-text">{{ discountSummary().count }} ({{ discountSummary().totalValue | currency }})</span>
          </div>
        </div>

        <!-- Voided orders -->
        @if (voidedOrders().length > 0) {
          <div class="section-card">
            <h6>Voided Orders</h6>
            <p class="text-muted-custom">{{ voidedOrders().length }} order{{ voidedOrders().length !== 1 ? 's' : '' }} voided today</p>
          </div>
        }
      </div>
    }

    <!-- PAYMENTS TAB -->
    @if (activeTab() === 'payments') {
      <div class="cod-section">
        <div class="section-card full-width">
          <h6>Payment Method Breakdown</h6>
          <table class="cod-table">
            <thead>
              <tr>
                <th>Method</th>
                <th class="text-end">Transactions</th>
                <th class="text-end">Total</th>
                <th class="text-end">% of Revenue</th>
              </tr>
            </thead>
            <tbody>
              @for (pm of paymentBreakdown(); track pm.method) {
                <tr>
                  <td>
                    <span class="payment-dot" [class]="'dot-' + pm.method.toLowerCase().split(' ')[0]"></span>
                    {{ pm.method }}
                  </td>
                  <td class="text-end">{{ pm.count }}</td>
                  <td class="text-end fw-semibold">{{ pm.total | currency }}</td>
                  <td class="text-end">
                    @if (totalRevenue() > 0) {
                      {{ pm.total / totalRevenue() | percent:'1.1-1' }}
                    } @else {
                      0%
                    }
                  </td>
                </tr>
              } @empty {
                <tr><td colspan="4" class="text-muted-custom text-center py-4">No payments recorded</td></tr>
              }
            </tbody>
            <tfoot>
              <tr class="total-row">
                <td>Total</td>
                <td class="text-end">{{ paymentTransactionCount() }}</td>
                <td class="text-end fw-bold">{{ totalRevenue() | currency }}</td>
                <td class="text-end">100%</td>
              </tr>
            </tfoot>
          </table>
        </div>
      </div>
    }

    <!-- TIPS TAB -->
    @if (activeTab() === 'tips') {
      <div class="cod-section">
        <div class="section-card full-width">
          <h6>Tips by Server</h6>
          @if (tipReport(); as report) {
            <table class="cod-table">
              <thead>
                <tr>
                  <th>Server</th>
                  <th class="text-end">Orders</th>
                  <th class="text-end">Sales</th>
                  <th class="text-end">Tips</th>
                  <th class="text-end">Net Tips</th>
                  <th class="text-end">Tip %</th>
                </tr>
              </thead>
              <tbody>
                @for (srv of report.serverSummaries; track srv.serverGuid) {
                  <tr>
                    <td>{{ srv.serverName }}</td>
                    <td class="text-end">{{ srv.orderCount }}</td>
                    <td class="text-end">{{ srv.totalSales | currency }}</td>
                    <td class="text-end">{{ srv.totalTips | currency }}</td>
                    <td class="text-end fw-semibold">{{ srv.netTips | currency }}</td>
                    <td class="text-end">
                      @if (srv.totalSales > 0) {
                        {{ srv.totalTips / srv.totalSales | percent:'1.1-1' }}
                      } @else {
                        0%
                      }
                    </td>
                  </tr>
                } @empty {
                  <tr><td colspan="6" class="text-muted-custom text-center py-4">No tips recorded today</td></tr>
                }
              </tbody>
              <tfoot>
                <tr class="total-row">
                  <td>Total</td>
                  <td class="text-end">{{ report.entries.length }}</td>
                  <td class="text-end">{{ report.totalSales | currency }}</td>
                  <td class="text-end fw-bold">{{ report.totalTips | currency }}</td>
                  <td></td>
                  <td class="text-end">{{ report.averageTipPercent }}%</td>
                </tr>
              </tfoot>
            </table>
          }
        </div>
      </div>
    }

    <!-- VOIDS & COMPS TAB -->
    @if (activeTab() === 'voids') {
      <div class="cod-section">
        <!-- Voids -->
        <div class="section-card">
          <h6><span class="badge-void">VOID</span> Voided Items</h6>
          <div class="adj-summary">
            <span class="adj-count">{{ voidSummary().count }} item{{ voidSummary().count !== 1 ? 's' : '' }}</span>
            <span class="adj-total void-text">{{ voidSummary().totalValue | currency }}</span>
          </div>
          @for (r of voidSummary().reasons; track r.reason) {
            <div class="reason-row">
              <span>{{ r.reason }}</span>
              <span class="reason-count">{{ r.count }}</span>
            </div>
          } @empty {
            <p class="text-muted-custom">No voids today</p>
          }
        </div>

        <!-- Comps -->
        <div class="section-card">
          <h6><span class="badge-comp">COMP</span> Comped Items</h6>
          <div class="adj-summary">
            <span class="adj-count">{{ compSummary().count }} item{{ compSummary().count !== 1 ? 's' : '' }}</span>
            <span class="adj-total comp-text">{{ compSummary().totalValue | currency }}</span>
          </div>
          @for (r of compSummary().reasons; track r.reason) {
            <div class="reason-row">
              <span>{{ r.reason }}</span>
              <span class="reason-count">{{ r.count }}</span>
            </div>
          } @empty {
            <p class="text-muted-custom">No comps today</p>
          }
        </div>

        <!-- Discounts -->
        <div class="section-card">
          <h6><span class="badge-disc">DISC</span> Discounts</h6>
          <div class="adj-summary">
            <span class="adj-count">{{ discountSummary().count }} applied</span>
            <span class="adj-total disc-text">{{ discountSummary().totalValue | currency }}</span>
          </div>
          @for (r of discountSummary().reasons; track r.reason) {
            <div class="reason-row">
              <span>{{ r.reason }}</span>
              <span class="reason-count">{{ r.count }}</span>
            </div>
          } @empty {
            <p class="text-muted-custom">No discounts today</p>
          }
        </div>
      </div>
    }

    <!-- TOP SELLERS TAB -->
    @if (activeTab() === 'items') {
      <div class="cod-section">
        <div class="section-card full-width">
          <h6>Top Selling Items</h6>
          <table class="cod-table">
            <thead>
              <tr>
                <th>#</th>
                <th>Item</th>
                <th class="text-end">Qty Sold</th>
                <th class="text-end">Revenue</th>
              </tr>
            </thead>
            <tbody>
              @for (item of topSellers(); track item.name; let i = $index) {
                <tr>
                  <td class="rank-cell">{{ i + 1 }}</td>
                  <td>{{ item.name }}</td>
                  <td class="text-end">{{ item.quantity }}</td>
                  <td class="text-end fw-semibold">{{ item.revenue | currency }}</td>
                </tr>
              } @empty {
                <tr><td colspan="4" class="text-muted-custom text-center py-4">No items sold today</td></tr>
              }
            </tbody>
          </table>
        </div>
      </div>
    }

    <!-- TEAM SALES TAB -->
    @if (activeTab() === 'team') {
      <div class="cod-section">
        @if (isLoadingTeam()) {
          <div class="section-card full-width text-center py-4">
            <div class="spinner-border spinner-border-sm text-primary me-2" role="status"></div>
            Loading team sales...
          </div>
        } @else {
          <div class="section-card full-width">
            <h6>Team Member Sales</h6>
            <table class="cod-table">
              <thead>
                <tr>
                  <th>Name</th>
                  <th>Job Title</th>
                  <th class="text-end">Orders</th>
                  <th class="text-end">Revenue</th>
                  <th class="text-end">Avg Ticket</th>
                  <th class="text-end">Tips</th>
                  <th class="text-end">Hours</th>
                  <th class="text-end">Commission</th>
                </tr>
              </thead>
              <tbody>
                @for (member of teamSales(); track member.staffId) {
                  <tr>
                    <td class="fw-semibold">{{ member.staffName }}</td>
                    <td>{{ member.jobTitle }}</td>
                    <td class="text-end">{{ member.orderCount }}</td>
                    <td class="text-end fw-semibold">{{ member.revenue | currency }}</td>
                    <td class="text-end">{{ member.avgTicket | currency }}</td>
                    <td class="text-end">{{ member.tips | currency }}</td>
                    <td class="text-end">{{ member.hoursWorked | number:'1.1-1' }}</td>
                    <td class="text-end">{{ member.commissionEarned | currency }}</td>
                  </tr>
                } @empty {
                  <tr><td colspan="8" class="text-muted-custom text-center py-4">No team sales data for this date</td></tr>
                }
              </tbody>
              @if (teamSales().length > 0) {
                <tfoot>
                  <tr class="total-row">
                    <td colspan="2">Total</td>
                    <td class="text-end">{{ teamTotalOrders() }}</td>
                    <td class="text-end fw-bold">{{ teamTotalRevenue() | currency }}</td>
                    <td></td>
                    <td class="text-end fw-bold">{{ teamTotalTips() | currency }}</td>
                    <td></td>
                    <td></td>
                  </tr>
                </tfoot>
              }
            </table>
          </div>

          <!-- Revenue by Team Member Bar Chart -->
          @if (teamSales().length > 0) {
            <div class="section-card full-width">
              <h6>Revenue by Team Member</h6>
              <div class="team-bar-chart">
                @for (member of teamSales(); track member.staffId) {
                  <div class="team-bar-row">
                    <span class="team-bar-label">{{ member.staffName }}</span>
                    <div class="team-bar-track">
                      <div class="team-bar-fill" [style.width.%]="getTeamBarWidth(member.revenue)"></div>
                    </div>
                    <span class="team-bar-value">{{ member.revenue | currency }}</span>
                  </div>
                }
              </div>
            </div>
          }
        }
      </div>
    }

    <!-- TAXES & FEES TAB -->
    @if (activeTab() === 'taxes') {
      <div class="cod-section">
        @if (isLoadingTax()) {
          <div class="section-card full-width text-center py-4">
            <div class="spinner-border spinner-border-sm text-primary me-2" role="status"></div>
            Loading tax report...
          </div>
        } @else if (taxReport(); as report) {
          <!-- Revenue Summary -->
          <div class="section-card full-width">
            <h6>Revenue Summary</h6>
            <div class="tax-summary-grid">
              <div class="tax-summary-item">
                <span class="tax-summary-label">Gross Revenue</span>
                <span class="tax-summary-value">{{ report.grossRevenue | currency }}</span>
              </div>
              <div class="tax-summary-item tax-deduction">
                <span class="tax-summary-label">Total Tax</span>
                <span class="tax-summary-value">- {{ report.totalTax | currency }}</span>
              </div>
              <div class="tax-summary-item tax-deduction">
                <span class="tax-summary-label">Service Charges</span>
                <span class="tax-summary-value">- {{ report.totalServiceCharges | currency }}</span>
              </div>
              <div class="tax-summary-item tax-deduction">
                <span class="tax-summary-label">Fees</span>
                <span class="tax-summary-value">- {{ report.totalFees | currency }}</span>
              </div>
              <div class="tax-summary-item tax-net">
                <span class="tax-summary-label">Net Revenue</span>
                <span class="tax-summary-value">{{ report.netRevenue | currency }}</span>
              </div>
            </div>
          </div>

          <!-- Taxes by Rate -->
          <div class="section-card">
            <h6>Taxes Collected</h6>
            @for (tax of report.taxes; track tax.taxName) {
              <div class="breakdown-row">
                <span class="breakdown-label">
                  {{ tax.taxName }}
                  <small class="text-muted-custom">({{ tax.taxRate | percent:'1.2-2' }})</small>
                </span>
                <span class="breakdown-value">{{ tax.taxCollected | currency }}</span>
              </div>
            } @empty {
              <p class="text-muted-custom">No tax data</p>
            }
          </div>

          <!-- Service Charges -->
          <div class="section-card">
            <h6>Service Charges</h6>
            @for (charge of report.serviceCharges; track charge.chargeName) {
              <div class="breakdown-row">
                <span class="breakdown-label">
                  {{ charge.chargeName }}
                  <small class="text-muted-custom">({{ charge.timesApplied }}x)</small>
                </span>
                <span class="breakdown-value">{{ charge.totalCollected | currency }}</span>
              </div>
            } @empty {
              <p class="text-muted-custom">No service charges</p>
            }
          </div>

          <!-- Fee Breakdown -->
          <div class="section-card">
            <h6>Fee Breakdown</h6>
            @for (fee of report.fees; track fee.feeType) {
              <div class="breakdown-row">
                <span class="breakdown-label">
                  {{ fee.feeType }}
                  <small class="text-muted-custom">({{ fee.transactionCount }} txns)</small>
                </span>
                <span class="breakdown-value">{{ fee.totalAmount | currency }}</span>
              </div>
            } @empty {
              <p class="text-muted-custom">No fees recorded</p>
            }
          </div>
        } @else {
          <div class="section-card full-width text-center py-4">
            <p class="text-muted-custom">No tax and fee data available for this date</p>
          </div>
        }
      </div>
    }

    <!-- CASH TAB -->
    @if (activeTab() === 'cash') {
      <div class="cod-section">
        @if (cashDrawerService.todaysReconciliations().length > 0) {
          @for (recon of cashDrawerService.todaysReconciliations(); track recon.sessionId) {
            <div class="section-card full-width">
              <h6>Session â€” {{ recon.openedBy }}</h6>
              <div class="cash-recon-grid">
                <div class="cash-recon-row">
                  <span>Opening Float</span>
                  <span class="fw-semibold">{{ recon.openingFloat | currency }}</span>
                </div>
                <div class="cash-recon-row">
                  <span>Cash Sales</span>
                  <span class="fw-semibold">{{ recon.cashSalesTotal | currency }}</span>
                </div>
                <div class="cash-recon-row">
                  <span>Cash Out</span>
                  <span class="fw-semibold">{{ recon.cashOutTotal | currency }}</span>
                </div>
                <div class="cash-recon-row">
                  <span>Expected Cash</span>
                  <span class="fw-bold">{{ recon.expectedCash | currency }}</span>
                </div>
                <div class="cash-recon-row">
                  <span>Actual Cash</span>
                  <span class="fw-bold">{{ recon.actualCash | currency }}</span>
                </div>
                <div class="cash-recon-row cash-recon-variance"
                  [class.over]="recon.overShort > 0.005"
                  [class.short]="recon.overShort < -0.005"
                  [class.even]="recon.overShort >= -0.005 && recon.overShort <= 0.005">
                  <span>Over/Short</span>
                  <span class="fw-bold">
                    @if (recon.overShort > 0) { +}{{ recon.overShort | currency }}
                  </span>
                </div>
                <div class="cash-recon-row cash-recon-meta">
                  <span>Closed by {{ recon.closedBy }}</span>
                  <span>{{ recon.eventCount }} transactions</span>
                </div>
              </div>
            </div>
          }
        } @else {
          <div class="section-card full-width text-center py-4">
            <p class="text-muted-custom">No cash drawer sessions closed today</p>
          </div>
        }
      </div>
    }

    <!-- DELIVERY TAB -->
    @if (activeTab() === 'delivery') {
      <div class="cod-section">
        @if (isLoadingDelivery()) {
          <div class="section-card full-width text-center py-4">
            <div class="spinner-border spinner-border-sm text-primary me-2" role="status"></div>
            Loading delivery analytics...
          </div>
        } @else if (deliveryReport(); as report) {
          <!-- Delivery KPIs -->
          <div class="section-card full-width">
            <h6>Delivery Overview</h6>
            <div class="delivery-kpi-grid">
              <div class="delivery-kpi">
                <span class="delivery-kpi-value">{{ report.totalDeliveries }}</span>
                <span class="delivery-kpi-label">Total Deliveries</span>
              </div>
              <div class="delivery-kpi">
                <span class="delivery-kpi-value">{{ report.avgDeliveryMinutes | number:'1.0-0' }} min</span>
                <span class="delivery-kpi-label">Avg Delivery Time</span>
              </div>
              <div class="delivery-kpi">
                <span class="delivery-kpi-value">{{ report.onTimePercentage | number:'1.0-0' }}%</span>
                <span class="delivery-kpi-label">On-Time Rate</span>
              </div>
              <div class="delivery-kpi">
                <span class="delivery-kpi-value">{{ report.totalDeliveryFees | currency }}</span>
                <span class="delivery-kpi-label">Total Fees</span>
              </div>
              <div class="delivery-kpi">
                <span class="delivery-kpi-value">{{ report.costPerDelivery | currency }}</span>
                <span class="delivery-kpi-label">Cost / Delivery</span>
              </div>
            </div>
          </div>

          <!-- By Driver -->
          @if (report.byDriver.length > 0) {
            <div class="section-card full-width">
              <h6>Driver Performance</h6>
              <table class="cod-table">
                <thead>
                  <tr>
                    <th>Driver</th>
                    <th class="text-end">Deliveries</th>
                    <th class="text-end">On-Time</th>
                    <th class="text-end">Late</th>
                    <th class="text-end">Avg Time</th>
                    <th class="text-end">Distance</th>
                    <th class="text-end">Fees</th>
                  </tr>
                </thead>
                <tbody>
                  @for (driver of report.byDriver; track driver.driverId) {
                    <tr>
                      <td class="fw-semibold">{{ driver.driverName }}</td>
                      <td class="text-end">{{ driver.totalDeliveries }}</td>
                      <td class="text-end" style="color: var(--os-success);">{{ driver.onTimeCount }}</td>
                      <td class="text-end" style="color: var(--os-danger);">{{ driver.lateCount }}</td>
                      <td class="text-end">{{ driver.avgDeliveryMinutes | number:'1.0-0' }} min</td>
                      <td class="text-end">{{ driver.totalDistanceKm | number:'1.1-1' }} km</td>
                      <td class="text-end fw-semibold">{{ driver.totalFees | currency }}</td>
                    </tr>
                  }
                </tbody>
              </table>

              <!-- Driver bar chart -->
              <div class="delivery-bar-chart mt-3">
                @for (driver of report.byDriver; track driver.driverId) {
                  <div class="delivery-bar-row">
                    <span class="delivery-bar-label">{{ driver.driverName }}</span>
                    <div class="delivery-bar-track">
                      <div class="delivery-bar-fill" [style.width.%]="getDeliveryBarWidth(driver.totalDeliveries)"></div>
                    </div>
                    <span class="delivery-bar-value">{{ driver.totalDeliveries }}</span>
                  </div>
                }
              </div>
            </div>
          }

          <!-- By Provider -->
          @if (report.byProvider.length > 0) {
            <div class="section-card full-width">
              <h6>Provider Breakdown</h6>
              @for (prov of report.byProvider; track prov.provider) {
                <div class="provider-card">
                  <span class="provider-name">{{ prov.provider }}</span>
                  <div class="provider-stats">
                    <span><span class="fw-semibold">{{ prov.count }}</span> deliveries</span>
                    <span><span class="fw-semibold">{{ prov.avgMinutes | number:'1.0-0' }}</span> min avg</span>
                    <span><span class="fw-semibold">{{ prov.onTimePercentage | number:'1.0-0' }}%</span> on-time</span>
                    <span><span class="fw-semibold">{{ prov.totalFees | currency }}</span> fees</span>
                  </div>
                </div>
              }
            </div>
          }
        } @else {
          <div class="section-card full-width text-center py-4">
            @if (deliveryOrderCount() === 0) {
              <p class="text-muted-custom">No delivery orders today</p>
            } @else {
              <p class="text-muted-custom">No delivery analytics available for this date</p>
            }
          </div>
        }
      </div>
    }
  }
</div>
