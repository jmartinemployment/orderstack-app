@if (isOpen()) {
  <div class="checkout-overlay" (click)="close()"></div>

  <div class="checkout-modal card" (click)="$event.stopPropagation()">
    <div class="card-header d-flex justify-content-between align-items-center">
      <h4 class="mb-0">
        @switch (paymentStep()) {
          @case ('cart') {
            Order
            @if (itemCount() > 0) {
              <span class="badge bg-primary ms-2">{{ itemCount() }}</span>
            }
          }
          @case ('paying') { Payment }
          @case ('failed') { Payment Failed }
        }
      </h4>
      @if (paymentStep() !== 'paying') {
        <button type="button" class="btn-close btn-close-white" (click)="close()"></button>
      }
    </div>

    <!-- STEP 1: CART REVIEW -->
    @if (paymentStep() === 'cart') {
      <div class="card-body">
        @if (error()) {
          <div class="alert alert-danger mb-3">{{ error() }}</div>
        }

        @if (isEmpty()) {
          <div class="empty-cart text-center py-5">
            <div class="empty-icon mb-3" style="font-size: 3rem;">ðŸ›’</div>
            <p class="text-muted mb-0">No items yet</p>
            <p class="text-muted small">Add items from the menu</p>
          </div>
        } @else {
          <!-- Cart Items -->
          <div class="cart-items mb-3">
            @for (item of items(); track item.id) {
              <div class="summary-item py-2 border-bottom">
                <div class="d-flex align-items-start">
                  <div class="flex-grow-1">
                    <div class="fw-semibold">{{ item.menuItem.name }}</div>
                    @if (item.selectedModifiers.length > 0) {
                      <div class="modifiers small text-muted">
                        {{ formatModifiers(item.selectedModifiers) }}
                      </div>
                    }
                    @if (item.specialInstructions) {
                      <div class="special-instructions small text-warning">
                        {{ item.specialInstructions }}
                      </div>
                    }
                  </div>
                  <button
                    type="button"
                    class="btn btn-sm btn-link text-danger p-0 ms-2"
                    (click)="removeItem(item.id)"
                  >
                    âœ•
                  </button>
                </div>
                <div class="d-flex align-items-center gap-2 mt-2">
                  <div class="quantity-controls d-flex align-items-center gap-2">
                    <button
                      type="button"
                      class="btn btn-sm btn-outline-light"
                      (click)="decrementQuantity(item.id)"
                    >
                      -
                    </button>
                    <span class="quantity-display">{{ item.quantity }}</span>
                    <button
                      type="button"
                      class="btn btn-sm btn-outline-light"
                      (click)="incrementQuantity(item.id)"
                    >
                      +
                    </button>
                  </div>
                  @if (showCourseAssignment()) {
                    <select
                      class="form-select form-select-sm course-select ms-auto"
                      [value]="getCourseForItem(item.id)"
                      (change)="onCourseAssign(item.id, $event)"
                    >
                      @for (opt of courseOptions; track opt.value) {
                        <option [value]="opt.value">{{ opt.label }}</option>
                      }
                    </select>
                  }
                </div>
              </div>
            }
          </div>

          <!-- Order Totals -->
          <div class="order-totals mb-3">
            <div class="d-flex justify-content-between small">
              <span class="text-muted">Subtotal</span>
              <span>{{ subtotal() | currency }}</span>
            </div>
            <div class="d-flex justify-content-between small">
              <span class="text-muted">Tax</span>
              <span>{{ tax() | currency }}</span>
            </div>
            @if (tip() > 0) {
              <div class="d-flex justify-content-between small">
                <span class="text-muted">Tip</span>
                <span>{{ tip() | currency }}</span>
              </div>
            }
            @if (loyaltyDiscount() > 0) {
              <div class="d-flex justify-content-between small text-success">
                <span>Loyalty Discount</span>
                <span>-{{ loyaltyDiscount() | currency }}</span>
              </div>
            }
            @if (giftCardDiscount() > 0) {
              <div class="d-flex justify-content-between small text-success">
                <span>Gift Card</span>
                <span>-{{ giftCardDiscount() | currency }}</span>
              </div>
            }
            <hr class="my-2" />
            <div class="d-flex justify-content-between fw-bold">
              <span>Total</span>
              <span class="total-amount">{{ totalAfterGiftCard() | currency }}</span>
            </div>
          </div>

          <!-- Dining Option Selector -->
          <div class="dining-pills d-flex flex-wrap gap-2 mb-3">
            @for (opt of diningOptionTypes; track opt.type) {
              <button
                type="button"
                class="btn btn-sm"
                [class.btn-primary]="diningType() === opt.type"
                [class.btn-outline-light]="diningType() !== opt.type"
                (click)="setDiningType(opt.type)"
                [disabled]="isSubmitting()"
              >
                {{ opt.label }}
              </button>
            }
          </div>

          <!-- Dine-In: Table Number -->
          @if (selectedDiningOption().requiresTable) {
            <div class="form-section">
              <div class="section-title">Table</div>
              <input
                type="text"
                class="form-control"
                [class.is-invalid]="hasValidationError('table')"
                placeholder="Table Number *"
                [value]="tableNumber()"
                (input)="onTableNumberInput($event)"
                [disabled]="isSubmitting()"
              />
              @if (hasValidationError('table')) {
                <div class="invalid-feedback d-block">Table number is required</div>
              }
            </div>
          }

          <!-- Customer Info -->
          @if (selectedDiningOption().requiresCustomer) {
            <div class="form-section">
              <div class="section-title">Customer Info</div>
              <div class="row g-2 mb-2">
                <div class="col-6">
                  <input
                    type="text"
                    class="form-control"
                    [class.is-invalid]="hasValidationError('customer.firstName')"
                    placeholder="First Name *"
                    [value]="firstName()"
                    (input)="onFieldInput('firstName', $event)"
                    [disabled]="isSubmitting()"
                  />
                  @if (hasValidationError('customer.firstName')) {
                    <div class="invalid-feedback d-block">Required</div>
                  }
                </div>
                <div class="col-6">
                  <input
                    type="text"
                    class="form-control"
                    [class.is-invalid]="hasValidationError('customer.lastName')"
                    placeholder="Last Name *"
                    [value]="lastName()"
                    (input)="onFieldInput('lastName', $event)"
                    [disabled]="isSubmitting()"
                  />
                  @if (hasValidationError('customer.lastName')) {
                    <div class="invalid-feedback d-block">Required</div>
                  }
                </div>
              </div>
              <div class="row g-2">
                <div class="col-6">
                  <input
                    type="tel"
                    class="form-control"
                    [class.is-invalid]="hasValidationError('customer.phone')"
                    placeholder="Phone *"
                    [value]="phone()"
                    (input)="onFieldInput('phone', $event)"
                    [disabled]="isSubmitting()"
                  />
                  @if (hasValidationError('customer.phone')) {
                    <div class="invalid-feedback d-block">Required</div>
                  }
                </div>
                <div class="col-6">
                  <input
                    type="email"
                    class="form-control"
                    [class.is-invalid]="hasValidationError('customer.email')"
                    placeholder="Email *"
                    [value]="email()"
                    (input)="onFieldInput('email', $event)"
                    [disabled]="isSubmitting()"
                  />
                  @if (hasValidationError('customer.email')) {
                    <div class="invalid-feedback d-block">Required</div>
                  }
                </div>
              </div>
            </div>
          }

          <!-- Curbside: Vehicle Info -->
          @if (selectedDiningOption().requiresVehicle) {
            <div class="form-section">
              <div class="section-title">Vehicle Info</div>
              <input
                type="text"
                class="form-control mb-2"
                [class.is-invalid]="hasValidationError('curbsideInfo.vehicleDescription')"
                placeholder="Vehicle Description * (e.g. Red Toyota Camry)"
                [value]="vehicleDescription()"
                (input)="onFieldInput('vehicleDescription', $event)"
                [disabled]="isSubmitting()"
              />
              @if (hasValidationError('curbsideInfo.vehicleDescription')) {
                <div class="invalid-feedback d-block mb-2">Vehicle description is required</div>
              }
              <div class="row g-2">
                <div class="col-4">
                  <input
                    type="text"
                    class="form-control"
                    placeholder="Make"
                    [value]="vehicleMake()"
                    (input)="onFieldInput('vehicleMake', $event)"
                    [disabled]="isSubmitting()"
                  />
                </div>
                <div class="col-4">
                  <input
                    type="text"
                    class="form-control"
                    placeholder="Model"
                    [value]="vehicleModel()"
                    (input)="onFieldInput('vehicleModel', $event)"
                    [disabled]="isSubmitting()"
                  />
                </div>
                <div class="col-4">
                  <input
                    type="text"
                    class="form-control"
                    placeholder="Color"
                    [value]="vehicleColor()"
                    (input)="onFieldInput('vehicleColor', $event)"
                    [disabled]="isSubmitting()"
                  />
                </div>
              </div>
            </div>
          }

          <!-- Delivery: Address -->
          @if (selectedDiningOption().requiresAddress) {
            <div class="form-section">
              <div class="section-title">Delivery Address</div>
              <input
                type="text"
                class="form-control mb-2"
                [class.is-invalid]="hasValidationError('deliveryInfo.address')"
                placeholder="Address Line 1 *"
                [value]="address()"
                (input)="onFieldInput('address', $event)"
                [disabled]="isSubmitting()"
              />
              @if (hasValidationError('deliveryInfo.address')) {
                <div class="invalid-feedback d-block mb-2">Address is required</div>
              }
              <input
                type="text"
                class="form-control mb-2"
                placeholder="Address Line 2"
                [value]="address2()"
                (input)="onFieldInput('address2', $event)"
                [disabled]="isSubmitting()"
              />
              <div class="row g-2 mb-2">
                <div class="col-5">
                  <input
                    type="text"
                    class="form-control"
                    placeholder="City"
                    [value]="city()"
                    (input)="onFieldInput('city', $event)"
                    [disabled]="isSubmitting()"
                  />
                </div>
                <div class="col-3">
                  <input
                    type="text"
                    class="form-control"
                    placeholder="State"
                    [value]="state()"
                    (input)="onFieldInput('state', $event)"
                    [disabled]="isSubmitting()"
                  />
                </div>
                <div class="col-4">
                  <input
                    type="text"
                    class="form-control"
                    placeholder="Zip"
                    [value]="zip()"
                    (input)="onFieldInput('zip', $event)"
                    [disabled]="isSubmitting()"
                  />
                </div>
              </div>
              <textarea
                class="form-control"
                rows="2"
                placeholder="Delivery Notes"
                [value]="deliveryNotes()"
                (input)="onFieldInput('deliveryNotes', $event)"
                [disabled]="isSubmitting()"
              ></textarea>
            </div>
          }

          <!-- Catering: Event Details -->
          @if (diningType() === 'catering') {
            <div class="form-section">
              <div class="section-title">Catering Details</div>
              <div class="row g-2 mb-2">
                <div class="col-6">
                  <label class="form-label small">Event Date *</label>
                  <input
                    type="date"
                    class="form-control"
                    [class.is-invalid]="hasValidationError('cateringInfo.eventDate')"
                    [value]="eventDate()"
                    (input)="onFieldInput('eventDate', $event)"
                    [disabled]="isSubmitting()"
                  />
                  @if (hasValidationError('cateringInfo.eventDate')) {
                    <div class="invalid-feedback d-block">Required</div>
                  }
                </div>
                <div class="col-6">
                  <label class="form-label small">Event Time</label>
                  <input
                    type="time"
                    class="form-control"
                    [value]="eventTime()"
                    (input)="onFieldInput('eventTime', $event)"
                    [disabled]="isSubmitting()"
                  />
                </div>
              </div>
              <div class="row g-2 mb-2">
                <div class="col-6">
                  <label class="form-label small">Headcount *</label>
                  <input
                    type="number"
                    class="form-control"
                    [class.is-invalid]="hasValidationError('cateringInfo.headcount')"
                    placeholder="0"
                    [value]="headcount()"
                    (input)="onFieldInput('headcount', $event)"
                    [disabled]="isSubmitting()"
                    min="1"
                  />
                  @if (hasValidationError('cateringInfo.headcount')) {
                    <div class="invalid-feedback d-block">Required</div>
                  }
                </div>
                <div class="col-6">
                  <label class="form-label small">Event Type</label>
                  <input
                    type="text"
                    class="form-control"
                    placeholder="Corporate, Wedding..."
                    [value]="eventType()"
                    (input)="onFieldInput('eventType', $event)"
                    [disabled]="isSubmitting()"
                  />
                </div>
              </div>
              <div class="d-flex align-items-center gap-3 mb-2">
                <div class="form-check">
                  <input
                    type="checkbox"
                    class="form-check-input"
                    id="setupRequired"
                    [checked]="setupRequired()"
                    (change)="onSetupRequiredChange($event)"
                    [disabled]="isSubmitting()"
                  />
                  <label class="form-check-label" for="setupRequired">Setup Required</label>
                </div>
              </div>
              <div>
                <label class="form-label small">Deposit Amount</label>
                <input
                  type="number"
                  class="form-control"
                  placeholder="0.00"
                  [value]="depositAmount()"
                  (input)="onFieldInput('depositAmount', $event)"
                  [disabled]="isSubmitting()"
                  min="0"
                  step="0.01"
                />
              </div>
            </div>
          }

          <!-- Loyalty Program -->
          @if (loyaltyEnabled()) {
            <div class="form-section loyalty-section">
              <div class="section-title">Loyalty Program</div>
              @if (showLoyaltyPhoneField()) {
                <input
                  type="tel"
                  class="form-control mb-2"
                  placeholder="Phone for loyalty lookup"
                  [value]="loyaltyPhone()"
                  (input)="onLoyaltyPhoneInput($event)"
                  [disabled]="isSubmitting()"
                />
              }
              @if (isLookingUpLoyalty()) {
                <div class="d-flex align-items-center gap-2 mb-2">
                  <span class="spinner-border spinner-border-sm"></span>
                  <span class="text-muted small">Looking up loyalty account...</span>
                </div>
              }
              @if (loyaltyProfile(); as profile) {
                <div class="loyalty-profile">
                  <div class="d-flex align-items-center gap-2 mb-2">
                    <span class="tier-badge" [style.background-color]="tierColor()">
                      {{ tierLabel() }}
                    </span>
                    <span class="fw-semibold">{{ profile.points }} pts</span>
                  </div>
                  <div class="small text-muted mb-2">
                    Earn ~{{ estimatedPointsEarned() }} points on this order
                  </div>
                  <div class="redeem-section">
                    <label class="form-label small mb-1">Redeem Points</label>
                    <div class="d-flex align-items-center gap-2">
                      <input
                        type="number"
                        class="form-control form-control-sm redeem-input"
                        [value]="pointsToRedeem()"
                        (input)="onPointsToRedeemInput($event)"
                        [disabled]="isSubmitting()"
                        min="0"
                        [max]="profile.points"
                      />
                      <span class="small text-muted">of {{ profile.points }}</span>
                      @if (pointsToRedeem() > 0) {
                        <button
                          type="button"
                          class="btn btn-sm btn-outline-light"
                          (click)="clearRedemption()"
                        >
                          Clear
                        </button>
                      }
                    </div>
                    @if (loyaltyDiscount() > 0) {
                      <div class="small text-success mt-1">
                        -{{ loyaltyDiscount() | currency }} discount applied
                      </div>
                    }
                  </div>
                  @if (availableRewards().length > 0) {
                    <div class="rewards-list mt-2">
                      <div class="small fw-semibold mb-1">Available Rewards</div>
                      @for (reward of availableRewards(); track reward.id) {
                        <button
                          type="button"
                          class="btn btn-sm btn-outline-light w-100 text-start mb-1 d-flex justify-content-between"
                          (click)="redeemReward(reward)"
                          [disabled]="isSubmitting()"
                        >
                          <span>{{ reward.name }}</span>
                          <span class="text-muted">{{ reward.pointsCost }} pts</span>
                        </button>
                      }
                    </div>
                  }
                </div>
              } @else if (!isLookingUpLoyalty()) {
                <div class="small text-muted">
                  @if (loyaltyLookupDone()) {
                    No loyalty account found for this phone
                  } @else {
                    Enter phone to look up loyalty account
                  }
                </div>
              }
            </div>
          }

          <!-- Gift Card -->
          <div class="form-section">
            <div class="section-title">Gift Card</div>
            @if (!giftCardApplied()) {
              <div class="d-flex gap-2">
                <input
                  type="text"
                  class="form-control form-control-sm"
                  placeholder="Enter gift card code"
                  [value]="giftCardCode()"
                  (input)="onGiftCardCodeInput($event)"
                  (keydown.enter)="lookupGiftCard()"
                  [disabled]="isSubmitting()"
                />
                <button type="button" class="btn btn-sm btn-outline-light" (click)="lookupGiftCard()"
                  [disabled]="!giftCardCode().trim() || isCheckingGiftCard()">
                  @if (isCheckingGiftCard()) {
                    <span class="spinner-border spinner-border-sm"></span>
                  } @else {
                    Check
                  }
                </button>
              </div>
              @if (giftCardBalance(); as gc) {
                <div class="gift-card-found mt-2 p-2">
                  <div class="d-flex justify-content-between align-items-center">
                    <span class="small text-success">Balance: {{ gc.currentBalance | currency }}</span>
                    <button type="button" class="btn btn-sm btn-success" (click)="applyGiftCard()">
                      Apply {{ giftCardAmount() | currency }}
                    </button>
                  </div>
                </div>
              }
            } @else {
              <div class="gift-card-applied p-2 d-flex justify-content-between align-items-center">
                <div>
                  <span class="text-success small fw-bold">Gift card applied</span>
                  <span class="text-success ms-2">-{{ giftCardDiscount() | currency }}</span>
                </div>
                <button type="button" class="btn btn-sm btn-outline-danger" (click)="clearGiftCard()">Remove</button>
              </div>
            }
          </div>

          <!-- Scheduled Orders: Promised Date -->
          @if (diningType() !== 'dine-in') {
            <div class="form-section">
              <div class="section-title">Schedule for Later</div>
              <input
                type="datetime-local"
                class="form-control"
                [value]="promisedDate()"
                (input)="onFieldInput('promisedDate', $event)"
                [disabled]="isSubmitting()"
              />
            </div>
          }

          <!-- Validation Summary -->
          @if (showValidation() && !validationResult().valid) {
            <p class="text-danger small mb-3">Please fill in all required fields</p>
          }

          <!-- Clear Cart -->
          <button
            type="button"
            class="btn btn-outline-danger btn-sm w-100 mb-3"
            (click)="clearCart()"
          >
            Clear Order
          </button>
        }
      </div>

      @if (!isEmpty()) {
        <div class="card-footer">
          <button
            type="button"
            class="btn btn-success btn-lg w-100"
            [disabled]="!canSubmit()"
            (click)="submitOrder()"
          >
            @if (isSubmitting()) {
              <span class="spinner-border spinner-border-sm me-2"></span>
              Sending...
            } @else {
              @if (diningType() === 'dine-in') {
                Send to Kitchen
              } @else {
                Place Order
              }
            }
          </button>
        </div>
      }
    }

    <!-- STEP 2: PAYMENT -->
    @if (paymentStep() === 'paying') {
      <div class="card-body">
        @if (paymentError()) {
          <div class="alert alert-danger mb-3">{{ paymentError() }}</div>
        }

        <div class="payment-summary mb-3">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <span class="text-muted small">Order</span>
            <span class="fw-semibold">{{ orderNumber() }}</span>
          </div>
          <div class="d-flex justify-content-between align-items-center">
            <span class="text-muted small">Total</span>
            <span class="fw-bold total-amount">{{ total() | currency }}</span>
          </div>
        </div>

        <!-- Payment UI Mount Point -->
        <div class="payment-container mb-3">
          <div #stripeMount class="payment-element"></div>
          @if (!paymentUIReady()) {
            <div class="d-flex justify-content-center p-3">
              <span class="spinner-border spinner-border-sm me-2"></span>
              <span class="text-muted small">Loading payment form...</span>
            </div>
          }
        </div>
      </div>

      <div class="card-footer d-flex gap-2">
        <button
          type="button"
          class="btn btn-outline-light flex-grow-1"
          [disabled]="isProcessingPayment()"
          (click)="cancelPayment()"
        >
          Cancel
        </button>
        @if (needsExplicitConfirm()) {
          <button
            type="button"
            class="btn btn-success flex-grow-1"
            [disabled]="isProcessingPayment() || !paymentUIReady()"
            (click)="confirmPayment()"
          >
            @if (isProcessingPayment()) {
              <span class="spinner-border spinner-border-sm me-2"></span>
              Processing...
            } @else {
              Pay {{ total() | currency }}
            }
          </button>
        }
      </div>
    }

    <!-- STEP 3: FAILED -->
    @if (paymentStep() === 'failed') {
      <div class="card-body text-center py-4">
        <div class="failed-icon mb-3">&#10007;</div>
        <h5 class="mb-2">Payment Failed</h5>
        @if (paymentError()) {
          <p class="text-danger small mb-3">{{ paymentError() }}</p>
        }
        <p class="text-muted small mb-0">Order {{ orderNumber() }} was created but payment was not completed.</p>
      </div>

      <div class="card-footer d-flex gap-2">
        <button
          type="button"
          class="btn btn-outline-light flex-grow-1"
          (click)="cancelPayment()"
        >
          Cancel Order
        </button>
        <button
          type="button"
          class="btn btn-primary flex-grow-1"
          (click)="retryPayment()"
        >
          Retry Payment
        </button>
      </div>
    }
  </div>
}
