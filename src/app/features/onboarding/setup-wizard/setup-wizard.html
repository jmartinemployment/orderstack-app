<div class="setup-wizard" [class.wide-step]="currentStep() === 4">
  <!-- Brand + Progress -->
  <div class="wizard-brand">
    <i class="bi bi-stack"></i> OrderStack
  </div>
  <div class="wizard-header">
    <div class="progress-bar-container">
      <div class="progress-bar-fill" [style.width.%]="progressPercent()"></div>
    </div>
    <div class="step-label">
      <span>Step {{ currentStep() }} of {{ totalSteps }}</span>
      <span>{{ progressPercent() }}% complete</span>
    </div>
  </div>

  <div class="wizard-body">
    <!-- ============ STEP 1: Business Name + Address ============ -->
    @if (currentStep() === 1) {
      <div class="step-content welcome-step">
        <h2>Welcome to OrderStack!</h2>
        <p class="step-subtitle">Let's shape this thing to fit your business.</p>

        <div class="form-group">
          <label for="businessName">Your business name</label>
          <input
            id="businessName"
            type="text"
            class="form-control"
            placeholder="e.g. Taipa Kitchen"
            [ngModel]="_businessName()"
            (ngModelChange)="_businessName.set($event)" />
          <p class="field-hint">This is how we'll identify you on emails, receipts, and messages to your customers.</p>
        </div>

        <div class="address-section">
          <label>Business address</label>
          <input
            type="text"
            class="form-control"
            placeholder="Street address"
            [ngModel]="_businessAddress()"
            (ngModelChange)="_businessAddress.set($event)"
            [disabled]="_noPhysicalAddress()" />

          <div class="no-address-check">
            <input
              type="checkbox"
              id="noAddress"
              class="form-check-input"
              [ngModel]="_noPhysicalAddress()"
              (ngModelChange)="_noPhysicalAddress.set($event)" />
            <label for="noAddress" class="form-check-label">I don't have a permanent business address</label>
          </div>
        </div>
      </div>
    }

    <!-- ============ STEP 2: Business Type ============ -->
    @if (currentStep() === 2) {
      <div class="step-content">
        <h2>What kind of business best describes <strong>{{ _businessName() || 'your business' }}</strong>?</h2>
        <p class="step-subtitle">This helps us set up the right features for you.</p>

        <div class="business-type-search">
          <i class="bi bi-search search-icon"></i>
          <input
            type="text"
            class="form-control search-input"
            placeholder="Search business types..."
            [ngModel]="_businessTypeSearch()"
            (ngModelChange)="_businessTypeSearch.set($event)" />
        </div>

        <div class="business-type-list">
          @for (type of filteredBusinessTypes(); track type.name) {
            <button
              type="button"
              class="business-type-item"
              [class.selected]="_selectedBusinessType()?.name === type.name"
              (click)="selectBusinessType(type)">
              <div class="bt-info">
                <span class="bt-name">{{ type.name }}</span>
                <span class="bt-vertical">{{ getVerticalLabel(type.vertical) }}</span>
              </div>
              @if (_selectedBusinessType()?.name === type.name) {
                <i class="bi bi-check-circle-fill bt-check"></i>
              }
            </button>
          }
          @if (filteredBusinessTypes().length === 0) {
            <div class="bt-empty">
              <p>No results for "{{ _businessTypeSearch() }}"</p>
            </div>
          }
        </div>
      </div>
    }

    <!-- ============ STEP 3: Annual Revenue ============ -->
    @if (currentStep() === 3) {
      <div class="step-content">
        <h2>What's your annual revenue?</h2>
        <p class="step-subtitle">This helps us recommend the right plan and features. No judgment — we serve businesses of all sizes.</p>

        <div class="revenue-cards">
          @for (range of revenueRanges; track range.id) {
            <button
              type="button"
              class="revenue-card"
              [class.selected]="_selectedRevenue() === range.id"
              (click)="selectRevenue(range.id)">
              <span class="revenue-label">{{ range.label }}</span>
              <span class="revenue-desc">{{ range.description }}</span>
              @if (_selectedRevenue() === range.id) {
                <i class="bi bi-check-circle-fill revenue-check"></i>
              }
            </button>
          }
        </div>

        @if (_submitError()) {
          <div class="alert alert-danger mt-3">{{ _submitError() }}</div>
        }
      </div>
    }

    <!-- ============ STEP 4: Choose Plan + Connect Payments ============ -->
    @if (currentStep() === 4) {
      <div class="step-content plan-step">
        <h2>Choose your plan and connect payments</h2>
        <p class="step-subtitle">Pick a plan, then connect a payment processor to start accepting payments.</p>

        <!-- Billing interval toggle -->
        <div class="plan-toggles">
          <div class="toggle-group">
            <button
              type="button"
              class="toggle-btn"
              [class.active]="_billingInterval() === 'month'"
              (click)="setBillingInterval('month')">
              Monthly
            </button>
            <button
              type="button"
              class="toggle-btn"
              [class.active]="_billingInterval() === 'year'"
              (click)="setBillingInterval('year')">
              Annual
              <span class="savings-badge">Save {{ annualSavingsPercent() }}%</span>
            </button>
          </div>
        </div>

        <!-- Tier cards -->
        <div class="tier-cards">
          @for (tier of planTiers; track tier.key) {
            <button
              type="button"
              class="tier-card"
              [class.highlighted]="tier.highlighted"
              [class.selected]="_selectedTier() === tier.key"
              (click)="selectTier(tier.key)">

              @if (tier.highlighted && _selectedTier() !== tier.key) {
                <div class="popular-badge">Most Popular</div>
              }
              @if (_selectedTier() === tier.key) {
                <div class="selected-badge">
                  <i class="bi bi-check-circle-fill"></i> Selected
                </div>
              }

              <h4 class="tier-name">{{ tier.name }}</h4>
              <div class="tier-price">
                <span class="price-amount">{{ formatPrice(tier) }}</span>
                @if (tier.monthlyPriceCents > 0) {
                  <span class="price-period">/mo</span>
                  <span class="price-note">per location</span>
                }
              </div>

              <div class="tier-rates">
                <div class="rate-row">
                  <span class="rate-label">In-person</span>
                  <span class="rate-value">{{ tier.processingRates.inPerson }}</span>
                </div>
                <div class="rate-row">
                  <span class="rate-label">Online</span>
                  <span class="rate-value">{{ tier.processingRates.online }}</span>
                </div>
                <div class="rate-row">
                  <span class="rate-label">Keyed-in</span>
                  <span class="rate-value">{{ tier.processingRates.keyedIn }}</span>
                </div>
              </div>

              <ul class="tier-features">
                @for (feature of tier.features; track feature) {
                  <li>
                    <i class="bi bi-check2"></i>
                    <span>{{ feature }}</span>
                  </li>
                }
              </ul>
            </button>
          }
        </div>

        <!-- Payment Processor Connect -->
        <div class="connect-section">
          <h3 class="connect-heading">Connect a payment processor</h3>
          <p class="connect-subtitle">Choose Stripe or PayPal to accept payments. Same rates regardless of processor.</p>

          <div class="connect-cards">
            <!-- Stripe -->
            <div class="connect-card" [class.connected]="paymentConnect.stripeStatus() === 'connected'">
              <div class="connect-card-header">
                <i class="bi bi-stripe connect-logo stripe-logo"></i>
                <span class="connect-name">Stripe</span>
                @if (paymentConnect.stripeStatus() === 'connected') {
                  <span class="connect-status connected"><i class="bi bi-check-circle-fill"></i> Connected</span>
                }
              </div>
              <p class="connect-desc">Accept credit cards, debit cards, Apple Pay, and Google Pay.</p>
              @if (paymentConnect.stripeStatus() !== 'connected') {
                <button
                  type="button"
                  class="btn btn-connect"
                  [disabled]="paymentConnect.isConnecting() || paymentConnect.paypalStatus() === 'connected'"
                  (click)="connectStripe()">
                  @if (paymentConnect.isConnecting() && paymentConnect.stripeStatus() === 'pending') {
                    <i class="bi bi-arrow-repeat spin"></i> Connecting...
                  } @else {
                    Connect Stripe
                  }
                </button>
              }
            </div>

            <!-- PayPal -->
            <div class="connect-card" [class.connected]="paymentConnect.paypalStatus() === 'connected'">
              <div class="connect-card-header">
                <i class="bi bi-paypal connect-logo paypal-logo"></i>
                <span class="connect-name">PayPal</span>
                @if (paymentConnect.paypalStatus() === 'connected') {
                  <span class="connect-status connected"><i class="bi bi-check-circle-fill"></i> Connected</span>
                }
              </div>
              <p class="connect-desc">Accept PayPal, Venmo, Pay Later, and credit/debit cards.</p>
              @if (paymentConnect.paypalStatus() !== 'connected') {
                <button
                  type="button"
                  class="btn btn-connect"
                  [disabled]="paymentConnect.isConnecting() || paymentConnect.stripeStatus() === 'connected'"
                  (click)="connectPayPal()">
                  @if (paymentConnect.isConnecting() && paymentConnect.paypalStatus() === 'pending') {
                    <i class="bi bi-arrow-repeat spin"></i> Connecting...
                  } @else {
                    Connect PayPal
                  }
                </button>
              }
            </div>
          </div>

          @if (paymentConnect.error()) {
            <div class="alert alert-danger mt-3">{{ paymentConnect.error() }}</div>
          }
        </div>
      </div>
    }

    <!-- ============ STEP 5: Recommended Hardware ============ -->
    @if (currentStep() === 5) {
      <div class="step-content hardware-step">
        <h2>Recommended hardware for {{ _businessName() || 'your business' }}</h2>
        <p class="step-subtitle">OrderStack works on devices you already own. Here's what we recommend to get the most out of your setup.</p>

        <!-- Essential hardware -->
        @if (essentialHardware().length > 0) {
          <div class="hw-section">
            <h3 class="hw-section-title">
              <i class="bi bi-star-fill hw-star"></i> Essentials
            </h3>
            <div class="hw-grid">
              @for (hw of essentialHardware(); track hw.id) {
                <div class="hw-card essential">
                  <div class="hw-icon-box">
                    <i class="bi {{ hw.icon }}"></i>
                  </div>
                  <div class="hw-details">
                    <span class="hw-category">{{ hw.category }}</span>
                    <h4 class="hw-name">{{ hw.name }}</h4>
                    <p class="hw-desc">{{ hw.description }}</p>
                    <div class="hw-reason">
                      <i class="bi bi-lightbulb"></i>
                      <span>{{ hw.reason }}</span>
                    </div>
                    <span class="hw-price">{{ hw.priceRange }}</span>
                  </div>
                </div>
              }
            </div>
          </div>
        }

        <!-- Optional hardware -->
        @if (optionalHardware().length > 0) {
          <div class="hw-section">
            <h3 class="hw-section-title">Also recommended</h3>
            <div class="hw-grid">
              @for (hw of optionalHardware(); track hw.id) {
                <div class="hw-card">
                  <div class="hw-icon-box">
                    <i class="bi {{ hw.icon }}"></i>
                  </div>
                  <div class="hw-details">
                    <span class="hw-category">{{ hw.category }}</span>
                    <h4 class="hw-name">{{ hw.name }}</h4>
                    <p class="hw-desc">{{ hw.description }}</p>
                    <div class="hw-reason">
                      <i class="bi bi-lightbulb"></i>
                      <span>{{ hw.reason }}</span>
                    </div>
                    <span class="hw-price">{{ hw.priceRange }}</span>
                  </div>
                </div>
              }
            </div>
          </div>
        }

        <p class="hw-note">
          <i class="bi bi-info-circle"></i>
          You don't need any of this to get started — OrderStack works in any browser. You can set up hardware anytime from Settings.
        </p>
      </div>
    }

    <!-- ============ STEP 6: You're All Set ============ -->
    @if (currentStep() === 6) {
      <div class="step-content welcome-screen">
        <div class="welcome-hero">
          <div class="welcome-icon">
            <i class="bi bi-rocket-takeoff-fill"></i>
          </div>
          <h2>You're all set, {{ _businessName() || 'friend' }}!</h2>
          <p class="step-subtitle">Your account is ready. Head to your dashboard to add items, invite team members, and start selling.</p>
        </div>

        <!-- PWA Install Prompt -->
        @if (pwaInstall.canInstall() && !pwaInstall.isInstalled()) {
          <div class="install-prompt">
            <div class="install-icon">
              <i class="bi bi-phone"></i>
            </div>
            <div class="install-info">
              <strong>Install OrderStack</strong>
              <span>Get the app for a faster, native experience.</span>
            </div>
            <button type="button" class="btn btn-install" (click)="installApp()">
              Install
            </button>
          </div>
        }

        @if (pwaInstall.isIos && !pwaInstall.isInstalled()) {
          <div class="install-prompt ios-prompt">
            <div class="install-icon">
              <i class="bi bi-phone"></i>
            </div>
            <div class="install-info">
              <strong>Add to Home Screen</strong>
              <span>Tap <i class="bi bi-box-arrow-up"></i> then "Add to Home Screen" for the best experience.</span>
            </div>
          </div>
        }

        <div class="welcome-actions">
          <button
            type="button"
            class="btn btn-primary btn-lg welcome-cta"
            (click)="goToDashboard()">
            Go to Dashboard <i class="bi bi-arrow-right"></i>
          </button>
        </div>
      </div>
    }
  </div>

  <!-- Navigation Footer (Steps 1-5 only) -->
  @if (currentStep() < 6) {
    <div class="wizard-footer">
      @if (currentStep() > 1) {
        <button class="btn btn-outline" (click)="prev()">
          <i class="bi bi-arrow-left"></i> Back
        </button>
      } @else {
        <span></span>
      }

      @if (currentStep() === 4) {
        <!-- Step 4: skip link + continue -->
        <div class="footer-right">
          @if (!isProcessorConnected()) {
            <button class="btn btn-skip" (click)="next()">
              I'll do this later
            </button>
          }
          <button
            class="btn btn-primary"
            (click)="next()">
            Continue <i class="bi bi-arrow-right"></i>
          </button>
        </div>
      } @else {
        <button
          class="btn btn-primary"
          [disabled]="!canProceed() || _isSubmitting()"
          (click)="next()">
          @if (_isSubmitting()) {
            <i class="bi bi-arrow-repeat spin"></i> Setting up...
          } @else {
            Continue <i class="bi bi-arrow-right"></i>
          }
        </button>
      }
    </div>
  }
</div>
