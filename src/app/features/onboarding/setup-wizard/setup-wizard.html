<div class="setup-wizard" [class.wide-step]="isPlanStep() || isHardwareStep()">
  <!-- Brand + Progress -->
  <div class="wizard-brand">
    <i class="bi bi-stack"></i> OrderStack
  </div>
  <div class="wizard-header">
    <div class="progress-bar-container">
      <div class="progress-bar-fill" [style.width.%]="progressPercent()"></div>
    </div>
    <div class="step-label">
      <span>Step {{ currentStep() }} of {{ totalSteps() }}</span>
      <span>{{ progressPercent() }}% complete</span>
    </div>
  </div>

  <div class="wizard-body">
    <!-- ============ STEP 1: Business Name + Addresses ============ -->
    @if (currentStep() === 1) {
      <div class="step-content welcome-step">
        <h2>Welcome to OrderStack!</h2>
        <p class="step-subtitle">Let's shape this thing to fit your business.</p>

        <div class="form-group">
          <label for="businessName">Your business name</label>
          <input
            id="businessName"
            type="text"
            class="form-control"
            placeholder="e.g. Taipa Kitchen"
            [ngModel]="_businessName()"
            (ngModelChange)="_businessName.set($event)" />
          <p class="field-hint">This is how we'll identify you on emails, receipts, and messages to your customers.</p>
        </div>

        <!-- Home Address -->
        <div class="address-section">
          <label class="section-label">Your home address</label>
          <p class="section-hint">Used for billing and account verification</p>

          <input
            type="text"
            class="form-control"
            placeholder="Street address (e.g. 123 Main St)"
            [ngModel]="_homeStreet()"
            (ngModelChange)="_homeStreet.set($event)" />
          <input
            type="text"
            class="form-control mt-field"
            placeholder="Apt, suite, etc. (optional)"
            [ngModel]="_homeStreet2()"
            (ngModelChange)="_homeStreet2.set($event)" />
          <div class="address-row">
            <input
              type="text"
              class="form-control"
              placeholder="City"
              [ngModel]="_homeCity()"
              (ngModelChange)="_homeCity.set($event)" />
            <select
              class="form-control state-select"
              [ngModel]="_homeState()"
              (ngModelChange)="_homeState.set($event)"
              aria-label="State">
              <option value="" disabled>State</option>
              @for (state of usStates; track state.code) {
                <option [value]="state.code">{{ state.code }}</option>
              }
            </select>
            <input
              type="text"
              class="form-control zip-input"
              placeholder="ZIP"
              maxlength="10"
              [ngModel]="_homeZip()"
              (ngModelChange)="_homeZip.set($event)" />
          </div>
        </div>

        <!-- Business Address -->
        <div class="address-section">
          <label class="section-label">Business address</label>
          <p class="section-hint">Where customers can find you</p>

          <div class="checkbox-row">
            <input
              type="checkbox"
              id="noPhysical"
              class="form-check-input"
              [checked]="_bizNoPhysical()"
              (change)="toggleNoPhysical()" />
            <label for="noPhysical" class="form-check-label">I don't have a physical business location</label>
          </div>

          @if (!_bizNoPhysical()) {
            <div class="biz-address-fields">
              <input
                type="text"
                class="form-control"
                placeholder="Street address (e.g. 456 Oak Ave)"
                [ngModel]="_bizStreet()"
                (ngModelChange)="_bizStreet.set($event)" />
              <input
                type="text"
                class="form-control mt-field"
                placeholder="Apt, suite, etc. (optional)"
                [ngModel]="_bizStreet2()"
                (ngModelChange)="_bizStreet2.set($event)" />
              <div class="address-row">
                <input
                  type="text"
                  class="form-control"
                  placeholder="City"
                  [ngModel]="_bizCity()"
                  (ngModelChange)="_bizCity.set($event)" />
                <select
                  class="form-control state-select"
                  [ngModel]="_bizState()"
                  (ngModelChange)="_bizState.set($event)"
                  aria-label="Business state">
                  <option value="" disabled>State</option>
                  @for (state of usStates; track state.code) {
                    <option [value]="state.code">{{ state.code }}</option>
                  }
                </select>
                <input
                  type="text"
                  class="form-control zip-input"
                  placeholder="ZIP"
                  maxlength="10"
                  [ngModel]="_bizZip()"
                  (ngModelChange)="_bizZip.set($event)" />
              </div>
            </div>
          }
        </div>
      </div>
    }

    <!-- ============ STEP 2: Business Type ============ -->
    @if (currentStep() === 2) {
      <div class="step-content">
        <h2>What kind of business best describes <strong>{{ _businessName() || 'your business' }}</strong>?</h2>
        <p class="step-subtitle">This helps us set up the right features for you.</p>

        <div class="business-type-search">
          <i class="bi bi-search search-icon"></i>
          <input
            type="text"
            class="form-control search-input"
            placeholder="Search business types..."
            [ngModel]="_businessTypeSearch()"
            (ngModelChange)="_businessTypeSearch.set($event)" />
        </div>

        <div class="business-type-list">
          @for (type of filteredBusinessTypes(); track type.name) {
            <button
              type="button"
              class="business-type-item"
              [class.selected]="_selectedBusinessType()?.name === type.name"
              (click)="selectBusinessType(type)">
              <div class="bt-info">
                <span class="bt-name">{{ type.name }}</span>
                <span class="bt-vertical">{{ getVerticalLabel(type.vertical) }}</span>
              </div>
              @if (_selectedBusinessType()?.name === type.name) {
                <i class="bi bi-check-circle-fill bt-check"></i>
              }
            </button>
          }
          @if (filteredBusinessTypes().length === 0) {
            <div class="bt-empty">
              <p>No results for "{{ _businessTypeSearch() }}"</p>
            </div>
          }
        </div>
      </div>
    }

    <!-- ============ CUISINE STEP (food_and_drink only) ============ -->
    @if (isCuisineStep()) {
      <div class="step-content">
        <h2>Tell us what you serve</h2>
        <p class="step-subtitle">Choose your cuisine to get a customized menu of items. This will help you build your catalog faster.</p>
        <p class="step-subtitle-secondary">If you don't see your cuisine, try creating new items manually.</p>

        <div class="cuisine-search">
          <label class="cuisine-label">Cuisine</label>
          <input
            type="text"
            class="form-control"
            placeholder="Search cuisines..."
            [ngModel]="_cuisineSearch()"
            (ngModelChange)="_cuisineSearch.set($event)" />
        </div>

        <div class="cuisine-list">
          @for (cuisine of filteredCuisines(); track cuisine) {
            <button
              type="button"
              class="cuisine-item"
              [class.selected]="_selectedCuisine() === cuisine"
              (click)="selectCuisine(cuisine)">
              <span>{{ cuisine }}</span>
              @if (_selectedCuisine() === cuisine) {
                <i class="bi bi-check-circle-fill cuisine-check"></i>
              }
            </button>
          }
          @if (filteredCuisines().length === 0) {
            <div class="bt-empty">
              <p>No results for "{{ _cuisineSearch() }}"</p>
            </div>
          }
        </div>
      </div>
    }

    <!-- ============ REVENUE STEP ============ -->
    @if (isRevenueStep()) {
      <div class="step-content">
        <h2>What's your annual revenue?</h2>
        <p class="step-subtitle">This helps us recommend the right plan and features. No judgment — we serve businesses of all sizes.</p>

        <div class="revenue-cards">
          @for (range of revenueRanges; track range.id) {
            <button
              type="button"
              class="revenue-card"
              [class.selected]="_selectedRevenue() === range.id"
              (click)="selectRevenue(range.id)">
              <span class="revenue-label">{{ range.label }}</span>
              <span class="revenue-desc">{{ range.description }}</span>
              @if (_selectedRevenue() === range.id) {
                <i class="bi bi-check-circle-fill revenue-check"></i>
              }
            </button>
          }
        </div>

        @if (_submitError()) {
          <div class="alert alert-danger mt-3">{{ _submitError() }}</div>
        }
      </div>
    }

    <!-- ============ MULTIPLE LOCATIONS STEP ============ -->
    @if (isLocationsStep()) {
      <div class="step-content">
        <h2>Do you have more than one location?</h2>
        <p class="step-subtitle">We'll set up multi-location management if you need it. You can always add locations later.</p>

        <div class="location-cards">
          <button
            type="button"
            class="location-card"
            [class.selected]="!_hasMultipleLocations()"
            (click)="selectSingleLocation()">
            <div class="location-card-icon">
              <i class="bi bi-building"></i>
            </div>
            <div class="location-card-info">
              <span class="location-card-title">Just one location</span>
              <span class="location-card-desc">I operate from a single address</span>
            </div>
            @if (!_hasMultipleLocations()) {
              <i class="bi bi-check-circle-fill location-check"></i>
            }
          </button>

          <button
            type="button"
            class="location-card"
            [class.selected]="_hasMultipleLocations()"
            (click)="selectMultipleLocations()">
            <div class="location-card-icon multi">
              <i class="bi bi-buildings"></i>
            </div>
            <div class="location-card-info">
              <span class="location-card-title">Multiple locations</span>
              <span class="location-card-desc">I have or plan to open more than one location</span>
            </div>
            @if (_hasMultipleLocations()) {
              <i class="bi bi-check-circle-fill location-check"></i>
            }
          </button>
        </div>

        @if (_hasMultipleLocations()) {
          <div class="location-count-section">
            <label for="locationCount" class="location-count-label">How many locations do you have?</label>
            <input
              id="locationCount"
              type="number"
              class="form-control location-count-input"
              min="2"
              max="500"
              [ngModel]="_locationCount()"
              (ngModelChange)="_locationCount.set($event)" />
            <p class="field-hint">You can add the details for each location after setup.</p>
          </div>
        }
      </div>
    }

    <!-- ============ DELIVERY PROVIDERS STEP (food_and_drink only) ============ -->
    @if (isDeliveryStep()) {
      <div class="step-content">
        <h2>Do you use any delivery services?</h2>
        <p class="step-subtitle">Connect your delivery marketplace accounts to receive orders directly in OrderStack.</p>

        <div class="delivery-providers">
          @for (provider of deliveryProviders; track provider.id) {
            <div class="delivery-provider-card" [class.enabled]="isProviderEnabled(provider.id)">
              <div class="delivery-provider-header" (click)="toggleProvider(provider.id)">
                <div class="delivery-provider-brand">
                  <div class="delivery-provider-icon" [style.background-color]="provider.color">
                    <i class="bi" [class]="provider.icon"></i>
                  </div>
                  <span class="delivery-provider-name">{{ provider.name }}</span>
                </div>
                <div class="delivery-toggle">
                  <div class="toggle-track" [class.active]="isProviderEnabled(provider.id)">
                    <div class="toggle-thumb"></div>
                  </div>
                </div>
              </div>

              @if (isProviderEnabled(provider.id)) {
                <div class="delivery-provider-fields">
                  @for (field of provider.fields; track field.key) {
                    <div class="delivery-field">
                      <label [for]="provider.id + '-' + field.key">{{ field.label }}</label>
                      <input
                        [id]="provider.id + '-' + field.key"
                        [type]="field.type"
                        class="form-control"
                        [placeholder]="field.placeholder"
                        [ngModel]="getProviderCredential(provider.id, field.key)"
                        (ngModelChange)="setProviderCredential(provider.id, field.key, $event)" />
                    </div>
                  }
                  <p class="field-hint">
                    <i class="bi bi-shield-lock"></i>
                    Credentials are encrypted and stored securely.
                  </p>
                </div>
              }
            </div>
          }
        </div>
      </div>
    }

    <!-- ============ PLAN + PROCESSOR STEP ============ -->
    @if (isPlanStep()) {
      <div class="step-content plan-step">
        <h2>Choose your plan</h2>
        <p class="step-subtitle">All plans include unlimited transactions. Upgrade anytime.</p>

        <!-- Processor toggle -->
        <div class="plan-toggles">
          <div class="toggle-group">
            <button
              type="button"
              class="toggle-btn"
              [class.active]="_selectedProcessor() === 'stripe'"
              (click)="selectProcessor('stripe')">
              <i class="bi bi-stripe"></i> Stripe
            </button>
            <button
              type="button"
              class="toggle-btn"
              [class.active]="_selectedProcessor() === 'paypal'"
              (click)="selectProcessor('paypal')">
              <i class="bi bi-paypal"></i> PayPal
            </button>
          </div>
          <span class="toggle-hint">Rates vary by processor</span>
        </div>

        <!-- Tier cards -->
        <div class="tier-cards">
          @for (tier of planTiers; track tier.key; let i = $index) {
            <button
              type="button"
              class="tier-card"
              [class.highlighted]="tier.highlighted"
              [class.selected]="_selectedTier() === tier.key"
              (click)="selectTier(tier.key)">

              @if (tier.highlighted && _selectedTier() !== tier.key) {
                <div class="popular-badge">Most Popular</div>
              }
              @if (_selectedTier() === tier.key) {
                <div class="selected-badge">
                  <i class="bi bi-check-circle-fill"></i> Selected
                </div>
              }

              <h4 class="tier-name">{{ tier.name }}</h4>
              <div class="tier-price">
                <span class="price-amount">{{ formatPrice(tier) }}</span>
                @if (tier.monthlyPriceCents > 0) {
                  <span class="price-period">/mo</span>
                  <span class="price-note">per location</span>
                }
              </div>

              <div class="tier-rates">
                <div class="rate-row">
                  <span class="rate-label">In-person</span>
                  <span class="rate-value">{{ getRatesForTier(i).inPerson }}</span>
                </div>
                <div class="rate-row">
                  <span class="rate-label">Online</span>
                  <span class="rate-value">{{ getRatesForTier(i).online }}</span>
                </div>
                <div class="rate-row">
                  <span class="rate-label">Keyed-in</span>
                  <span class="rate-value">{{ getRatesForTier(i).keyedIn }}</span>
                </div>
              </div>

              <ul class="tier-features">
                @for (feature of tier.features; track feature) {
                  <li>
                    <i class="bi bi-check2"></i>
                    <span>{{ feature }}</span>
                  </li>
                }
              </ul>
            </button>
          }
        </div>

        @if (paymentConnect.error()) {
          <div class="alert alert-danger mt-3">{{ paymentConnect.error() }}</div>
        }
      </div>
    }

    <!-- ============ HARDWARE STEP ============ -->
    @if (isHardwareStep()) {
      <div class="step-content hardware-step">
        <h2>Recommended hardware for {{ _businessName() || 'your business' }}</h2>
        <p class="step-subtitle">OrderStack works on devices you already own. Here's what we recommend to get the most out of your setup.</p>

        <!-- Essential hardware -->
        @if (essentialHardware().length > 0) {
          <div class="hw-section">
            <h3 class="hw-section-title">
              <i class="bi bi-star-fill hw-star"></i> Essentials
            </h3>
            <div class="hw-grid">
              @for (hw of essentialHardware(); track hw.id) {
                <div class="hw-card essential">
                  <div class="hw-image">
                    <img [src]="hw.imageUrl" [alt]="hw.name" loading="lazy" />
                    <span class="hw-badge essential-badge">Essential</span>
                  </div>
                  <div class="hw-details">
                    <span class="hw-category">{{ hw.category }}</span>
                    <h4 class="hw-name">{{ hw.name }}</h4>
                    <p class="hw-desc">{{ hw.description }}</p>
                    <div class="hw-reason">
                      <i class="bi bi-lightbulb"></i>
                      <span>{{ hw.reason }}</span>
                    </div>
                    <div class="hw-footer">
                      <span class="hw-price">{{ hw.price }}</span>
                      <a [href]="hw.buyUrl" target="_blank" rel="noopener" class="hw-buy-link">
                        {{ hw.buyLabel }} <i class="bi bi-box-arrow-up-right"></i>
                      </a>
                    </div>
                  </div>
                </div>
              }
            </div>
          </div>
        }

        <!-- Optional hardware -->
        @if (optionalHardware().length > 0) {
          <div class="hw-section">
            <h3 class="hw-section-title">Also recommended</h3>
            <div class="hw-grid">
              @for (hw of optionalHardware(); track hw.id) {
                <div class="hw-card">
                  <div class="hw-image">
                    <img [src]="hw.imageUrl" [alt]="hw.name" loading="lazy" />
                  </div>
                  <div class="hw-details">
                    <span class="hw-category">{{ hw.category }}</span>
                    <h4 class="hw-name">{{ hw.name }}</h4>
                    <p class="hw-desc">{{ hw.description }}</p>
                    <div class="hw-reason">
                      <i class="bi bi-lightbulb"></i>
                      <span>{{ hw.reason }}</span>
                    </div>
                    <div class="hw-footer">
                      <span class="hw-price">{{ hw.price }}</span>
                      <a [href]="hw.buyUrl" target="_blank" rel="noopener" class="hw-buy-link">
                        {{ hw.buyLabel }} <i class="bi bi-box-arrow-up-right"></i>
                      </a>
                    </div>
                  </div>
                </div>
              }
            </div>
          </div>
        }

        <p class="hw-note">
          <i class="bi bi-info-circle"></i>
          You don't need any of this to get started — OrderStack works in any browser. You can set up hardware anytime from Settings.
        </p>
      </div>
    }

    <!-- ============ DONE STEP: You're All Set ============ -->
    @if (isDoneStep()) {
      <div class="step-content welcome-screen">
        <div class="welcome-hero">
          <div class="welcome-icon">
            <i class="bi bi-rocket-takeoff-fill"></i>
          </div>
          <h2>You're all set, {{ _businessName() || 'friend' }}!</h2>
          <p class="step-subtitle">Your account is ready. Head to your dashboard to add items, invite team members, and start selling.</p>
        </div>

        <!-- PWA Install Prompt -->
        @if (pwaInstall.canInstall() && !pwaInstall.isInstalled()) {
          <div class="install-prompt">
            <div class="install-icon">
              <i class="bi bi-phone"></i>
            </div>
            <div class="install-info">
              <strong>Install OrderStack</strong>
              <span>Get the app for a faster, native experience.</span>
            </div>
            <button type="button" class="btn btn-install" (click)="installApp()">
              Install
            </button>
          </div>
        }

        @if (pwaInstall.isIos && !pwaInstall.isInstalled()) {
          <div class="install-prompt ios-prompt">
            <div class="install-icon">
              <i class="bi bi-phone"></i>
            </div>
            <div class="install-info">
              <strong>Add to Home Screen</strong>
              <span>Tap <i class="bi bi-box-arrow-up"></i> then "Add to Home Screen" for the best experience.</span>
            </div>
          </div>
        }

        <div class="welcome-actions">
          <button
            type="button"
            class="btn btn-primary btn-lg welcome-cta"
            (click)="goToDashboard()">
            Go to Dashboard <i class="bi bi-arrow-right"></i>
          </button>
        </div>
      </div>
    }
  </div>

  <!-- Navigation Footer (not on done step) -->
  @if (!isDoneStep()) {
    <div class="wizard-footer">
      @if (currentStep() > 1) {
        <button class="btn btn-outline" (click)="prev()">
          <i class="bi bi-arrow-left"></i> Back
        </button>
      } @else {
        <span></span>
      }

      @if (isPlanStep()) {
        <!-- Plan step: skip link + continue -->
        <div class="footer-right">
          <!-- TODO: Remove skip button before production launch — testing only -->
          @if (!isProcessorConnected()) {
            <button class="btn btn-skip" (click)="next()">
              Skip (testing only)
            </button>
          }
          <button
            class="btn btn-primary"
            [disabled]="paymentConnect.isConnecting()"
            (click)="isProcessorConnected() ? next() : connectProcessor()">
            @if (paymentConnect.isConnecting()) {
              <i class="bi bi-arrow-repeat spin"></i> Connecting...
            } @else if (isProcessorConnected()) {
              Continue <i class="bi bi-arrow-right"></i>
            } @else {
              Connect {{ _selectedProcessor() === 'stripe' ? 'Stripe' : 'PayPal' }} <i class="bi bi-arrow-right"></i>
            }
          </button>
        </div>
      } @else if (isCuisineStep()) {
        <!-- Cuisine step: manual + next -->
        <div class="footer-right">
          <button class="btn btn-outline" (click)="skipCuisine()">
            Create Items Manually
          </button>
          <button
            class="btn btn-primary"
            [disabled]="!_selectedCuisine()"
            (click)="next()">
            Next <i class="bi bi-arrow-right"></i>
          </button>
        </div>
      } @else if (isDeliveryStep()) {
        <!-- Delivery step: skip + continue -->
        <div class="footer-right">
          <button class="btn btn-skip" (click)="next()">
            I'll set this up later
          </button>
          <button
            class="btn btn-primary"
            (click)="next()">
            Continue <i class="bi bi-arrow-right"></i>
          </button>
        </div>
      } @else {
        <button
          class="btn btn-primary"
          [disabled]="!canProceed() || _isSubmitting()"
          (click)="next()">
          @if (_isSubmitting()) {
            <i class="bi bi-arrow-repeat spin"></i> Setting up...
          } @else {
            Continue <i class="bi bi-arrow-right"></i>
          }
        </button>
      }
    </div>
  }
</div>
