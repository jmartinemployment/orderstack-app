@if (isAuthenticated()) {
<div class="command-center">
  <!-- Header -->
  <div class="cc-header d-flex justify-content-between align-items-center mb-4">
    <div>
      <h2 class="h4 mb-0">AI Command Center</h2>
      <small class="text-muted">
        @if (lastRefresh()) {
          Updated {{ getRefreshTimeText() }}
        }
      </small>
    </div>
    <button
      type="button"
      class="btn btn-sm btn-outline-info"
      [disabled]="isLoading()"
      (click)="refresh()"
    >
      @if (isLoading()) {
        <span class="spinner-border spinner-border-sm me-1"></span>
        Refreshing...
      } @else {
        Refresh All
      }
    </button>
  </div>

  @if (error()) {
    <os-error-display
      [message]="error()!"
      [retryable]="true"
      (dismissed)="clearError()"
      (retry)="refresh()"
    />
  }

  <!-- Tabs -->
  <ul class="nav nav-pills cc-tabs mb-4">
    <li class="nav-item">
      <button
        type="button"
        class="nav-link"
        [class.active]="activeTab() === 'overview'"
        (click)="setTab('overview')"
      >Overview</button>
    </li>
    <li class="nav-item">
      <button
        type="button"
        class="nav-link"
        [class.active]="activeTab() === 'insights'"
        (click)="setTab('insights')"
      >
        AI Insights
        @if (proactiveInsightCount() > 0) {
          <span class="badge bg-warning text-dark ms-1">{{ proactiveInsightCount() }}</span>
        } @else if (unifiedInsights().length > 0) {
          <span class="badge bg-info ms-1">{{ unifiedInsights().length }}</span>
        }
      </button>
    </li>
    <li class="nav-item">
      <button
        type="button"
        class="nav-link"
        [class.active]="activeTab() === 'alerts'"
        (click)="setTab('alerts')"
      >
        Alerts
        @if (criticalAlertCount() > 0) {
          <span class="badge bg-danger ms-1">{{ criticalAlertCount() }}</span>
        }
      </button>
    </li>
    <li class="nav-item">
      <button
        type="button"
        class="nav-link"
        [class.active]="activeTab() === 'forecast'"
        (click)="setTab('forecast')"
      >
        Forecast
      </button>
    </li>
  </ul>

  <!-- Pinned Widgets (My Insights) -->
  @if (pinnedWidgets().length > 0) {
    <div class="pinned-section mb-4">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h5 class="panel-title mb-0">
          <i class="bi bi-pin-fill me-1"></i> My Insights
        </h5>
        <span class="badge bg-light text-dark">{{ pinnedWidgets().length }} pinned</span>
      </div>
      <div class="pinned-grid">
        @for (widget of pinnedWidgets(); track widget.id) {
          <div class="pinned-card" [class.pinned-small]="widget.size === 'small'" [class.pinned-medium]="widget.size === 'medium'" [class.pinned-large]="widget.size === 'large'">
            <div class="pinned-card-header">
              <span class="pinned-card-title">{{ widget.insightCard.title }}</span>
              <button class="btn-unpin" (click)="unpinWidget(widget.id)" title="Remove">
                <i class="bi bi-x-lg"></i>
              </button>
            </div>

            @if (widget.insightCard.responseType === 'kpi') {
              <div class="pinned-kpi">
                <span class="pinned-kpi-value">
                  @if (widget.insightCard.unit === '$') {
                    {{ widget.insightCard.value | currency }}
                  } @else if (widget.insightCard.unit === '%') {
                    {{ widget.insightCard.value | number:'1.1-1' }}%
                  } @else {
                    {{ widget.insightCard.value }}
                  }
                </span>
                @if (widget.insightCard.trend) {
                  <span class="pinned-trend" [class.up]="widget.insightCard.trend === 'up'" [class.down]="widget.insightCard.trend === 'down'">
                    <i class="bi" [class.bi-arrow-up]="widget.insightCard.trend === 'up'" [class.bi-arrow-down]="widget.insightCard.trend === 'down'"></i>
                  </span>
                }
              </div>
            }

            @if (widget.insightCard.responseType === 'text') {
              <div class="pinned-text">{{ getWidgetText(widget) }}</div>
            }

            @if (widget.insightCard.responseType === 'chart') {
              <div class="pinned-chart-preview">
                <i class="bi bi-bar-chart"></i>
                <span>Chart — {{ widget.insightCard.query }}</span>
              </div>
            }

            @if (widget.insightCard.responseType === 'table') {
              <div class="pinned-chart-preview">
                <i class="bi bi-table"></i>
                <span>Table — {{ widget.insightCard.query }}</span>
              </div>
            }
          </div>
        }
      </div>
    </div>
  }

  @if (isLoading()) {
    <div class="d-flex justify-content-center p-5">
      <os-loading-spinner message="Loading command center..." />
    </div>
  } @else {
    <!-- OVERVIEW TAB -->
    @if (activeTab() === 'overview') {
      <!-- KPI Cards -->
      <div class="kpi-grid mb-4">
        <div class="kpi-card">
          <span class="kpi-label">Today's Revenue</span>
          <span class="kpi-value">{{ todayRevenue() | currency }}</span>
          @if (revenueChange(); as change) {
            <span class="kpi-change" [class.positive]="change > 0" [class.negative]="change < 0">
              {{ change > 0 ? '+' : '' }}{{ change | number:'1.1-1' }}%
            </span>
          }
        </div>
        <div class="kpi-card">
          <span class="kpi-label">Orders Today</span>
          <span class="kpi-value">{{ todayOrders() }}</span>
          <span class="kpi-sub">{{ activeOrderCount() }} active</span>
        </div>
        <div class="kpi-card">
          <span class="kpi-label">Avg Order Value</span>
          <span class="kpi-value">{{ avgOrderValue() | currency }}</span>
        </div>
        <div class="kpi-card">
          <span class="kpi-label">Profit Margin</span>
          <span class="kpi-value">
            @if (avgProfitMargin() !== null) {
              {{ avgProfitMargin() | number:'1.1-1' }}%
            } @else {
              --
            }
          </span>
          @if (avgProfitMargin() !== null && avgProfitMargin()! < 30) {
            <span class="kpi-change negative">Below target</span>
          }
        </div>
        <div class="kpi-card" [class.kpi-alert]="criticalAlertCount() > 0">
          <span class="kpi-label">Active Alerts</span>
          <span class="kpi-value">{{ totalAlertCount() }}</span>
          @if (criticalAlertCount() > 0) {
            <span class="kpi-change negative">{{ criticalAlertCount() }} critical</span>
          }
        </div>
        <div class="kpi-card">
          <span class="kpi-label">Menu Health</span>
          <span class="kpi-value">{{ menuStars() }} Stars</span>
          @if (menuDogs() > 0) {
            <span class="kpi-change negative">{{ menuDogs() }} underperformers</span>
          }
        </div>
      </div>

      <div class="row g-3">
        <!-- Top Insights (left column) -->
        <div class="col-12 col-lg-7">
          <div class="cc-panel">
            <h5 class="panel-title">AI Recommendations</h5>
            @if (unifiedInsights().length === 0) {
              <p class="text-muted small">No insights available yet. Data is being analyzed.</p>
            } @else {
              @for (insight of unifiedInsights().slice(0, 6); track insight.id) {
                <div class="insight-item" [class]="getInsightClass(insight.type)">
                  <div class="d-flex align-items-start gap-2">
                    <span class="insight-badge badge" [class]="'source-' + insight.source">
                      {{ getSourceLabel(insight.source) }}
                    </span>
                    <span class="insight-text">{{ insight.text }}</span>
                  </div>
                  @if (insight.priority === 'high') {
                    <span class="badge bg-danger mt-1">High Priority</span>
                  }
                </div>
              }
            }
          </div>
        </div>

        <!-- Right column -->
        <div class="col-12 col-lg-5">
          <!-- Top Sellers -->
          <div class="cc-panel mb-3">
            <h5 class="panel-title">Top Sellers Today</h5>
            @if (topSellers().length === 0) {
              <p class="text-muted small">No sales data yet.</p>
            } @else {
              @for (item of topSellers(); track item.name; let i = $index) {
                <div class="top-seller-item d-flex justify-content-between align-items-center">
                  <div class="d-flex align-items-center gap-2">
                    <span class="rank-badge">{{ i + 1 }}</span>
                    <span>{{ item.name }}</span>
                  </div>
                  <div class="text-end">
                    <span class="fw-bold">{{ item.revenue | currency }}</span>
                    <small class="text-muted d-block">{{ item.quantity }} sold</small>
                  </div>
                </div>
              }
            }
          </div>

          <!-- Stock Urgency -->
          <div class="cc-panel">
            <h5 class="panel-title">Stock Watch</h5>
            @if (urgentPredictions().length === 0) {
              <p class="text-muted small">All stock levels healthy.</p>
            } @else {
              @for (pred of urgentPredictions(); track pred.inventoryItemId) {
                <div class="stock-item d-flex justify-content-between align-items-center" [class]="getPredictionUrgencyClass(pred.daysUntilEmpty)">
                  <div>
                    <span class="fw-bold">{{ pred.itemName }}</span>
                    <small class="text-muted d-block">{{ pred.currentStock }} {{ pred.unit }} left</small>
                  </div>
                  <div class="text-end">
                    <span class="days-badge">
                      @if (pred.daysUntilEmpty < 1) {
                        OUT
                      } @else {
                        {{ pred.daysUntilEmpty }}d
                      }
                    </span>
                  </div>
                </div>
              }
            }
          </div>
        </div>
      </div>
    }

    <!-- INSIGHTS TAB -->
    @if (activeTab() === 'insights') {
      <!-- Proactive AI Insights (GAP-R02 Phase 2) -->
      @if (isLoadingProactiveInsights()) {
        <div class="d-flex justify-content-center p-4 mb-3">
          <os-loading-spinner message="Analyzing data for insights..." />
        </div>
      } @else if (proactiveInsights().length > 0) {
        <div class="cc-panel mb-3">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="panel-title mb-0">
              <i class="bi bi-lightbulb me-1"></i> Proactive Insights
            </h5>
            <span class="badge bg-warning text-dark">{{ proactiveInsightCount() }} new</span>
          </div>
          @for (card of proactiveInsights(); track card.id) {
            <div class="proactive-card" [class]="getProactiveInsightClass(card)">
              <div class="d-flex align-items-start gap-2">
                <i class="bi proactive-icon" [class]="getProactiveInsightIcon(card)"></i>
                <div class="flex-grow-1">
                  <div class="d-flex justify-content-between align-items-start mb-1">
                    <strong class="proactive-title">{{ card.title }}</strong>
                    <div class="d-flex gap-1">
                      <button
                        class="btn-proactive-action"
                        title="Pin to Dashboard"
                        (click)="pinInsight(card)"
                      >
                        <i class="bi bi-pin-angle"></i>
                      </button>
                      <button
                        class="btn-proactive-action"
                        title="Dismiss"
                        (click)="dismissInsight(card.id)"
                      >
                        <i class="bi bi-x-lg"></i>
                      </button>
                    </div>
                  </div>
                  <p class="proactive-text mb-0">{{ getProactiveInsightText(card) }}</p>
                </div>
              </div>
            </div>
          }
        </div>
      }

      <div class="cc-panel">
        <h5 class="panel-title mb-3">All AI Insights</h5>
        @if (unifiedInsights().length === 0) {
          <div class="text-center p-4">
            <p class="text-muted">No AI insights available. Data is still being analyzed.</p>
          </div>
        } @else {
          @for (insight of unifiedInsights(); track insight.id) {
            <div class="insight-item-full" [class]="getInsightClass(insight.type)">
              <div class="d-flex align-items-start gap-2 mb-1">
                <span class="insight-badge badge" [class]="'source-' + insight.source">
                  {{ getSourceLabel(insight.source) }}
                </span>
                @if (insight.priority === 'high') {
                  <span class="badge bg-danger">High</span>
                } @else if (insight.priority === 'medium') {
                  <span class="badge bg-warning text-dark">Med</span>
                }
              </div>
              <p class="insight-text-full mb-0">{{ insight.text }}</p>
            </div>
          }
        }
      </div>
    }

    <!-- ALERTS TAB -->
    @if (activeTab() === 'alerts') {
      <div class="row g-3">
        <!-- Inventory Alerts -->
        <div class="col-12 col-lg-6">
          <div class="cc-panel">
            <h5 class="panel-title">Inventory Alerts</h5>
            @if (inventoryAlerts().length === 0) {
              <p class="text-muted small">No active inventory alerts.</p>
            } @else {
              @for (alert of inventoryAlerts(); track alert.itemId) {
                <div class="alert-item" [class]="getAlertSeverityClass(alert.severity)">
                  <div class="d-flex justify-content-between align-items-start mb-1">
                    <strong>{{ alert.itemName }}</strong>
                    <span class="badge" [class.bg-danger]="alert.severity === 'critical'" [class.bg-warning]="alert.severity === 'warning'" [class.text-dark]="alert.severity === 'warning'" [class.bg-info]="alert.severity === 'info'">
                      {{ alert.severity }}
                    </span>
                  </div>
                  <p class="small mb-1">{{ alert.message }}</p>
                  <p class="small text-muted mb-0">{{ alert.suggestedAction }}</p>
                </div>
              }
            }
          </div>
        </div>

        <!-- Stock Predictions -->
        <div class="col-12 col-lg-6">
          <div class="cc-panel">
            <h5 class="panel-title">Stock Predictions</h5>
            @if (inventoryPredictions().length === 0) {
              <p class="text-muted small">No stock predictions available.</p>
            } @else {
              @for (pred of inventoryPredictions(); track pred.inventoryItemId) {
                <div class="prediction-item" [class]="getPredictionUrgencyClass(pred.daysUntilEmpty)">
                  <div class="d-flex justify-content-between align-items-start mb-1">
                    <strong>{{ pred.itemName }}</strong>
                    <span class="days-badge">
                      @if (pred.daysUntilEmpty > 365) {
                        Plenty
                      } @else {
                        {{ pred.daysUntilEmpty }}d left
                      }
                    </span>
                  </div>
                  <div class="d-flex gap-3 small text-muted">
                    <span>Stock: {{ pred.currentStock }} {{ pred.unit }}</span>
                    <span>Usage: {{ pred.avgDailyUsage | number:'1.1-1' }}/day</span>
                  </div>
                  @if (pred.reorderRecommended) {
                    <div class="small mt-1">
                      <span class="badge bg-warning text-dark">Reorder {{ pred.reorderQuantity }} {{ pred.unit }}</span>
                    </div>
                  }
                </div>
              }
            }
          </div>
        </div>
      </div>
    }

    <!-- FORECAST TAB -->
    @if (activeTab() === 'forecast') {
      <div class="row g-3">
        <!-- Revenue Forecast -->
        <div class="col-12">
          <div class="cc-panel">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <div>
                <h5 class="panel-title mb-1">Revenue Forecast</h5>
                <p class="text-muted small mb-0">Predicted revenue with confidence bands</p>
              </div>
              <div class="d-flex gap-2">
                @for (d of [7, 14, 30]; track d) {
                  <button
                    type="button"
                    class="btn btn-sm"
                    [class.btn-primary]="forecastDays() === d"
                    [class.btn-outline-light]="forecastDays() !== d"
                    (click)="setForecastDays(d)"
                  >
                    {{ d }}d
                  </button>
                }
              </div>
            </div>

            @if (isLoadingForecast()) {
              <div class="d-flex justify-content-center p-4">
                <os-loading-spinner message="Generating revenue forecast..." />
              </div>
            } @else if (revenueForecast(); as forecast) {
              <!-- Forecast KPI summary -->
              <div class="forecast-kpis d-flex gap-3 mb-3">
                <div class="forecast-kpi">
                  <span class="kpi-label">Total Predicted</span>
                  <span class="kpi-value">{{ forecast.totalPredicted | currency }}</span>
                </div>
                <div class="forecast-kpi">
                  <span class="kpi-label">Confidence</span>
                  <span class="kpi-value" [class]="getConfidenceClass(forecast.confidence)">{{ (forecast.confidence * 100) | number:'1.0-0' }}%</span>
                </div>
                <div class="forecast-kpi">
                  <span class="kpi-label">Period</span>
                  <span class="kpi-value">{{ forecast.forecastDays }} days</span>
                </div>
              </div>

              <!-- Forecast Chart -->
              <div class="forecast-chart">
                <div class="forecast-bars">
                  @for (dp of forecast.dataPoints; track dp.date) {
                    <div class="forecast-bar-wrapper" [title]="dp.date + ': ' + (dp.predicted | currency) + ' (range: ' + (dp.lower | currency) + ' – ' + (dp.upper | currency) + ')'">
                      <div class="forecast-bar-band" [style.height.%]="getForecastBarHeight(dp.upper)">
                        <div class="forecast-bar-predicted" [style.height.%]="getForecastPredictedHeight(dp.predicted)"></div>
                      </div>
                      <span class="forecast-bar-label">{{ dp.date.slice(5) }}</span>
                    </div>
                  }
                </div>
                <div class="forecast-legend d-flex gap-3 mt-2">
                  <span class="legend-item"><span class="legend-color predicted"></span> Predicted</span>
                  <span class="legend-item"><span class="legend-color band"></span> Confidence Band</span>
                </div>
              </div>
            } @else {
              <div class="text-center text-muted p-4">
                No forecast data available. Sufficient sales history is needed.
              </div>
            }
          </div>
        </div>

        <!-- Demand Forecast -->
        <div class="col-12 col-lg-6">
          <div class="cc-panel">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <h5 class="panel-title mb-0">Demand Forecast</h5>
              <input
                type="date"
                class="form-control form-control-sm"
                style="width: auto"
                [value]="demandForecastDate()"
                (change)="setDemandDate($any($event.target).value)"
              />
            </div>

            @if (isLoadingDemand()) {
              <div class="d-flex justify-content-center p-4">
                <os-loading-spinner message="Forecasting demand..." />
              </div>
            } @else if (topDemandItems().length > 0) {
              <div class="demand-list">
                @for (item of topDemandItems(); track item.itemId; let i = $index) {
                  <div class="demand-item d-flex justify-content-between align-items-center">
                    <div class="d-flex align-items-center gap-2">
                      <span class="rank-badge">{{ i + 1 }}</span>
                      <div>
                        <span class="fw-semibold">{{ item.itemName }}</span>
                        <span class="small text-muted d-block">Avg: {{ item.dayOfWeekAvg | number:'1.0-0' }}/day</span>
                      </div>
                    </div>
                    <div class="text-end">
                      <span class="fw-bold">{{ item.predictedQuantity }}</span>
                      <span class="badge ms-1" [class]="getConfidenceClass(item.confidence)">
                        {{ getConfidenceLabel(item.confidence) }}
                      </span>
                    </div>
                  </div>
                }
              </div>
            } @else {
              <div class="text-center text-muted p-4">
                No demand forecast available for this date.
              </div>
            }
          </div>
        </div>

        <!-- Staffing Recommendation -->
        <div class="col-12 col-lg-6">
          <div class="cc-panel">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <h5 class="panel-title mb-0">Staffing Recommendation</h5>
              <input
                type="date"
                class="form-control form-control-sm"
                style="width: auto"
                [value]="staffingDate()"
                (change)="setStaffingDate($any($event.target).value)"
              />
            </div>

            @if (isLoadingStaffing()) {
              <div class="d-flex justify-content-center p-4">
                <os-loading-spinner message="Calculating staffing needs..." />
              </div>
            } @else if (staffingRec(); as rec) {
              <!-- Staffing KPIs -->
              <div class="d-flex gap-3 mb-3">
                <div class="forecast-kpi">
                  <span class="kpi-label">Total Hours</span>
                  <span class="kpi-value">{{ rec.totalRecommendedHours | number:'1.0-0' }}</span>
                </div>
                <div class="forecast-kpi">
                  <span class="kpi-label">Est. Labor Cost</span>
                  <span class="kpi-value">{{ rec.estimatedLaborCost | currency }}</span>
                </div>
                @if (peakStaffingHour(); as peak) {
                  <div class="forecast-kpi">
                    <span class="kpi-label">Peak Hour</span>
                    <span class="kpi-value">{{ formatHour(peak.hour) }}</span>
                  </div>
                }
              </div>

              <!-- Staffing Chart -->
              <div class="staffing-chart">
                <div class="staffing-bars">
                  @for (h of rec.hourlyBreakdown; track h.hour) {
                    <div class="staffing-bar-wrapper" [title]="formatHour(h.hour) + ': ' + h.recommendedStaff + ' staff, ' + h.predictedOrders + ' orders, ' + (h.predictedRevenue | currency)">
                      <div class="staffing-bar" [style.height.%]="getStaffBarHeight(h.recommendedStaff)">
                        <span class="staffing-bar-count">{{ h.recommendedStaff }}</span>
                      </div>
                      <span class="staffing-bar-label">{{ formatHour(h.hour) }}</span>
                    </div>
                  }
                </div>
              </div>
            } @else {
              <div class="text-center text-muted p-4">
                No staffing recommendation available for this date.
              </div>
            }
          </div>
        </div>
      </div>
    }
  }
</div>
} @else {
<div class="auth-required d-flex align-items-center justify-content-center p-5">
  <div class="text-center">
    <h3 class="text-warning mb-3">Authentication Required</h3>
    <p class="text-light">Please log in to access the AI Command Center.</p>
  </div>
</div>
}
