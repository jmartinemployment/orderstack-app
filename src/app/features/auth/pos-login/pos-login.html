<div class="pos-login" (click)="resetInactivityTimer()">

  <!-- Idle: Team Member Avatar Grid -->
  @if (state() === 'idle') {
    <div class="login-screen">
      <div class="login-header">
        <div class="brand">
          <i class="bi bi-stack"></i>
          <span>OrderStack</span>
        </div>
        <h1>Who's Working?</h1>
        <p>Tap your name to sign in</p>
      </div>

      @if (isLocked()) {
        <div class="lockout-banner">
          <i class="bi bi-lock-fill"></i>
          Locked — try again in {{ lockoutSecondsRemaining() }}s
        </div>
      }

      @if (error()) {
        <div class="error-msg">{{ error() }}</div>
      }

      <div class="avatar-grid">
        @for (member of activeTeamMembers(); track member.id) {
          <button class="avatar-card" [disabled]="isLocked()" (click)="selectMember(member)">
            <div class="avatar-circle" [style.background-color]="getAvatarColor(member.displayName)">
              @if (member.avatarUrl) {
                <img [src]="member.avatarUrl" [alt]="member.displayName" class="avatar-img">
              } @else {
                {{ getInitials(member.displayName) }}
              }
            </div>
            <span class="avatar-name">{{ member.displayName }}</span>
            @if (member.jobs.length > 0) {
              <span class="avatar-role">{{ member.jobs[0].jobTitle }}</span>
            }
          </button>
        } @empty {
          <div class="empty-grid">
            <i class="bi bi-person-plus"></i>
            <p>No team members configured.</p>
            <p class="text-muted">Add team members in Settings > Staff.</p>
          </div>
        }
      </div>
    </div>
  }

  <!-- Entering Passcode -->
  @if (state() === 'entering-passcode') {
    <div class="passcode-screen">
      <button class="btn-back" (click)="backToGrid()">
        <i class="bi bi-arrow-left"></i> Back
      </button>

      <div class="passcode-header">
        <div class="selected-avatar" [style.background-color]="getAvatarColor(selectedMember()!.displayName)">
          {{ getInitials(selectedMember()!.displayName) }}
        </div>
        <h2>{{ selectedMember()!.displayName }}</h2>
        <p>Enter your PIN</p>
      </div>

      <div class="passcode-dots">
        @for (filled of passcodeDots(); track $index) {
          <span class="dot" [class.filled]="filled"></span>
        }
      </div>

      @if (error()) {
        <div class="error-msg">{{ error() }}</div>
      }

      @if (isValidating()) {
        <div class="validating-msg">Verifying...</div>
      }

      <div class="keypad">
        @for (digit of ['1','2','3','4','5','6','7','8','9','','0','⌫']; track $index) {
          @if (digit === '') {
            <div class="keypad-spacer"></div>
          } @else if (digit === '⌫') {
            <button class="keypad-btn keypad-back" (click)="onBackspace()">
              <i class="bi bi-backspace"></i>
            </button>
          } @else {
            <button class="keypad-btn" (click)="onDigit(digit)" [disabled]="isValidating()">{{ digit }}</button>
          }
        }
      </div>

      <button class="btn-clear" (click)="onClear()">Clear</button>
    </div>
  }

  <!-- Clock-In Prompt -->
  @if (state() === 'clock-in-prompt') {
    <div class="clockin-screen">
      <div class="clockin-header">
        <div class="selected-avatar lg" [style.background-color]="getAvatarColor(selectedMember()!.displayName)">
          {{ getInitials(selectedMember()!.displayName) }}
        </div>
        <h2>{{ selectedMember()!.displayName }}</h2>
        <p>You're not clocked in yet</p>
      </div>

      <!-- Schedule enforcement warning -->
      @if (scheduleWarning()) {
        <div class="schedule-warning">
          <i class="bi bi-exclamation-triangle-fill"></i>
          <div class="schedule-warning-text">{{ scheduleWarning() }}</div>
        </div>
      }

      <!-- Manager override for schedule enforcement -->
      @if (showManagerOverride()) {
        <div class="manager-override">
          <label>Manager Override — Enter a manager PIN to proceed</label>
          <div class="override-input-row">
            <input
              type="password"
              class="override-pin-input"
              placeholder="Manager PIN"
              maxlength="6"
              [value]="managerOverridePin()"
              (input)="setManagerOverridePin($any($event.target).value)">
            <button
              class="btn-override-submit"
              [disabled]="managerOverridePin().length < 4 || isClockingIn()"
              (click)="submitManagerOverride()">
              @if (isClockingIn()) {
                <span class="spinner"></span>
              } @else {
                Override
              }
            </button>
          </div>
          <button class="btn-override-cancel" (click)="cancelManagerOverride()">Cancel</button>
        </div>
      }

      @if (needsJobSelection()) {
        <div class="job-selector">
          <label>Select your role for this shift:</label>
          <div class="job-options">
            @for (job of memberJobs(); track job.id) {
              <button
                class="job-btn"
                [class.selected]="selectedJobTitle() === job.jobTitle"
                (click)="selectJob(job.jobTitle)">
                <span class="job-title">{{ job.jobTitle }}</span>
                <span class="job-rate">${{ (job.hourlyRate / 100).toFixed(2) }}/hr</span>
              </button>
            }
          </div>
        </div>
      }

      @if (error()) {
        <div class="error-msg">{{ error() }}</div>
      }

      @if (!showManagerOverride()) {
        <div class="clockin-actions">
          <button
            class="btn-clockin"
            [disabled]="isClockingIn() || (needsJobSelection() && !selectedJobTitle())"
            (click)="clockInAndProceed()">
            @if (isClockingIn()) {
              <span class="spinner"></span> Clocking In...
            } @else {
              <i class="bi bi-clock-fill"></i> Clock In & Start
            }
          </button>
          <button class="btn-skip" (click)="skipClockIn()">
            Skip — Continue Without Clocking In
          </button>
        </div>
      }
    </div>
  }

  <!-- Authenticated: Expanded controls bar -->
  @if (state() === 'authenticated') {
    <div class="authenticated-bar">
      <!-- User info row -->
      <div class="auth-row">
        <div class="auth-info">
          <div class="auth-avatar" [style.background-color]="getAvatarColor(selectedMember()!.displayName)">
            {{ getInitials(selectedMember()!.displayName) }}
          </div>
          <div class="auth-details">
            <span class="auth-name">{{ selectedMember()!.displayName }}</span>
            @if (isClockedIn()) {
              <div class="auth-clock-info">
                <span class="auth-status clocked-in">
                  <i class="bi bi-circle-fill"></i> Clocked In
                </span>
                <span class="auth-duration">{{ clockedInDuration() }}</span>
                @if (activeTimecard()) {
                  <span class="auth-job">{{ activeTimecard()!.jobTitle }}</span>
                }
              </div>
            } @else {
              <span class="auth-status not-clocked">Not Clocked In</span>
            }
          </div>
        </div>
      </div>

      <!-- Active break banner -->
      @if (isOnBreak()) {
        <div class="break-banner">
          <i class="bi bi-cup-hot-fill"></i>
          <div class="break-info">
            <span class="break-name">{{ activeBreak()!.name }}</span>
            <span class="break-elapsed">{{ breakElapsedMinutes() }}m / {{ activeBreak()!.expectedMinutes }}m</span>
          </div>
          <button class="btn-end-break" [disabled]="isClockAction()" (click)="doEndBreak()">
            End Break
          </button>
        </div>
      }

      <!-- Error display -->
      @if (error()) {
        <div class="auth-error" (click)="dismissError()">
          <i class="bi bi-exclamation-circle"></i>
          {{ error() }}
          <i class="bi bi-x"></i>
        </div>
      }

      <!-- Action buttons -->
      <div class="auth-actions">
        @if (isClockedIn() && !isOnBreak()) {
          <!-- Break buttons -->
          @for (bt of activeBreakTypes(); track bt.id) {
            <button class="btn-action btn-break" [disabled]="isClockAction()" (click)="doStartBreak(bt.id)">
              <i class="bi bi-cup-hot"></i>
              {{ bt.name }}
              <span class="btn-meta">{{ bt.expectedMinutes }}m</span>
            </button>
          }

          <!-- Clock Out button -->
          <button class="btn-action btn-clock-out" [disabled]="isClockAction()" (click)="openClockOutModal()">
            <i class="bi bi-box-arrow-right"></i> Clock Out
          </button>

          <!-- Switch Job button (multi-job only) -->
          @if (canSwitchJob()) {
            <button class="btn-action btn-switch-job" [disabled]="isClockAction()" (click)="openJobSwitcher()">
              <i class="bi bi-arrow-repeat"></i> Switch Job
            </button>
          }
        }

        <!-- Switch User (always visible) -->
        <button class="btn-action btn-switch-user" (click)="switchUser()">
          <i class="bi bi-arrow-left-right"></i> Switch User
        </button>
      </div>
    </div>

    <!-- Clock-Out Modal -->
    @if (showClockOutModal()) {
      <div class="modal-overlay" (click)="cancelClockOut()">
        <div class="clock-out-modal" (click)="$event.stopPropagation()">
          <h3>Shift Summary</h3>

          @if (shiftSummary(); as s) {
            <!-- Visual shift timeline -->
            <div class="shift-timeline">
              <div class="timeline-row">
                <span class="timeline-dot in"></span>
                <span class="timeline-label">Clock In</span>
                <span class="timeline-value">{{ s.clockInTime }}</span>
              </div>
              @for (brk of s.breaks; track brk.id) {
                <div class="timeline-row break-row">
                  <span class="timeline-dot break"></span>
                  <span class="timeline-label">{{ brk.name }}</span>
                  <span class="timeline-value">
                    {{ brk.actualMinutes ?? 0 }}m
                    @if (brk.isPaid) {
                      <span class="badge-sm paid">Paid</span>
                    }
                  </span>
                </div>
              }
              <div class="timeline-row">
                <span class="timeline-dot out"></span>
                <span class="timeline-label">Clock Out</span>
                <span class="timeline-value">{{ s.clockOutTime }}</span>
              </div>
            </div>

            <!-- Hours breakdown -->
            <div class="clockout-summary">
              <div class="clockout-row">
                <span>Total Time</span>
                <span>{{ s.totalHours | number:'1.1-1' }}h</span>
              </div>
              @if (s.breakMinutes > 0) {
                <div class="clockout-row">
                  <span>Break Time</span>
                  <span>{{ s.breakMinutes }}m</span>
                </div>
                @if (s.paidBreakMinutes > 0) {
                  <div class="clockout-row sub">
                    <span>Paid Breaks</span>
                    <span>{{ s.paidBreakMinutes }}m</span>
                  </div>
                }
                @if (s.unpaidBreakMinutes > 0) {
                  <div class="clockout-row sub">
                    <span>Unpaid Breaks</span>
                    <span>{{ s.unpaidBreakMinutes }}m</span>
                  </div>
                }
              }
              <div class="clockout-row highlight">
                <span>Net Paid Hours</span>
                <span>{{ s.netPaidHours | number:'1.1-1' }}h</span>
              </div>
              @if (s.jobTitle) {
                <div class="clockout-row">
                  <span>Job</span>
                  <span>{{ s.jobTitle }}</span>
                </div>
              }
              @if (s.hourlyRate > 0) {
                <div class="clockout-row est-pay">
                  <span>Estimated Pay</span>
                  <span>{{ s.estimatedPay | currency }}</span>
                </div>
              }
            </div>

            @if (s.isTipEligible) {
              <div class="tip-declaration">
                <label>Declare Cash Tips ($)</label>
                <input
                  type="number"
                  class="tip-input"
                  min="0"
                  step="0.01"
                  placeholder="0.00"
                  [value]="declaredTips()"
                  (input)="setDeclaredTips($any($event.target).valueAsNumber)">
              </div>
            }
          }

          <div class="clockout-actions">
            <button class="btn-cancel" (click)="cancelClockOut()">Cancel</button>
            <button class="btn-confirm-clockout" [disabled]="isClockAction()" (click)="doClockOut()">
              @if (isClockAction()) { Clocking Out... } @else { Confirm Clock Out }
            </button>
          </div>
        </div>
      </div>
    }

    <!-- Job Switch Modal -->
    @if (showJobSwitcher()) {
      <div class="modal-overlay" (click)="cancelJobSwitch()">
        <div class="job-switch-modal" (click)="$event.stopPropagation()">
          <h3>Switch Job</h3>
          <p class="job-switch-desc">
            This will close your current timecard as
            <strong>{{ activeTimecard()!.jobTitle }}</strong>
            and start a new one.
          </p>

          <div class="job-switch-options">
            @for (job of memberJobs(); track job.id) {
              @if (job.jobTitle !== activeTimecard()!.jobTitle) {
                <button
                  class="job-switch-btn"
                  [class.selected]="switchJobTitle() === job.jobTitle"
                  (click)="selectSwitchJob(job.jobTitle)">
                  <div class="job-switch-info">
                    <span class="job-switch-title">{{ job.jobTitle }}</span>
                    <span class="job-switch-rate">${{ (job.hourlyRate / 100).toFixed(2) }}/hr</span>
                  </div>
                  @if (job.isTipEligible) {
                    <span class="job-switch-tip">Tip Eligible</span>
                  }
                </button>
              }
            }
          </div>

          <div class="job-switch-actions">
            <button class="btn-cancel" (click)="cancelJobSwitch()">Cancel</button>
            <button
              class="btn-confirm-switch"
              [disabled]="!switchJobTitle() || isClockAction()"
              (click)="confirmSwitchJob()">
              @if (isClockAction()) { Switching... } @else { Switch Job }
            </button>
          </div>
        </div>
      </div>
    }
  }
</div>
