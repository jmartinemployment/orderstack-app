<!-- ==================== BAR MODE TOGGLE ==================== -->
<div class="bar-mode-toggle">
  <button
    type="button"
    [class.active]="barMode() === 'create'"
    (click)="setBarMode('create')">
    <i class="bi bi-plus-circle"></i> Create Orders
  </button>
  <button
    type="button"
    [class.active]="barMode() === 'incoming'"
    (click)="setBarMode('incoming')">
    <i class="bi bi-inbox"></i> Incoming Orders
    @if (newOrders().length > 0) {
      <span class="badge">{{ newOrders().length }}</span>
    }
  </button>
</div>

<!-- ==================== CREATE ORDERS MODE ==================== -->
@if (barMode() === 'create') {
  <div class="bar-terminal">
    <!-- ==================== LEFT: Item Grid Area ==================== -->
    <main class="bar-main">

      <!-- Top Tabs -->
      <nav class="top-tabs">
        <button
          type="button"
          class="top-tab"
          [class.active]="activeTopTab() === 'keypad'"
          (click)="selectTopTab('keypad')">
          Keypad
        </button>
        <button
          type="button"
          class="top-tab"
          [class.active]="activeTopTab() === 'library'"
          (click)="selectTopTab('library')">
          Library
        </button>
        <button
          type="button"
          class="top-tab"
          [class.active]="activeTopTab() === 'favorites'"
          (click)="selectTopTab('favorites')">
          Favorites
        </button>
        <button
          type="button"
          class="top-tab"
          [class.active]="activeTopTab() === 'menu'"
          (click)="selectTopTab('menu')">
          Items
        </button>
        <button type="button" class="top-tab-more" aria-label="More options">
          <i class="bi bi-three-dots"></i>
        </button>
      </nav>

      <!-- Category pills (only visible on Menu tab) -->
      @if (activeTopTab() === 'menu') {
        <div class="category-pills">
          @for (cat of categories(); track cat.id) {
            <button
              type="button"
              class="category-pill"
              [class.active]="selectedCategoryId() === cat.id"
              (click)="selectCategory(cat.id)">
              {{ cat.name }}
            </button>
          }
        </div>
      }

      <!-- Keypad View -->
      @if (activeTopTab() === 'keypad') {
        <div class="keypad-view">
          <div class="keypad-display">
            <span class="keypad-dollar">$</span>
            <span class="keypad-amount">{{ keypadValue() || '0' }}</span>
          </div>
          <div class="keypad-grid">
            @for (key of ['1','2','3','4','5','6','7','8','9','00','0','.']; track key) {
              <button
                type="button"
                class="keypad-key"
                (click)="onKeypadPress(key)">
                {{ key }}
              </button>
            }
          </div>
          <div class="keypad-actions">
            <button type="button" class="keypad-clear" (click)="onKeypadPress('clear')">Clear</button>
            <button type="button" class="keypad-backspace" (click)="onKeypadPress('backspace')">
              <i class="bi bi-backspace"></i>
            </button>
          </div>
        </div>
      }

      <!-- Item Grid -->
      @if (activeTopTab() !== 'keypad') {
        <div class="item-grid-container">
          @if (isLoading()) {
            <div class="grid-loading">
              <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading items...</span>
              </div>
            </div>
          } @else {
            <div class="item-grid">
              @for (item of gridItems(); track item.id) {
                <button type="button" class="item-tile" (click)="checkout.addItem(item)">
                  @if (getItemImage(item); as imgUrl) {
                    <div class="item-image">
                      <img [src]="imgUrl" [alt]="item.name" loading="lazy" (error)="onImageError($event)" />
                      <i class="bi bi-bag item-image-fallback"></i>
                    </div>
                  } @else {
                    <div class="item-image item-image-placeholder">
                      <i class="bi bi-bag"></i>
                    </div>
                  }
                  <span class="item-name">{{ item.name }}</span>
                  @if (item.soldByWeight) {
                    <span class="item-weight-badge">
                      <i class="bi bi-speedometer2"></i> by weight
                    </span>
                  }
                </button>
              }

              <!-- Empty placeholder tiles to fill the row -->
              @for (i of [1,2,3,4,5]; track i) {
                @if (gridItems().length % 5 !== 0 && i <= 5 - (gridItems().length % 5)) {
                  <div class="item-tile item-tile-empty"></div>
                }
              }
            </div>

            <!-- Action tiles row -->
            <div class="action-tiles">
              <button type="button" class="action-tile">
                <div class="action-icon">
                  <i class="bi bi-percent"></i>
                </div>
                <span class="action-label">Discounts</span>
              </button>
              <button type="button" class="action-tile">
                <div class="action-icon">
                  <i class="bi bi-star-fill"></i>
                </div>
                <span class="action-label">Rewards</span>
              </button>
              <button type="button" class="action-tile">
                <div class="action-icon">
                  <i class="bi bi-gift-fill"></i>
                </div>
                <span class="action-label">Gift cards</span>
              </button>
              <div class="action-tile action-tile-empty"></div>
              <div class="action-tile action-tile-empty"></div>
            </div>
          }
        </div>
      }

      <os-bottom-navigation />
    </main>

    <!-- ==================== RIGHT: Current Sale Panel ==================== -->
    <aside class="sale-panel">
      <div class="sale-header">
        <h2>Current sale{{ checkout.cartCount() > 0 ? ' (' + checkout.cartCount() + ')' : '' }}</h2>
        <button type="button" class="sale-more-btn" aria-label="Sale options">
          <i class="bi bi-three-dots"></i>
        </button>
      </div>

      <!-- Customer row (placeholder) -->
      <button type="button" class="customer-row">
        <div class="customer-avatar">
          <i class="bi bi-person-fill"></i>
        </div>
        <span class="customer-name">Add customer</span>
        <i class="bi bi-chevron-right customer-chevron"></i>
      </button>

      <!-- Line items -->
      <div class="sale-items">
        @if (checkout.cartItems().length === 0) {
          <div class="sale-empty">
            <p>No items yet</p>
          </div>
        } @else {
          @for (item of checkout.cartItems(); track item.id) {
            <div class="sale-line-item">
              <div class="line-item-info">
                <button type="button" class="line-item-name" (click)="checkout.removeItem(item.id)">
                  @if (item.weightUnit) {
                    <span class="line-item-qty">{{ item.quantity }} {{ weightUnitLabels[item.weightUnit] }}</span>
                  } @else if (item.quantity > 1) {
                    <span class="line-item-qty">{{ item.quantity }}x</span>
                  }
                  {{ item.menuItem.name }}
                </button>
                @if (item.weightUnit) {
                  <span class="line-item-modifier">@ {{ item.unitPrice | currency:'USD':'symbol':'1.2-2' }}/{{ weightUnitLabels[item.weightUnit] }}</span>
                }
                @if (item.modifierSummary) {
                  <span class="line-item-modifier">{{ item.modifierSummary }}</span>
                }
              </div>
              <span class="line-item-price">{{ item.totalPrice | currency:'USD':'symbol':'1.2-2' }}</span>
            </div>
          }
        }
      </div>

      <!-- Totals + actions -->
      <div class="sale-footer">
        @if (checkout.cartItems().length > 0) {
          <div class="sale-totals">
            <div class="total-row">
              <span>Tax</span>
              <span>{{ checkout.tax() | currency:'USD':'symbol':'1.2-2' }}</span>
            </div>
            <div class="total-divider"></div>
            <button type="button" class="add-discount-btn">Add discount</button>
          </div>
        }

        <button
          type="button"
          class="charge-btn"
          [disabled]="checkout.cartItems().length === 0"
          (click)="checkout.startCheckout('charge', 'bar')">
          @if (checkout.cartItems().length > 0) {
            Charge {{ checkout.total() | currency:'USD':'symbol':'1.2-2' }}
          } @else {
            Charge
          }
        </button>
      </div>
    </aside>
  </div>

  <!-- ==================== WEIGHT SCALE OVERLAY ==================== -->
  @if (checkout.showWeightScale()) {
    <div class="checkout-overlay">
      <div class="checkout-modal">
        <os-weight-scale
          [itemName]="checkout.weightScaleItem()!.name"
          [unitPrice]="checkout.weightScaleUnitPrice()"
          [weightUnit]="checkout.weightScaleUnit()"
          (weightConfirmed)="checkout.onWeightConfirmed($event)"
          (cancelled)="checkout.closeWeightScale()" />
      </div>
    </div>
  }

  <!-- ==================== CHECKOUT OVERLAY ==================== -->
  <os-checkout [mode]="'charge'" [orderSource]="'bar'" />
}

<!-- ==================== INCOMING ORDERS MODE ==================== -->
@if (barMode() === 'incoming') {
  <div class="bar-incoming">
    <div class="bar-incoming-header">
      <os-connection-status />
    </div>

    <div class="bar-order-columns">
      <!-- NEW Orders Column -->
      <div class="bar-order-column">
        <div class="column-header new">
          <h2>NEW</h2>
          <span class="column-count">{{ newOrders().length }}</span>
        </div>
        <div class="column-body">
          @for (order of newOrders(); track order.guid) {
            <os-order-card
              [order]="order"
              [stationFilterId]="barStationId()"
              [menuItemToStationMap]="menuItemToStationMap()"
              (statusChange)="onStatusChange($event)"
            />
          } @empty {
            <div class="empty-column">No new drink orders</div>
          }
        </div>
      </div>

      <!-- PREPARING Orders Column -->
      <div class="bar-order-column">
        <div class="column-header cooking">
          <h2>PREPARING</h2>
          <span class="column-count">{{ cookingOrders().length }}</span>
        </div>
        <div class="column-body">
          @for (order of cookingOrders(); track order.guid) {
            <os-order-card
              [order]="order"
              [stationFilterId]="barStationId()"
              [menuItemToStationMap]="menuItemToStationMap()"
              (statusChange)="onStatusChange($event)"
            />
          } @empty {
            <div class="empty-column">No drinks preparing</div>
          }
        </div>
      </div>

      <!-- READY Orders Column -->
      <div class="bar-order-column">
        <div class="column-header ready">
          <h2>READY</h2>
          <span class="column-count">{{ readyOrders().length }}</span>
        </div>
        <div class="column-body">
          @for (order of readyOrders(); track order.guid) {
            <os-order-card
              [order]="order"
              [stationFilterId]="barStationId()"
              [menuItemToStationMap]="menuItemToStationMap()"
              [showCollectPayment]="showCollectPayment()"
              (statusChange)="onStatusChange($event)"
              (collectPayment)="onCollectPayment($event)"
            />
          } @empty {
            <div class="empty-column">No drinks ready</div>
          }
        </div>
      </div>
    </div>
  </div>

  <!-- Payment Modal -->
  @if (showPaymentModal() && paymentOrder()) {
    <div class="bar-payment-overlay" (click)="closePaymentModal()">
      <div class="bar-payment-modal" (click)="$event.stopPropagation()">
        <div class="bar-payment-modal-header">
          <div>
            <h5>Collect Payment</h5>
            <span class="text-muted small">Order #{{ paymentOrder()!.orderNumber }}</span>
          </div>
          <span class="bar-payment-modal-amount">{{ paymentAmount() | currency }}</span>
          <button type="button" class="btn-modal-close" aria-label="Close payment modal" (click)="closePaymentModal()">
            <i class="bi bi-x-lg"></i>
          </button>
        </div>
        @if (paymentError()) {
          <div class="bar-payment-modal-error">{{ paymentError() }}</div>
        }
        <div class="bar-payment-modal-body">
          <os-payment-terminal
            [amount]="paymentAmount()"
            [orderId]="paymentOrder()!.guid"
            [showOnScreen]="true"
            [showCardReader]="true"
            (paymentComplete)="onBarPaymentComplete()"
            (paymentFailed)="onBarPaymentFailed($event)"
          />
        </div>
      </div>
    </div>
  }
}
