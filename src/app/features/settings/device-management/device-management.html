<div class="device-management">
  @if (error()) {
    <div class="alert alert-danger d-flex align-items-center justify-content-between mb-3">
      <span>{{ error() }}</span>
      <button class="btn btn-sm btn-outline-light" (click)="clearError()">Dismiss</button>
    </div>
  }

  @if (successMessage()) {
    <div class="alert alert-success mb-3">{{ successMessage() }}</div>
  }

  <div class="d-flex justify-content-between align-items-center mb-3">
    <h5 class="mb-0">Registered Devices</h5>
    <button class="btn btn-primary btn-sm" (click)="openGenerateForm()">
      <i class="bi bi-plus-lg me-1"></i> Generate Device Code
    </button>
  </div>

  <!-- KPI Strip -->
  <div class="kpi-strip mb-3">
    <div class="kpi-card">
      <div class="kpi-value">{{ activeDevices().length }}</div>
      <div class="kpi-label">Active</div>
    </div>
    <div class="kpi-card">
      <div class="kpi-value">{{ pendingDevices().length }}</div>
      <div class="kpi-label">Pending</div>
    </div>
    <div class="kpi-card">
      <div class="kpi-value">{{ revokedDevices().length }}</div>
      <div class="kpi-label">Revoked</div>
    </div>
  </div>

  @if (isLoading()) {
    <div class="text-center py-4">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
    </div>
  }

  @if (devices().length > 0) {
    <div class="table-responsive">
      <table class="table table-dark table-hover align-middle">
        <thead>
          <tr>
            <th>Device Name</th>
            <th>Code</th>
            <th>Status</th>
            <th>Location</th>
            <th>Paired</th>
            <th>Expires</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          @for (device of devices(); track device.id) {
            <tr [class.opacity-50]="device.status === 'revoked'">
              <td>
                <div class="d-flex align-items-center gap-2">
                  <span class="status-dot" [class]="getStatusClass(device.status)"></span>
                  {{ device.deviceName }}
                </div>
              </td>
              <td>
                <code class="device-code">{{ device.deviceCode }}</code>
                @if (isExpired(device)) {
                  <span class="badge bg-danger ms-1">Expired</span>
                }
              </td>
              <td>
                <span class="badge" [class]="getStatusClass(device.status)">{{ device.status }}</span>
              </td>
              <td class="text-muted small">{{ device.locationName ?? 'All' }}</td>
              <td class="text-muted small">
                @if (device.pairedAt) {
                  {{ device.pairedAt | date:'short' }}
                } @else {
                  â€”
                }
              </td>
              <td class="text-muted small">{{ device.expiresAt | date:'short' }}</td>
              <td>
                @if (device.status !== 'revoked') {
                  <button class="btn btn-sm btn-outline-danger" (click)="confirmRevokeDevice(device.id)" title="Revoke">
                    <i class="bi bi-x-circle"></i>
                  </button>
                }
              </td>
            </tr>
          }
        </tbody>
      </table>
    </div>
  } @else {
    @if (!isLoading()) {
      <div class="empty-state text-center py-4">
        <i class="bi bi-laptop display-4 text-muted mb-2"></i>
        <p class="text-muted">No devices registered. Generate a code to pair a POS device.</p>
      </div>
    }
  }

  <!-- Generate Code Modal -->
  @if (showGenerateForm()) {
    <div class="modal-backdrop" (click)="closeGenerateForm()"></div>
    <div class="modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Generate Device Code</h5>
          <button class="btn-close btn-close-white" (click)="closeGenerateForm()"></button>
        </div>
        <div class="modal-body">
          @if (!generatedDevice()) {
            <div class="mb-3">
              <label class="form-label">Device Name *</label>
              <input type="text" class="form-control" [value]="deviceName()" (input)="setDeviceName($any($event.target).value)" placeholder="e.g., Bar POS, Host Stand">
            </div>
            <p class="text-muted small">The code will expire in 48 hours. Enter it on the device to pair.</p>
          } @else {
            <div class="text-center py-3">
              <div class="generated-code">{{ generatedDevice()!.deviceCode }}</div>
              <p class="text-muted mt-2">Enter this 6-digit code on the device within 48 hours.</p>
              <p class="small text-muted">Device: {{ generatedDevice()!.deviceName }}</p>
            </div>
          }
        </div>
        <div class="modal-footer">
          <button class="btn btn-outline-light" (click)="closeGenerateForm()">
            {{ generatedDevice() ? 'Done' : 'Cancel' }}
          </button>
          @if (!generatedDevice()) {
            <button class="btn btn-primary" (click)="generateCode()" [disabled]="isSaving() || !deviceName()">
              @if (isSaving()) {
                <span class="spinner-border spinner-border-sm me-1"></span>
              }
              Generate
            </button>
          }
        </div>
      </div>
    </div>
  }

  <!-- Revoke Confirmation Modal -->
  @if (confirmRevoke()) {
    <div class="modal-backdrop" (click)="cancelRevoke()"></div>
    <div class="modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Revoke Device</h5>
          <button class="btn-close btn-close-white" (click)="cancelRevoke()"></button>
        </div>
        <div class="modal-body">
          <p>Are you sure you want to revoke this device? It will need to be re-paired with a new code.</p>
        </div>
        <div class="modal-footer">
          <button class="btn btn-outline-light" (click)="cancelRevoke()">Cancel</button>
          <button class="btn btn-danger" (click)="revokeDevice(confirmRevoke()!)" [disabled]="isSaving()">
            @if (isSaving()) {
              <span class="spinner-border spinner-border-sm me-1"></span>
            }
            Revoke
          </button>
        </div>
      </div>
    </div>
  }
</div>
