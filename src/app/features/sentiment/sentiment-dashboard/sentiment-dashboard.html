@if (isAuthenticated()) {
<div class="sentiment-dashboard">
  <!-- Header -->
  <div class="dashboard-header">
    <div class="d-flex justify-content-between align-items-center">
      <h2 class="header-title">
        <span class="header-icon">&#128200;</span>
        Sentiment Analysis
      </h2>
      <button type="button" class="btn btn-sm btn-outline-light" (click)="loadAndAnalyze()" [disabled]="isLoading()">
        @if (isLoading()) { Analyzing... } @else { Refresh }
      </button>
    </div>

    <div class="kpi-strip">
      <div class="kpi-card">
        <div class="kpi-value">{{ summary().totalAnalyzed }}</div>
        <div class="kpi-label">Analyzed</div>
      </div>
      <div class="kpi-card kpi-positive">
        <div class="kpi-value">{{ positiveRate() | percent:'1.0-0' }}</div>
        <div class="kpi-label">Positive</div>
      </div>
      <div class="kpi-card kpi-negative">
        <div class="kpi-value">{{ negativeRate() | percent:'1.0-0' }}</div>
        <div class="kpi-label">Negative</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-value score-display" [class.positive]="sentimentScore() > 0" [class.negative]="sentimentScore() < 0">
          {{ sentimentScore() > 0 ? '+' : '' }}{{ sentimentScore() }}
        </div>
        <div class="kpi-label">Avg Score</div>
      </div>
    </div>
  </div>

  <!-- Tabs -->
  <div class="dashboard-tabs">
    <button type="button" class="tab-btn" [class.active]="activeTab() === 'overview'" (click)="setTab('overview')">Overview</button>
    <button type="button" class="tab-btn" [class.active]="activeTab() === 'entries'" (click)="setTab('entries')">
      Entries
      @if (summary().negative > 0) {
        <span class="tab-badge-danger">{{ summary().negative }}</span>
      }
    </button>
    <button type="button" class="tab-btn" [class.active]="activeTab() === 'trends'" (click)="setTab('trends')">Flags</button>
  </div>

  @if (error()) {
    <div class="alert alert-danger mx-3 mt-2">{{ error() }}</div>
  }

  @if (isLoading()) {
    <div class="text-center p-5">
      <div class="spinner-border text-light"></div>
      <p class="text-muted mt-2">Analyzing order instructions...</p>
    </div>
  } @else {
    <!-- OVERVIEW TAB -->
    @if (activeTab() === 'overview') {
      <div class="tab-content px-3 pt-3">
        <!-- Sentiment Breakdown -->
        <h6 class="section-title">Sentiment Breakdown</h6>
        <div class="sentiment-bars mb-3">
          <div class="bar-row">
            <span class="bar-label sentiment-positive">Positive</span>
            <div class="bar-track">
              <div class="bar-fill bar-positive" [style.width.%]="positiveRate() * 100"></div>
            </div>
            <span class="bar-count">{{ summary().positive }}</span>
          </div>
          <div class="bar-row">
            <span class="bar-label sentiment-neutral">Neutral</span>
            <div class="bar-track">
              <div class="bar-fill bar-neutral" [style.width.%]="summary().totalAnalyzed > 0 ? (summary().neutral / summary().totalAnalyzed * 100) : 0"></div>
            </div>
            <span class="bar-count">{{ summary().neutral }}</span>
          </div>
          <div class="bar-row">
            <span class="bar-label sentiment-negative">Negative</span>
            <div class="bar-track">
              <div class="bar-fill bar-negative" [style.width.%]="negativeRate() * 100"></div>
            </div>
            <span class="bar-count">{{ summary().negative }}</span>
          </div>
        </div>

        <!-- Top Keywords -->
        @if (summary().topKeywords.length > 0) {
          <h6 class="section-title">Top Keywords</h6>
          <div class="keyword-cloud mb-3">
            @for (kw of summary().topKeywords; track kw.word) {
              <span class="keyword-tag">{{ kw.word }} <span class="keyword-count">{{ kw.count }}</span></span>
            }
          </div>
        }

        <!-- Flag Summary -->
        <h6 class="section-title">Flag Detection</h6>
        <div class="flag-grid">
          @for (flag of getAllFlags(); track flag) {
            <div class="flag-card" [class]="getFlagClass(flag)">
              <div class="flag-count">{{ summary().flagCounts[flag] }}</div>
              <div class="flag-label">{{ getFlagLabel(flag) }}</div>
            </div>
          }
        </div>
      </div>
    }

    <!-- ENTRIES TAB -->
    @if (activeTab() === 'entries') {
      <div class="tab-content">
        <div class="filter-bar px-3 pt-3">
          <button type="button" class="filter-pill" [class.active]="sentimentFilter() === 'all'" (click)="setSentimentFilter('all')">All</button>
          <button type="button" class="filter-pill filter-positive" [class.active]="sentimentFilter() === 'positive'" (click)="setSentimentFilter('positive')">Positive</button>
          <button type="button" class="filter-pill filter-neutral" [class.active]="sentimentFilter() === 'neutral'" (click)="setSentimentFilter('neutral')">Neutral</button>
          <button type="button" class="filter-pill filter-negative" [class.active]="sentimentFilter() === 'negative'" (click)="setSentimentFilter('negative')">Negative</button>
        </div>

        <div class="entries-list px-3 pt-2">
          @for (entry of filteredEntries(); track entry.orderId) {
            <div class="entry-card" [class]="getSentimentClass(entry.sentiment)">
              <div class="entry-header">
                <div class="d-flex align-items-center gap-2">
                  <span class="sentiment-indicator" [class]="getSentimentClass(entry.sentiment)">
                    {{ getSentimentIcon(entry.sentiment) }}
                  </span>
                  <span class="entry-order">Order #{{ entry.orderNumber }}</span>
                </div>
                <span class="entry-score" [class]="getSentimentClass(entry.sentiment)">
                  {{ entry.score > 0 ? '+' : '' }}{{ entry.score }}
                </span>
              </div>
              <div class="entry-text">"{{ entry.instructions }}"</div>
              @if (entry.keywords.length > 0) {
                <div class="entry-keywords">
                  @for (kw of entry.keywords; track kw) {
                    <span class="mini-keyword">{{ kw }}</span>
                  }
                </div>
              }
              @if (entry.flags.length > 0) {
                <div class="entry-flags">
                  @for (flag of entry.flags; track flag) {
                    <span class="flag-badge" [class]="getFlagClass(flag)">{{ getFlagLabel(flag) }}</span>
                  }
                </div>
              }
            </div>
          } @empty {
            <div class="empty-state">
              <p>No entries match the current filter</p>
            </div>
          }
        </div>
      </div>
    }

    <!-- FLAGS TAB -->
    @if (activeTab() === 'trends') {
      <div class="tab-content px-3 pt-3">
        <p class="text-muted small mb-3">Detailed flag analysis from order instructions.</p>

        @for (flag of getAllFlags(); track flag) {
          @if (summary().flagCounts[flag] > 0) {
            <div class="flag-detail mb-3">
              <div class="flag-detail-header">
                <span class="flag-badge" [class]="getFlagClass(flag)">{{ getFlagLabel(flag) }}</span>
                <span class="flag-detail-count">{{ summary().flagCounts[flag] }} occurrence{{ summary().flagCounts[flag] === 1 ? '' : 's' }}</span>
              </div>
              <div class="flag-entries">
                @for (entry of getEntriesByFlag(flag); track entry.orderId) {
                  <div class="flag-entry-item">
                    <span class="flag-entry-order">#{{ entry.orderNumber }}</span>
                    <span class="flag-entry-text">"{{ entry.instructions }}"</span>
                  </div>
                }
              </div>
            </div>
          }
        }

        @if (summary().totalAnalyzed === 0) {
          <div class="empty-state">
            <p>No data to display. Orders with special instructions will be analyzed automatically.</p>
          </div>
        }
      </div>
    }
  }
</div>
} @else {
<div class="auth-required d-flex align-items-center justify-content-center p-5">
  <div class="text-center">
    <h3 class="text-warning mb-3">Authentication Required</h3>
    <p class="text-light">Please log in to view sentiment analysis.</p>
  </div>
</div>
}
