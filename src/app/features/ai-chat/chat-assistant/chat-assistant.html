@if (isAuthenticated()) {
<div class="chat-assistant">
  <!-- Header -->
  <div class="chat-header d-flex justify-content-between align-items-center">
    <div>
      <h2 class="h5 mb-0">AI Assistant</h2>
      <small class="text-muted">Ask anything about your restaurant</small>
    </div>
    @if (hasMessages()) {
      <button type="button" class="btn btn-sm btn-outline-secondary" (click)="clearChat()">
        Clear Chat
      </button>
    }
  </div>

  <!-- Messages Area -->
  <div class="chat-messages" #messagesContainer>
    @if (!hasMessages()) {
      <!-- Welcome Screen -->
      <div class="welcome-screen">
        <div class="welcome-icon">AI</div>
        <h4>Restaurant IQ Assistant</h4>
        <p class="text-muted">I can help you analyze sales, check inventory, review menu performance, and more.</p>

        <div class="suggested-queries">
          <p class="small text-muted mb-2">Try asking:</p>
          @for (query of suggestedQueries; track query) {
            <button
              type="button"
              class="btn btn-sm btn-outline-info suggestion-btn"
              [disabled]="isTyping() || isQueryingAi()"
              (click)="sendSuggested(query)"
            >
              {{ query }}
            </button>
          }
        </div>
      </div>
    } @else {
      @for (msg of allMessages(); track msg.id) {
        <div class="chat-message" [class.message-user]="msg.role === 'user'" [class.message-assistant]="msg.role === 'assistant'">
          <div class="message-avatar">
            @if (msg.role === 'user') {
              You
            } @else {
              AI
            }
          </div>
          <div class="message-body">
            @if (msg.role === 'user') {
              <div class="message-content">
                <div class="message-text">{{ msg.content }}</div>
                <span class="message-time">{{ formatTime(msg.timestamp) }}</span>
              </div>
            } @else {
              <!-- AI response with widget cards -->
              @if (msg.cards && msg.cards.length > 0) {
                <div class="widget-cards">
                  @for (card of msg.cards; track card.id) {
                    <div class="widget-card" [class.widget-kpi]="card.responseType === 'kpi'" [class.widget-chart]="card.responseType === 'chart'" [class.widget-table]="card.responseType === 'table'">
                      <div class="widget-card-header">
                        <span class="widget-title">{{ card.title }}</span>
                        <button
                          class="btn-pin"
                          [class.pinned]="isCardPinned(card.id)"
                          [disabled]="isCardPinned(card.id)"
                          (click)="pinCard(card)"
                          title="Pin to Dashboard"
                        >
                          <i class="bi" [class.bi-pin-fill]="isCardPinned(card.id)" [class.bi-pin-angle]="!isCardPinned(card.id)"></i>
                        </button>
                      </div>

                      <!-- KPI Card -->
                      @if (card.responseType === 'kpi') {
                        <div class="widget-kpi-body">
                          <span class="kpi-value">
                            @if (card.unit === '$') {
                              {{ card.value | currency }}
                            } @else if (card.unit === '%') {
                              {{ card.value | number:'1.1-1' }}%
                            } @else {
                              {{ card.value }}
                            }
                            @if (card.unit && card.unit !== '$' && card.unit !== '%') {
                              <small>{{ card.unit }}</small>
                            }
                          </span>
                          @if (card.trend) {
                            <span class="kpi-trend" [class.up]="card.trend === 'up'" [class.down]="card.trend === 'down'">
                              <i class="bi" [class.bi-arrow-up]="card.trend === 'up'" [class.bi-arrow-down]="card.trend === 'down'" [class.bi-dash]="card.trend === 'flat'"></i>
                              {{ card.trend }}
                            </span>
                          }
                        </div>
                      }

                      <!-- Chart Card (CSS bar chart) -->
                      @if (card.responseType === 'chart') {
                        <div class="widget-chart-body">
                          @for (label of getCardChartLabels(card); track label; let i = $index) {
                            <div class="chart-bar-row">
                              <span class="chart-label">{{ label }}</span>
                              <div class="chart-bar-track">
                                <div class="chart-bar-fill" [style.width.%]="(getCardChartValues(card)[i] / getCardChartMax(card)) * 100"></div>
                              </div>
                              <span class="chart-value">{{ getCardChartValues(card)[i] | number:'1.0-0' }}</span>
                            </div>
                          }
                        </div>
                      }

                      <!-- Table Card -->
                      @if (card.responseType === 'table' && card.columns) {
                        <div class="widget-table-body">
                          <table class="mini-table">
                            <thead>
                              <tr>
                                @for (col of card.columns; track col) {
                                  <th>{{ col }}</th>
                                }
                              </tr>
                            </thead>
                            <tbody>
                              @for (row of getCardTableRows(card); track $index) {
                                <tr>
                                  @for (col of card.columns; track col) {
                                    <td>{{ row[col] }}</td>
                                  }
                                </tr>
                              }
                            </tbody>
                          </table>
                        </div>
                      }

                      <!-- Text Card -->
                      @if (card.responseType === 'text') {
                        <div class="widget-text-body">
                          {{ getCardText(card) }}
                        </div>
                      }
                    </div>
                  }
                </div>

                <!-- Suggested follow-ups -->
                @if (msg.suggestedFollowUps && msg.suggestedFollowUps.length > 0) {
                  <div class="follow-ups">
                    @for (followUp of msg.suggestedFollowUps; track followUp) {
                      <button
                        class="btn btn-sm btn-outline-info suggestion-btn"
                        [disabled]="isQueryingAi()"
                        (click)="sendSuggested(followUp)"
                      >
                        {{ followUp }}
                      </button>
                    }
                  </div>
                }
              } @else {
                <div class="message-content">
                  <div class="message-text">{{ msg.content }}</div>
                  @if (msg.sources && msg.sources.length > 0) {
                    <div class="message-sources small mt-1">
                      <span class="text-muted">Sources: </span>
                      @for (source of msg.sources; track source) {
                        <span class="badge bg-secondary me-1">{{ source }}</span>
                      }
                    </div>
                  }
                  <span class="message-time">{{ formatTime(msg.timestamp) }}</span>
                </div>
              }
            }
          </div>
        </div>
      }

      @if (isTyping() || isQueryingAi()) {
        <div class="chat-message message-assistant">
          <div class="message-avatar">AI</div>
          <div class="message-body">
            <div class="message-content">
              <div class="typing-indicator">
                <span></span>
                <span></span>
                <span></span>
              </div>
            </div>
          </div>
        </div>
      }
    }
  </div>

  <!-- Input Area -->
  <div class="chat-input">
    <div class="input-wrapper">
      <input
        type="text"
        class="form-control"
        placeholder="Ask about sales, inventory, menu performance..."
        [value]="inputValue()"
        [disabled]="isTyping() || isQueryingAi()"
        (input)="onInput($event)"
        (keydown)="onKeydown($event)"
      />
      <button
        type="button"
        class="btn btn-primary send-btn"
        [disabled]="!inputValue().trim() || isTyping() || isQueryingAi()"
        (click)="send()"
      >
        @if (isTyping() || isQueryingAi()) {
          <span class="spinner-border spinner-border-sm"></span>
        } @else {
          Send
        }
      </button>
    </div>
  </div>
</div>
} @else {
<div class="auth-required d-flex align-items-center justify-content-center p-5">
  <div class="text-center">
    <h3 class="mb-3" style="color: var(--os-warning)">Authentication Required</h3>
    <p style="color: var(--os-text-secondary)">Please log in to use the AI Assistant.</p>
  </div>
</div>
}
